<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OANDA Trading System</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e1a;
    --bg-card: #111827;
    --bg-card-hover: #1a2237;
    --bg-input: #0d1320;
    --border: #1e293b;
    --border-light: #2a3a52;
    --text-primary: #e2e8f0;
    --text-secondary: #8896ab;
    --text-muted: #5a6a80;
    --green: #10b981;
    --green-dim: #065f46;
    --red: #ef4444;
    --red-dim: #7f1d1d;
    --yellow: #f59e0b;
    --yellow-dim: #78350f;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --cyan: #06b6d4;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
    padding-bottom: 70px;
  }
  a { color: var(--blue); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* ── NAV ── */
  .nav {
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center;
    padding: 0 32px; gap: 0;
  }
  .nav-brand {
    font-weight: 700; font-size: 1rem; color: var(--blue);
    margin-right: 24px; white-space: nowrap; padding: 12px 0;
    font-family: 'JetBrains Mono', monospace;
  }
  .nav-tab {
    padding: 12px 20px; color: var(--text-muted); cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s; font-size: 0.85rem; font-weight: 500; user-select: none;
  }
  .nav-tab:hover { color: var(--text-primary); }
  .nav-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
  .nav-right {
    margin-left: auto; display: flex; align-items: center; gap: 12px;
    font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;
  }

  /* ── VIEWS ── */
  .view { display: none; }
  .view.active { display: block; }

  /* ══════════════════════════════════════
     DASHBOARD VIEW (NEW)
     ══════════════════════════════════════ */
  .dash-header {
    background: linear-gradient(180deg, rgba(17,24,39,0.95) 0%, var(--bg-primary) 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .dash-header-left { display: flex; align-items: center; gap: 16px; }
  .dash-header-title { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  .dash-header-subtitle { font-size: 0.78rem; color: var(--text-muted); }
  .dash-header-right { display: flex; align-items: center; gap: 12px; }
  .refresh-indicator { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
  .refresh-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .dash-btn {
    padding: 6px 14px; border: 1px solid var(--border-light); border-radius: 6px;
    background: var(--bg-card); color: var(--text-secondary); font-family: 'Inter', sans-serif;
    font-size: 0.78rem; cursor: pointer; transition: all 0.15s;
  }
  .dash-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
  .dash-btn.active { background: var(--blue); color: white; border-color: var(--blue); }

  .dash-tab-nav {
    display: flex; gap: 2px; padding: 0 32px;
    border-bottom: 1px solid var(--border); background: var(--bg-card);
  }
  .dash-tab-btn {
    padding: 10px 20px; background: transparent; border: none;
    color: var(--text-muted); font-family: 'Inter', sans-serif; font-size: 0.8rem;
    font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
  }
  .dash-tab-btn:hover { color: var(--text-secondary); }
  .dash-tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
  .dash-tab-content { display: none; }
  .dash-tab-content.active { display: block; }

  .banner {
    padding: 10px 16px; border-radius: 6px; margin: 0 32px 16px;
    font-size: 0.82rem; display: none;
    background: rgba(239,68,68,0.1); border: 1px solid #dc2626; color: var(--red);
  }
  .banner.show { display: block; }

  .summary-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px; padding: 20px 32px;
  }
  .summary-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 8px; padding: 14px 16px; position: relative;
  }
  .summary-card.clickable { cursor: pointer; transition: border-color 0.15s; }
  .summary-card.clickable:hover { border-color: var(--border-light); }
  .summary-label {
    font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 0.05em; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;
  }
  .summary-value {
    font-size: 1.4rem; font-weight: 600; font-family: 'JetBrains Mono', monospace;
    letter-spacing: -0.02em;
  }
  .sparkline-container { position: absolute; right: 12px; bottom: 10px; width: 80px; height: 24px; }
  .click-hint { font-size: 0.55rem; color: var(--text-muted); opacity: 0.6; }
  .positive { color: var(--green); }
  .negative { color: var(--red); }
  .warning-text { color: var(--yellow); }

  .error-panel {
    margin: 0 32px 12px; padding: 14px 18px;
    background: rgba(127, 29, 29, 0.15); border: 1px solid var(--red-dim);
    border-radius: 8px; display: none;
  }
  .error-panel.open { display: block; }
  .error-panel-title { font-weight: 600; color: var(--red); margin-bottom: 8px; font-size: 0.82rem; }
  .error-item { padding: 6px 0; border-bottom: 1px solid rgba(127, 29, 29, 0.3); }
  .error-item:last-child { border-bottom: none; }
  .error-id { color: var(--red); font-weight: 600; font-size: 0.78rem; }
  .error-meta { color: var(--text-muted); margin-left: 8px; font-size: 0.72rem; }
  .error-detail { color: var(--text-secondary); margin-top: 2px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }

  .charts-section { padding: 0 32px 20px; }
  .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
  .chart-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px;
  }
  .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .chart-title { font-size: 0.78rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.04em; }
  .chart-range-btns { display: flex; gap: 4px; }
  .range-btn {
    padding: 2px 8px; border: 1px solid var(--border); border-radius: 4px;
    background: transparent; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem; cursor: pointer; transition: all 0.15s;
  }
  .range-btn:hover { border-color: var(--border-light); color: var(--text-secondary); }
  .range-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(59,130,246,0.1); }
  .chart-wrap { position: relative; height: 200px; }
  .chart-wrap-tall { position: relative; height: 280px; }

  .insights-section { padding: 0 32px 20px; }
  .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }
  .insight-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
  .insight-title { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 8px; }
  .insight-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 0.75rem; }
  .insight-label { color: var(--text-secondary); font-size: 0.72rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
  .insight-value { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 500; }
  .alert-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.62rem; font-weight: 600; background: rgba(239, 68, 68, 0.15); color: var(--red); }
  .pair-heatmap { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; }
  .pair-cell { padding: 4px 6px; border-radius: 4px; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; }

  .d-filter-bar { display: flex; align-items: center; gap: 10px; padding: 0 32px 12px; flex-wrap: wrap; }
  .d-search-input {
    padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--bg-input); color: var(--text-primary); font-family: 'Inter', sans-serif;
    font-size: 0.78rem; outline: none; width: 220px; transition: border-color 0.15s;
  }
  .d-search-input:focus { border-color: var(--blue); }
  .d-search-input::placeholder { color: var(--text-muted); }
  .d-filter-btn {
    padding: 4px 10px; border: 1px solid var(--border); border-radius: 4px;
    background: transparent; color: var(--text-muted); font-family: 'Inter', sans-serif;
    font-size: 0.7rem; cursor: pointer; transition: all 0.15s;
  }
  .d-filter-btn:hover { border-color: var(--border-light); color: var(--text-secondary); }
  .d-filter-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(59,130,246,0.1); }

  .d-section { padding: 0 32px 20px; }
  .d-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .d-section-title { font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.04em; }

  .d-table-container {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
    overflow: hidden; max-height: 70vh; overflow-y: auto;
  }
  .d-table-container::-webkit-scrollbar { width: 6px; }
  .d-table-container::-webkit-scrollbar-track { background: var(--bg-card); }
  .d-table-container::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  #view-dashboard table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  #view-dashboard th {
    padding: 10px 14px; text-align: left; font-weight: 500; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.68rem;
    border-bottom: 1px solid var(--border); background: var(--bg-input);
    position: sticky; top: 0; z-index: 2; cursor: pointer; user-select: none; transition: color 0.15s;
  }
  #view-dashboard th:hover { color: var(--text-secondary); }
  #view-dashboard th .sort-arrow { display: inline-block; margin-left: 4px; font-size: 0.6rem; opacity: 0.4; }
  #view-dashboard th.sort-active .sort-arrow { opacity: 1; color: var(--blue); }
  #view-dashboard td {
    padding: 10px 14px; border-bottom: 1px solid rgba(30,41,59,0.5);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
  }
  #view-dashboard tr.instance-row { transition: opacity 0.15s; }
  #view-dashboard tr.instance-row:hover td { background: rgba(255,255,255,0.015); }
  #view-dashboard tr.instance-row.dimmed { opacity: 0.4; }
  #view-dashboard tr.instance-row.hidden-filter { display: none; }
  #view-dashboard tr.instance-row td:first-child { border-left: 3px solid transparent; }
  #view-dashboard tr.instance-row.pnl-positive td:first-child { border-left-color: var(--green); }
  #view-dashboard tr.instance-row.pnl-negative td:first-child { border-left-color: var(--red); }
  #view-dashboard tr.instance-row.pnl-zero td:first-child { border-left-color: var(--text-muted); }
  body.compact-mode #view-dashboard td { padding: 4px 14px; font-size: 0.72rem; }
  body.compact-mode .strategy-name { font-size: 0.75rem; }
  body.compact-mode .strategy-comment { display: none; }
  body.compact-mode .strategy-pair { font-size: 0.68rem; }

  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .status-running { background: var(--green); box-shadow: 0 0 6px rgba(16,185,129,0.4); }
  .status-stopped { background: var(--red); }
  .status-unknown { background: var(--text-muted); }
  .status-stale { background: var(--yellow); }

  .svc-btn {
    padding: 3px 8px; border: 1px solid var(--border-light); border-radius: 4px;
    background: transparent; color: var(--text-muted); font-family: 'Inter', sans-serif;
    font-size: 0.68rem; cursor: pointer; transition: all 0.15s; margin-right: 4px;
  }
  .svc-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
  .svc-btn.start:hover { border-color: var(--green); color: var(--green); }
  .svc-btn.stop:hover { border-color: var(--red); color: var(--red); }
  .svc-btn.restart:hover { border-color: var(--yellow); color: var(--yellow); }
  .pnl-cell { text-align: right; }

  .perf-panel {
    background: var(--bg-input); border-top: 1px solid var(--border);
    padding: 16px 20px; display: none;
  }
  .perf-panel.open { display: block; }
  .perf-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .perf-title { font-size: 0.78rem; font-weight: 600; color: var(--text-secondary); }
  .perf-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
  .perf-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; }
  .perf-metric-name { font-size: 0.75rem; color: var(--text-muted); }
  .perf-values { display: flex; align-items: center; gap: 10px; }
  .perf-expected { font-size: 0.72rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
  .perf-live { font-size: 0.82rem; font-weight: 500; font-family: 'JetBrains Mono', monospace; }
  .perf-chart-wrap { margin-top: 12px; height: 160px; position: relative; }
  .export-btn {
    padding: 4px 12px; border: 1px solid var(--border-light); border-radius: 4px;
    background: var(--bg-card); color: var(--text-secondary); font-family: 'Inter', sans-serif;
    font-size: 0.72rem; cursor: pointer; text-decoration: none; transition: all 0.15s;
  }
  .export-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }

  .trades-panel {
    background: var(--bg-input); border-top: 1px solid var(--border);
    padding: 16px 20px; display: none; max-height: 400px; overflow-y: auto;
  }
  .trades-panel.open { display: block; }
  .trades-panel::-webkit-scrollbar { width: 6px; }
  .trades-panel::-webkit-scrollbar-track { background: var(--bg-card); }
  .trades-panel::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  .trades-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
  .trades-table th { padding: 6px 10px; font-size: 0.65rem; background: var(--bg-card); position: static; }
  .trades-table td { padding: 5px 10px; font-size: 0.72rem; }

  .toggle-btn {
    padding: 3px 10px; border: 1px solid var(--border); border-radius: 4px;
    background: transparent; color: var(--text-muted); font-family: 'Inter', sans-serif;
    font-size: 0.68rem; cursor: pointer; transition: all 0.15s;
  }
  .toggle-btn:hover { color: var(--text-secondary); border-color: var(--border-light); }
  .toggle-btn.active { color: var(--blue); border-color: var(--blue); }

  .group-header-row td {
    background: var(--bg-input); font-family: 'Inter', sans-serif; font-weight: 600;
    font-size: 0.78rem; color: var(--text-secondary); cursor: pointer; padding: 8px 14px;
    border-left: 3px solid var(--blue) !important;
  }
  .group-header-row:hover td { background: rgba(59,130,246,0.05); }
  .group-chevron { display: inline-block; transition: transform 0.15s; margin-right: 6px; font-size: 0.65rem; }
  .group-chevron.collapsed { transform: rotate(-90deg); }
  .group-pnl { float: right; font-family: 'JetBrains Mono', monospace; font-weight: 500; }

  .strategy-cell { font-family: 'Inter', sans-serif !important; }
  .strategy-name { font-weight: 600; font-size: 0.82rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px; }
  .strategy-pair { font-size: 0.75rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .tf-badge { display: inline-block; padding: 0 5px; border-radius: 3px; font-size: 0.65rem; font-weight: 600; background: rgba(59,130,246,0.15); color: var(--blue); }
  .strat-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; }
  .strat-mean-rev { background: rgba(139,92,246,0.2); color: var(--purple); }
  .strat-trend { background: rgba(6,182,212,0.2); color: var(--cyan); }
  .strat-value { background: rgba(16,185,129,0.2); color: var(--green); }
  .strat-momentum { background: rgba(245,158,11,0.2); color: var(--yellow); }
  .strat-volatility { background: rgba(245,158,11,0.2); color: var(--yellow); }
  .strat-session { background: rgba(6,182,212,0.2); color: var(--cyan); }
  .strategy-comment { font-size: 0.68rem; color: var(--text-muted); margin-top: 2px; line-height: 1.3; }

  .no-data { color: var(--text-muted); font-style: italic; font-family: 'Inter', sans-serif; }
  .d-footer { text-align: center; padding: 16px 32px; color: var(--text-muted); font-size: 0.7rem; border-top: 1px solid var(--border); margin-top: 20px; }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 0.75rem; font-weight: 600; font-family: 'JetBrains Mono', monospace;
  }
  .badge-green { background: #065f46; color: #10b981; }
  .badge-yellow { background: #78350f; color: #f59e0b; }
  .badge-red { background: #7f1d1d; color: #ef4444; }
  .badge-blue { background: rgba(59,130,246,0.15); color: #3b82f6; }

  .hide-mobile { }
  .btn {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 4px; border: 1px solid #334155;
    background: #1e293b; color: #8896ab; font-size: 0.7rem;
    cursor: pointer; transition: all 0.15s; font-family: 'Inter', sans-serif;
  }
  .btn:hover { background: #334155; color: #e2e8f0; }
  .btn-danger { border-color: #dc2626; color: #ef4444; }
  .btn-danger:hover { background: rgba(239,68,68,0.15); }

  /* ══════════════════════════════════════
     LEADERBOARD VIEW (matching generate_index.py)
     ══════════════════════════════════════ */
  .page-header {
    padding: 24px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 16px;
  }
  .page-title { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  .page-subtitle { font-size: 0.78rem; color: #5a6a80; }
  .summary-strip { display: flex; gap: 24px; flex-wrap: wrap; }
  .summary-item { text-align: center; }
  .summary-num { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; }
  .summary-label { font-size: 0.68rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.05em; }

  .filter-bar {
    padding: 12px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: #0d1320;
  }
  .filter-group { display: flex; align-items: center; gap: 4px; }
  .filter-label { font-size: 0.7rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.04em; margin-right: 4px; }
  .filter-btn {
    background: #111827; border: 1px solid #1e293b; color: #8896ab;
    padding: 4px 10px; border-radius: 4px; font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s;
  }
  .filter-btn:hover { border-color: #3b82f6; color: #e2e8f0; }
  .filter-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #3b82f6; }
  .filter-btn.clear-btn { background: transparent; border-color: transparent; color: #5a6a80; font-family: 'Inter', sans-serif; }
  .filter-btn.clear-btn:hover { color: #ef4444; }

  .table-container { padding: 0 16px; overflow-x: auto; }
  #leaderboard { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 8px; }
  #leaderboard th {
    padding: 10px 10px; text-align: left; font-weight: 500; color: #5a6a80;
    text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.68rem;
    border-bottom: 1px solid #1e293b; cursor: pointer; user-select: none;
    white-space: nowrap; position: sticky; top: 47px; background: #0a0e1a; z-index: 10;
  }
  #leaderboard th:hover { color: #8896ab; }
  #leaderboard th.sort-asc::after { content: ' \25B2'; font-size: 0.6rem; }
  #leaderboard th.sort-desc::after { content: ' \25BC'; font-size: 0.6rem; }
  #leaderboard th.no-sort { cursor: default; }
  #leaderboard th.no-sort:hover { color: #5a6a80; }
  #leaderboard td {
    padding: 8px 10px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; white-space: nowrap;
  }
  #leaderboard tr:hover td { background: rgba(255,255,255,0.02); }
  #leaderboard tr.hidden { display: none; }
  .score-col { font-size: 1rem; }
  .strategy-col { font-family: 'Inter', sans-serif; color: #8896ab; font-size: 0.75rem; }
  .desc-col { font-family: 'Inter', sans-serif; color: #6b7f99; font-size: 0.7rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .runid-col { font-size: 0.68rem; color: #5a6a80; }
  .compare-check { width: 16px; height: 16px; cursor: pointer; accent-color: #3b82f6; }

  /* Compare toolbar */
  .compare-toolbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #111827; border-top: 2px solid #3b82f6;
    padding: 12px 32px; display: flex; align-items: center; gap: 16px;
    z-index: 1000; transform: translateY(100%); transition: transform 0.25s ease;
  }
  .compare-toolbar.visible { transform: translateY(0); }
  .compare-toolbar .count { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #3b82f6; font-weight: 600; }
  .compare-toolbar button {
    padding: 8px 20px; border-radius: 6px; font-family: 'Inter', sans-serif;
    font-size: 0.82rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s;
  }
  .compare-toolbar .btn-compare { background: #3b82f6; color: white; }
  .compare-toolbar .btn-compare:hover { background: #2563eb; }
  .compare-toolbar .btn-clear { background: transparent; color: #5a6a80; border: 1px solid #1e293b; }
  .compare-toolbar .btn-clear:hover { color: #ef4444; border-color: #ef4444; }

  /* Compare section */
  #compare-section { display: none; padding: 24px 32px; border-top: 2px solid #3b82f6; margin-top: 16px; }
  #compare-section.visible { display: block; }
  .compare-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .compare-title { font-size: 1.1rem; font-weight: 700; color: #3b82f6; }
  .compare-close {
    background: transparent; border: 1px solid #1e293b; color: #5a6a80;
    padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.78rem;
  }
  .compare-close:hover { color: #ef4444; border-color: #ef4444; }
  .compare-chart-panel { background: #111827; border: 1px solid #1e293b; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
  .compare-chart-header { padding: 12px 16px; border-bottom: 1px solid #1e293b; font-size: 0.82rem; font-weight: 600; color: #8896ab; }
  .compare-metrics-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .compare-metrics-table th {
    position: static; padding: 10px 14px; text-align: left; font-weight: 600;
    color: #5a6a80; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.04em;
    border-bottom: 1px solid #1e293b; background: #0d1320; cursor: default;
  }
  .compare-metrics-table th:hover { color: #5a6a80; }
  .compare-metrics-table td {
    padding: 8px 14px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
  }
  .compare-metrics-table .metric-label-col { color: #8896ab; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 0.78rem; width: 140px; }
  .compare-metrics-table .best-val { color: #10b981; font-weight: 600; }

  .text-green { color: #10b981; }
  .text-red { color: #ef4444; }
  .text-dim { color: #5a6a80; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .text-right { text-align: right; }
  .footer { text-align: center; padding: 16px; color: #5a6a80; font-size: 0.7rem; border-top: 1px solid #1e293b; margin-top: 20px; }

  /* Run detail panel - full-screen overlay */
  #leaderboard tr[data-run] { cursor: pointer; }
  .runid-col a { cursor: pointer; }
  .run-detail { display: none; }
  .run-detail.visible {
    display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 200; background: #0a0e1a; overflow-y: auto; padding: 0;
  }
  .rd-inner { max-width: 1200px; margin: 0 auto; padding: 32px 40px; }
  body.rd-open { overflow: hidden; }

  .rd-header {
    padding: 28px 32px; background: #111827; border: 1px solid #1e293b;
    border-radius: 8px; margin: 0 0 20px;
  }
  .rd-title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
  .rd-title { font-size: 1.4rem; font-weight: 700; }
  .rd-meta { font-size: 0.8rem; color: #5a6a80; margin-top: 4px; word-break: break-all; }
  .rd-score-block { text-align: right; flex-shrink: 0; }
  .rd-score-big { font-size: 2.8rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; line-height: 1; }
  .rd-recommendation { font-size: 0.72rem; color: #8896ab; margin-top: 4px; font-style: italic; max-width: 200px; text-align: right; }
  .rd-config-strip {
    display: flex; gap: 14px; flex-wrap: wrap; margin-top: 10px;
    padding-top: 10px; border-top: 1px solid #1e293b;
  }
  .rd-config-item { font-size: 0.78rem; color: #5a6a80; font-family: 'JetBrains Mono', monospace; }
  .rd-config-item span { color: #8896ab; }
  .rd-close-btn {
    position: sticky; top: 0; z-index: 10; display: flex; justify-content: flex-end;
    padding: 12px 0 8px; background: #0a0e1a;
  }
  .rd-close-btn button {
    padding: 10px 20px; border-radius: 6px; font-size: 0.88rem;
    font-family: 'Inter', sans-serif; font-weight: 600;
    background: #1e293b; border: 1px solid #334155; color: #8896ab;
    cursor: pointer; transition: all 0.15s;
  }
  .rd-close-btn button:hover { background: #334155; color: #e2e8f0; }

  /* Sections */
  .rd-section {
    margin: 0 0 16px; background: #111827;
    border: 1px solid #1e293b; border-radius: 8px; overflow: hidden;
  }
  .rd-section-head {
    padding: 14px 24px; cursor: pointer; display: flex;
    align-items: center; justify-content: space-between;
    border-left: 4px solid var(--rd-accent, #3b82f6); user-select: none;
  }
  .rd-section-head:hover { background: rgba(255,255,255,0.02); }
  .rd-section-head h3 {
    font-size: 0.9rem; font-weight: 600; color: #8896ab;
    text-transform: uppercase; letter-spacing: 0.05em; margin: 0;
  }
  .rd-chevron { color: #5a6a80; font-size: 0.7rem; transition: transform 0.2s; }
  .rd-section.collapsed .rd-section-body { display: none; }
  .rd-section.collapsed .rd-chevron { transform: rotate(-90deg); }
  .rd-section-body { padding: 24px 28px; border-top: 1px solid #1e293b; }

  /* Performance table */
  .rd-perf-table { width: 100%; border-collapse: collapse; }
  .rd-perf-table th {
    padding: 10px 16px; text-align: right; font-size: 0.78rem;
    color: #5a6a80; text-transform: uppercase; letter-spacing: 0.04em;
    border-bottom: 1px solid #1e293b; position: static; cursor: default; width: 33%;
  }
  .rd-perf-table th:first-child { text-align: left; }
  .rd-perf-table th:hover { color: #5a6a80; }
  .rd-perf-table td {
    padding: 10px 16px; font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem; text-align: right; border-bottom: 1px solid rgba(30,41,59,0.3);
  }
  .rd-perf-table td:first-child { text-align: left; font-family: 'Inter', sans-serif; color: #8896ab; font-weight: 500; font-size: 0.88rem; }
  .rd-fb-banner {
    text-align: center; padding: 14px; margin-top: 14px;
    background: #0d1320; border-radius: 6px;
  }
  .rd-fb-label { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; }
  .rd-fb-value { font-size: 1.6rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

  /* Confidence bars */
  .rd-conf-total { text-align: center; margin-bottom: 18px; padding: 14px; background: #0d1320; border-radius: 6px; }
  .rd-conf-total .score { font-size: 2.2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
  .rd-conf-total .label { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; margin-top: 2px; }
  .rd-conf-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .rd-conf-label { width: 120px; font-size: 0.82rem; color: #8896ab; flex-shrink: 0; }
  .rd-conf-bar-bg { flex: 1; height: 24px; background: #0d1320; border-radius: 4px; overflow: hidden; }
  .rd-conf-bar-fill { height: 100%; border-radius: 4px; min-width: 2px; }
  .rd-conf-score { width: 40px; text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.88rem; flex-shrink: 0; }
  .rd-conf-weight { width: 36px; text-align: right; font-size: 0.72rem; color: #5a6a80; flex-shrink: 0; }

  /* WF table */
  .rd-wf-summary { margin-bottom: 12px; font-size: 0.92rem; }
  .rd-wf-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .rd-wf-table th {
    padding: 8px 10px; text-align: right; font-size: 0.72rem;
    color: #5a6a80; text-transform: uppercase; border-bottom: 1px solid #1e293b;
    background: #0d1320; position: static; cursor: default;
  }
  .rd-wf-table th:first-child, .rd-wf-table th:nth-child(2) { text-align: center; }
  .rd-wf-table th:hover { color: #5a6a80; }
  .rd-wf-table td {
    padding: 7px 10px; font-family: 'JetBrains Mono', monospace;
    text-align: right; border-bottom: 1px solid rgba(30,41,59,0.25); font-size: 0.82rem;
  }
  .rd-wf-table td:first-child, .rd-wf-table td:nth-child(2) { text-align: center; }
  .rd-wf-table tr.wf-fail td { opacity: 0.5; }
  .rd-wf-table tr.wf-oos td { background: rgba(59,130,246,0.04); }
  .rd-wf-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }

  /* MC cards */
  .rd-mc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .rd-mc-card { background: #0d1320; border-radius: 6px; padding: 20px; }
  .rd-mc-card-title { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; margin-bottom: 8px; font-weight: 600; }
  .rd-mc-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.88rem; }
  .rd-mc-row .lbl { color: #8896ab; font-size: 0.82rem; }
  .rd-mc-row .val { font-family: 'JetBrains Mono', monospace; }

  /* Stability */
  .rd-stab-grid { display: flex; gap: 16px; flex-wrap: wrap; }
  .rd-stab-card { background: #0d1320; border-radius: 6px; padding: 18px 28px; text-align: center; min-width: 120px; }
  .rd-stab-card .val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .rd-stab-card .lbl { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; margin-top: 3px; }

  /* Trade analysis */
  .rd-trade-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 14px; }
  .rd-trade-card { background: #0d1320; border-radius: 6px; padding: 14px 18px; }
  .rd-trade-card .lbl { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; }
  .rd-trade-card .val { font-size: 1.2rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .rd-exit-table { width: 100%; border-collapse: collapse; max-width: 500px; }
  .rd-exit-table td { padding: 3px 8px; font-size: 0.75rem; border-bottom: 1px solid rgba(30,41,59,0.25); }
  .rd-exit-table td:first-child { color: #8896ab; }
  .rd-exit-table td:nth-child(2) { font-family: 'JetBrains Mono', monospace; text-align: right; width: 60px; }
  .rd-exit-table td:nth-child(3) { width: 120px; }
  .rd-exit-bar { display: inline-block; height: 10px; border-radius: 2px; vertical-align: middle; }

  /* Monthly heatmap */
  .rd-monthly-table { border-collapse: collapse; font-size: 0.82rem; }
  .rd-monthly-table th {
    padding: 6px 10px; font-size: 0.68rem; color: #5a6a80;
    text-transform: uppercase; border-bottom: 1px solid #1e293b;
    text-align: center; position: static; cursor: default;
  }
  .rd-monthly-table th:hover { color: #5a6a80; }
  .rd-monthly-table td {
    padding: 6px 10px; text-align: center; font-family: 'JetBrains Mono', monospace;
    border: 1px solid rgba(30,41,59,0.25); min-width: 54px; font-size: 0.82rem;
  }
  .rd-monthly-table td:first-child { font-weight: 700; color: #8896ab; border-left: none; }

  /* Params table */
  .rd-params-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 24px; }
  @media (max-width: 700px) { .rd-params-grid { grid-template-columns: 1fr; } }
  .rd-params-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .rd-params-table td { padding: 6px 12px; border-bottom: 1px solid rgba(30,41,59,0.2); }
  .rd-params-table td:first-child { color: #8896ab; width: 50%; }
  .rd-params-table td:last-child { font-family: 'JetBrains Mono', monospace; }

  /* ══════════════════════════════════════
     MOBILE RESPONSIVE
     ══════════════════════════════════════ */
  @media (max-width: 768px) {
    /* Nav */
    .nav { padding: 0 12px; }
    .nav-brand { font-size: 0.85rem; margin-right: 12px; }
    .nav-tab { padding: 10px 14px; font-size: 0.78rem; min-height: 44px; display: flex; align-items: center; }
    .nav-right { font-size: 0.68rem; gap: 8px; }

    /* Dashboard (new) */
    .dash-header { padding: 16px; flex-direction: column; gap: 12px; }
    .summary-row { padding: 12px 16px; grid-template-columns: repeat(2, 1fr); }
    .d-section, .charts-section, .insights-section, .d-filter-bar { padding-left: 12px; padding-right: 12px; }
    .dash-tab-nav { padding: 0 12px; }
    #view-dashboard td, #view-dashboard th { padding: 6px 8px; font-size: 0.7rem; }
    .perf-grid { grid-template-columns: 1fr; }
    .hide-mobile { display: none !important; }
    .strategy-name { font-size: 0.75rem; }
    .strategy-pair { font-size: 0.7rem; }
    .strategy-comment { font-size: 0.65rem; }
    .d-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .charts-grid { grid-template-columns: 1fr; }
    .insights-grid { grid-template-columns: 1fr; }
    .d-search-input { width: 150px; }
    .btn { padding: 6px 8px; font-size: 0.68rem; min-height: 36px; }

    /* Leaderboard header */
    .page-header { padding: 16px; flex-direction: column; align-items: flex-start; gap: 12px; }
    .page-title { font-size: 1.1rem; }
    .summary-strip { gap: 16px; }
    .summary-num { font-size: 1.1rem; }
    .summary-label { font-size: 0.62rem; }

    /* Filter bar - horizontal scroll */
    .filter-bar {
      padding: 10px 12px; gap: 8px; overflow-x: auto;
      -webkit-overflow-scrolling: touch; flex-wrap: nowrap;
    }
    .filter-group { flex-shrink: 0; }
    .filter-btn { padding: 6px 8px; font-size: 0.7rem; min-height: 36px; touch-action: manipulation; }

    /* Leaderboard table */
    .table-container { padding: 0 8px; -webkit-overflow-scrolling: touch; }
    #leaderboard { font-size: 0.72rem; }
    #leaderboard th, #leaderboard td { padding: 6px 6px; }
    #leaderboard td { font-size: 0.7rem; }
    .score-col { font-size: 0.88rem; }
    /* Hide: Strategy(4), Description(5), BackSh(11), FwdSh(12), MaxDD(15), Time(18), RunID(19) */
    #leaderboard th:nth-child(4), #leaderboard td:nth-child(4),
    #leaderboard th:nth-child(5), #leaderboard td:nth-child(5),
    #leaderboard th:nth-child(11), #leaderboard td:nth-child(11),
    #leaderboard th:nth-child(12), #leaderboard td:nth-child(12),
    #leaderboard th:nth-child(15), #leaderboard td:nth-child(15),
    #leaderboard th:nth-child(18), #leaderboard td:nth-child(18),
    #leaderboard th:nth-child(19), #leaderboard td:nth-child(19) { display: none; }
    .compare-check { width: 20px; height: 20px; }

    /* Compare */
    #compare-section { padding: 16px; }
    #compare-chart { height: 280px !important; }
    .compare-toolbar { padding: 10px 16px; gap: 10px; }
    .compare-toolbar button { padding: 8px 14px; font-size: 0.78rem; min-height: 44px; touch-action: manipulation; }
    .compare-metrics-table th, .compare-metrics-table td { padding: 6px 8px; font-size: 0.72rem; }

    /* Run Detail */
    .rd-inner { padding: 16px; }
    .rd-header { padding: 18px 16px; }
    .rd-title { font-size: 1.1rem; }
    .rd-score-big { font-size: 2rem; }
    .rd-score-big > span { font-size: 0.75rem !important; }
    .rd-recommendation { font-size: 0.68rem; max-width: 140px; }
    .rd-config-strip { gap: 8px; }
    .rd-config-item { font-size: 0.72rem; }
    .rd-close-btn button { padding: 8px 14px; font-size: 0.82rem; min-height: 44px; touch-action: manipulation; }

    /* Charts */
    #rd-equity-chart { height: 280px !important; }
    #rd-dd-chart { height: 180px !important; }

    /* Sections */
    .rd-section-body { padding: 16px; }
    .rd-section-head { padding: 12px 16px; min-height: 44px; touch-action: manipulation; }
    .rd-section-head h3 { font-size: 0.82rem; }

    /* Performance table */
    .rd-perf-table td { font-size: 0.82rem; padding: 8px 10px; }
    .rd-perf-table td:first-child { font-size: 0.8rem; }
    .rd-fb-value { font-size: 1.3rem; }

    /* Confidence */
    .rd-conf-label { width: 85px; font-size: 0.75rem; }
    .rd-conf-score { font-size: 0.82rem; }
    .rd-conf-total .score { font-size: 1.8rem; }

    /* MC grid - single column on mobile */
    .rd-mc-grid { grid-template-columns: 1fr; }
    .rd-mc-row { font-size: 0.82rem; }
    .rd-mc-row .lbl { font-size: 0.78rem; }

    /* Stability */
    .rd-stab-card { padding: 14px 18px; min-width: 100px; }
    .rd-stab-card .val { font-size: 1.2rem; }

    /* Trade grid - 2 columns */
    .rd-trade-grid { grid-template-columns: repeat(2, 1fr); }
    .rd-trade-card .val { font-size: 1rem; }

    /* WF table */
    .rd-wf-table { font-size: 0.72rem; }
    .rd-wf-table th, .rd-wf-table td { padding: 5px 6px; }

    /* Monthly table */
    .rd-monthly-table td { min-width: 40px; padding: 5px 6px; font-size: 0.72rem; }
    .rd-monthly-table th { padding: 5px 6px; font-size: 0.62rem; }

    /* Params - single column */
    .rd-params-grid { grid-template-columns: 1fr; }

    /* Footer */
    .footer { font-size: 0.65rem; padding: 12px; }
  }

  @media (max-width: 480px) {
    /* Nav - hide clock, tighter spacing */
    .nav-brand { font-size: 0.78rem; margin-right: 8px; }
    .nav-tab { padding: 10px 10px; font-size: 0.72rem; }
    .nav-right { display: none; }

    /* Dashboard cards - 2 columns fixed */
    .cards { grid-template-columns: repeat(2, 1fr); }
    .card-value { font-size: 1rem; }
    .card-label { font-size: 0.62rem; }
    /* Also hide Heartbeat column */
    .dash-table th:nth-child(4), .dash-table td:nth-child(4) { display: none; }

    /* Leaderboard - hide more: checkbox(1), Date(9), BackTr(13), FwdTr(14) */
    #leaderboard th:nth-child(1), #leaderboard td:nth-child(1),
    #leaderboard th:nth-child(9), #leaderboard td:nth-child(9),
    #leaderboard th:nth-child(13), #leaderboard td:nth-child(13),
    #leaderboard th:nth-child(14), #leaderboard td:nth-child(14) { display: none; }

    .summary-strip { gap: 10px; }
    .summary-num { font-size: 0.95rem; }

    /* Run detail - stack header vertically */
    .rd-title-row { flex-direction: column; }
    .rd-score-block { text-align: left; }
    .rd-score-big { font-size: 1.8rem; }
    .rd-title { font-size: 1rem; }
    .rd-meta { font-size: 0.72rem; }

    /* Even smaller charts */
    #rd-equity-chart { height: 240px !important; }
    #rd-dd-chart { height: 150px !important; }
    #compare-chart { height: 240px !important; }

    .rd-trade-card { padding: 10px 12px; }
    .rd-trade-card .val { font-size: 0.92rem; }
    .rd-stab-grid { gap: 8px; }
    .rd-stab-card { padding: 10px 14px; }
    .rd-stab-card .val { font-size: 1rem; }

    .compare-toolbar { flex-wrap: wrap; padding: 8px 12px; }
  }
</style>
</head>
<body>

<!-- ═══ NAVIGATION ═══ -->
<nav class="nav">
  <div class="nav-brand">OANDA System</div>
  <div class="nav-tab active" data-view="dashboard" onclick="switchView('dashboard')">Trading</div>
  <div class="nav-tab" data-view="leaderboard" onclick="switchView('leaderboard')">Pipeline</div>
  <div class="nav-right"><span id="clock"></span></div>
</nav>

<!-- ═══ DASHBOARD VIEW (NEW) ═══ -->
<div id="view-dashboard" class="view active">

  <div id="vps-banner" class="banner">VPS Offline &mdash; Live trading data unavailable. The Pipeline tab still works.</div>

  <!-- HEADER -->
  <div class="dash-header">
    <div class="dash-header-left">
      <div>
        <div class="dash-header-title">OANDA Trading Dashboard</div>
        <div class="dash-header-subtitle">Multi-Strategy Monitor</div>
      </div>
    </div>
    <div class="dash-header-right">
      <div class="refresh-indicator"><span class="refresh-dot"></span><span id="dash-last-update">--:--:--</span></div>
      <button class="dash-btn" id="compact-toggle" onclick="toggleCompact()">Compact</button>
      <button class="dash-btn" onclick="dashRefreshAll()">Refresh</button>
    </div>
  </div>

  <!-- TAB NAVIGATION -->
  <div class="dash-tab-nav">
    <button class="dash-tab-btn active" data-dtab="overview" onclick="switchDashTab('overview')">Overview</button>
    <button class="dash-tab-btn" data-dtab="strategies" onclick="switchDashTab('strategies')">All Strategies</button>
    <button class="dash-tab-btn" data-dtab="alerts" onclick="switchDashTab('alerts')">Alerts</button>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-row" id="summary-row">
    <div class="summary-card">
      <div class="summary-label">Daily P&amp;L</div>
      <div class="summary-value" id="sum-daily-pnl">&mdash;</div>
      <div class="sparkline-container"><canvas id="sparkline-pnl"></canvas></div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Open Positions</div>
      <div class="summary-value" id="sum-positions">&mdash;</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Trades Today</div>
      <div class="summary-value" id="sum-trades">&mdash;</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Running</div>
      <div class="summary-value" id="sum-running">&mdash;</div>
    </div>
    <div class="summary-card clickable" onclick="toggleErrorPanel()">
      <div class="summary-label">Errors <span class="click-hint">&#9660;</span></div>
      <div class="summary-value" id="sum-errors">&mdash;</div>
    </div>
  </div>

  <!-- ERROR DETAILS PANEL -->
  <div class="error-panel" id="error-panel">
    <div class="error-panel-title">Error Details</div>
    <div id="error-list"><div class="no-data">No errors</div></div>
  </div>

  <!-- ==================== OVERVIEW TAB ==================== -->
  <div class="dash-tab-content active" id="dtab-overview">
    <div class="charts-section">
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Portfolio Equity Curve</span>
            <div class="chart-range-btns">
              <button class="range-btn" onclick="setDashRange(7)">1W</button>
              <button class="range-btn active" onclick="setDashRange(30)">1M</button>
              <button class="range-btn" onclick="setDashRange(90)">3M</button>
              <button class="range-btn" onclick="setDashRange(0)">ALL</button>
            </div>
          </div>
          <div class="chart-wrap"><canvas id="chart-equity"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-header"><span class="chart-title">Daily P&amp;L</span></div>
          <div class="chart-wrap"><canvas id="chart-daily-pnl"></canvas></div>
        </div>
      </div>
    </div>

    <div class="insights-section">
      <div class="insights-grid" id="insights-grid">
        <div class="insight-card">
          <div class="insight-title">Best / Worst Today</div>
          <div id="insight-best-worst"><span class="no-data">Loading...</span></div>
        </div>
        <div class="insight-card">
          <div class="insight-title">Alerts</div>
          <div id="insight-alerts"><span class="no-data">Loading...</span></div>
        </div>
        <div class="insight-card">
          <div class="insight-title">Trade Frequency</div>
          <div id="insight-frequency"><span class="no-data">Loading...</span></div>
        </div>
        <div class="insight-card">
          <div class="insight-title">Pair Heatmap (Today)</div>
          <div id="insight-heatmap" class="pair-heatmap"><span class="no-data">Loading...</span></div>
        </div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-card">
        <div class="chart-header"><span class="chart-title">Strategy Ranking by Total P&amp;L</span></div>
        <div class="chart-wrap-tall"><canvas id="chart-strategy-rank"></canvas></div>
      </div>
    </div>

    <div class="d-section" id="overview-table-section">
      <div class="d-section-header"><div class="d-section-title">Top &amp; Bottom Performers</div></div>
      <div class="d-table-container" style="max-height:none">
        <table>
          <thead><tr>
            <th>Status</th><th>Strategy / Pair</th>
            <th style="text-align:right">Daily P&amp;L</th><th style="text-align:right">Total P&amp;L</th><th style="text-align:right">W / L</th>
          </tr></thead>
          <tbody id="overview-top-bottom"><tr><td colspan="5" class="no-data" style="text-align:center;padding:2rem">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== ALL STRATEGIES TAB ==================== -->
  <div class="dash-tab-content" id="dtab-strategies">
    <div class="d-filter-bar">
      <input type="text" class="d-search-input" id="d-search-input" placeholder="Search strategy, pair..." oninput="dFilterTable()">
      <button class="d-filter-btn active" data-dfilter="ALL" onclick="setDGroupFilter('ALL')">ALL</button>
      <button class="d-filter-btn" data-dfilter="RSI" onclick="setDGroupFilter('RSI')">RSI</button>
      <button class="d-filter-btn" data-dfilter="EMA" onclick="setDGroupFilter('EMA')">EMA</button>
      <button class="d-filter-btn" data-dfilter="BBSQ" onclick="setDGroupFilter('BBSQ')">BBSQ</button>
      <button class="d-filter-btn" data-dfilter="DCH" onclick="setDGroupFilter('DCH')">DCH</button>
      <button class="d-filter-btn" data-dfilter="LDN" onclick="setDGroupFilter('LDN')">LDN</button>
      <button class="d-filter-btn" data-dfilter="STADX" onclick="setDGroupFilter('STADX')">STADX</button>
      <button class="d-filter-btn" data-dfilter="FPMA" onclick="setDGroupFilter('FPMA')">FPMA</button>
      <button class="dash-btn" id="d-group-toggle" onclick="dToggleGrouping()" style="margin-left:auto">Group</button>
    </div>

    <div class="d-section">
      <div class="d-table-container" id="d-main-table-container">
        <table id="d-main-table">
          <thead><tr>
            <th data-dsort="status" onclick="dSortTable('status')">Status <span class="sort-arrow">&#9650;</span></th>
            <th data-dsort="strategy" onclick="dSortTable('strategy')">Strategy / Pair <span class="sort-arrow">&#9650;</span></th>
            <th class="hide-mobile" data-dsort="heartbeat" onclick="dSortTable('heartbeat')">Heartbeat <span class="sort-arrow">&#9650;</span></th>
            <th class="hide-mobile" data-dsort="pos" onclick="dSortTable('pos')">Pos <span class="sort-arrow">&#9650;</span></th>
            <th style="text-align:right" data-dsort="pnl" onclick="dSortTable('pnl')">P&amp;L <span class="sort-arrow">&#9660;</span></th>
            <th style="text-align:right" data-dsort="wl" onclick="dSortTable('wl')">W / L <span class="sort-arrow">&#9650;</span></th>
            <th class="hide-mobile">Actions</th>
          </tr></thead>
          <tbody id="d-instances-body">
            <tr><td colspan="7" class="no-data" style="text-align:center;padding:2rem">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== ALERTS TAB ==================== -->
  <div class="dash-tab-content" id="dtab-alerts">
    <div class="d-section" style="padding-top:20px">
      <div class="chart-card" style="margin-bottom:16px">
        <div class="chart-title" style="margin-bottom:12px">Instance Errors</div>
        <div id="alerts-errors"><span class="no-data">No errors</span></div>
      </div>
      <div class="chart-card" style="margin-bottom:16px">
        <div class="chart-title" style="margin-bottom:12px">Losing Streaks</div>
        <div id="alerts-streaks"><span class="no-data">Loading...</span></div>
      </div>
      <div class="chart-card" style="margin-bottom:16px">
        <div class="chart-title" style="margin-bottom:12px">Drawdown Alerts (Live &gt; 1.5x Expected)</div>
        <div id="alerts-dd"><span class="no-data">Loading...</span></div>
      </div>
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:12px">Trade Frequency Anomalies</div>
        <div id="alerts-freq"><span class="no-data">Loading...</span></div>
      </div>
    </div>
  </div>

  <!-- SCAN RESULTS -->
  <div class="d-section" id="scan-section" style="display:none">
    <div class="d-section-title">Pipeline Scanner</div>
    <div class="summary-row" style="padding:0 0 12px 0">
      <div class="summary-card"><div class="summary-label">Phase</div><div class="summary-value" id="scan-phase" style="font-size:1rem">--</div></div>
      <div class="summary-card"><div class="summary-label">Progress</div><div class="summary-value" id="scan-progress">--</div></div>
      <div class="summary-card"><div class="summary-label">GREEN</div><div class="summary-value positive" id="scan-green">0</div></div>
      <div class="summary-card"><div class="summary-label">Strategy</div><div class="summary-value" id="scan-strategy" style="font-size:0.9rem">--</div></div>
    </div>
    <div style="background:var(--bg-input);border-radius:4px;height:6px;margin-bottom:12px;overflow:hidden">
      <div id="scan-bar" style="background:var(--green);height:100%;width:0%;transition:width 0.5s"></div>
    </div>
    <div class="d-table-container" style="max-height:none">
      <table>
        <thead><tr>
          <th style="cursor:default">#</th><th style="cursor:default">Pair</th><th style="cursor:default">TF</th>
          <th style="text-align:right;cursor:default">Score</th><th style="cursor:default">Rating</th>
          <th style="text-align:right;cursor:default">WF%</th><th style="text-align:right;cursor:default">Sharpe</th>
          <th style="text-align:right;cursor:default">Stability</th><th style="text-align:right;cursor:default">Time</th>
        </tr></thead>
        <tbody id="scan-body"></tbody>
      </table>
    </div>
  </div>

  <div class="d-footer">OANDA Trading System &mdash; Auto-refresh: 15s &mdash; <span id="dash-footer-time">--:--:-- UTC</span></div>
</div>

<!-- ═══ LEADERBOARD VIEW ═══ -->
<div id="view-leaderboard" class="view">
  <div class="page-header">
    <div>
      <div class="page-title">Pipeline Leaderboard</div>
      <div class="page-subtitle" id="lb-subtitle">Loading...</div>
    </div>
    <div class="summary-strip" id="lb-summary"></div>
  </div>
  <div class="filter-bar" id="lb-filters"></div>
  <div class="table-container">
    <table id="leaderboard">
      <thead><tr>
        <th class="no-sort" style="width:36px">&nbsp;</th>
        <th data-col="1">Pair</th>
        <th data-col="2">TF</th>
        <th data-col="3">Strategy</th>
        <th data-col="4">Description</th>
        <th data-col="5">Score</th>
        <th data-col="6">Rating</th>
        <th data-col="7">Status</th>
        <th data-col="8">Date</th>
        <th data-col="9">Profit</th>
        <th data-col="10">Back Sh</th>
        <th data-col="11">Fwd Sh</th>
        <th data-col="12">Back Tr</th>
        <th data-col="13">Fwd Tr</th>
        <th data-col="14">Max DD</th>
        <th data-col="15">F/B Ratio</th>
        <th data-col="16">Win %</th>
        <th data-col="17">Time</th>
        <th data-col="18">Run ID</th>
      </tr></thead>
      <tbody id="lb-body">
        <tr><td colspan="19" style="text-align:center;padding:2rem;color:#5a6a80">Loading leaderboard...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Comparison Section -->
  <div id="compare-section">
    <div class="compare-header">
      <div class="compare-title">Strategy Comparison</div>
      <button class="compare-close" onclick="closeComparison()">Close</button>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Equity Curves Overlay</div>
      <div id="compare-chart" style="height:450px"></div>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Metrics Comparison</div>
      <div id="compare-metrics" style="padding:0"></div>
    </div>
  </div>

  <!-- Run Detail Panel (content generated by showRunDetail) -->
  <div class="run-detail" id="run-detail"></div>

  <div class="footer" id="lb-footer"></div>
</div>

<!-- Compare Toolbar -->
<div class="compare-toolbar" id="compare-toolbar">
  <span class="count"><span id="compare-count">0</span> selected</span>
  <button class="btn-compare" onclick="runComparison()">Compare</button>
  <button class="btn-clear" onclick="clearSelection()">Clear</button>
</div>

<script>
// ═══════════════════════════════════════
// GLOBALS
// ═══════════════════════════════════════
var COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
function isMobile() { return window.innerWidth < 768; }
function mobileLayout(l) {
  if (!isMobile()) return l;
  l.margin = { l: 40, r: 10, t: 10, b: 30 };
  if (l.font) l.font.size = 10;
  if (l.legend) l.legend.font = Object.assign({}, l.legend.font || {}, { size: 9 });
  if (l.xaxis && l.xaxis.tickfont) l.xaxis.tickfont.size = 9;
  if (l.yaxis && l.yaxis.tickfont) l.yaxis.tickfont.size = 9;
  return l;
}
var currentView = 'dashboard';
var lbData = null;
var lbLoaded = false;

// ═══════════════════════════════════════
// VIEW SWITCH
// ═══════════════════════════════════════
function switchView(v) {
  currentView = v;
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.view === v); });
  document.querySelectorAll('.view').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('view-' + v).classList.add('active');
  if (v === 'dashboard') { startDash(); } else { stopDash(); if (!lbLoaded) loadLeaderboard(); }
  history.replaceState(null, '', '#' + v);
}

// Charts refresh separately every 5 minutes
setInterval(function() { if (currentView === 'dashboard') { dashRefreshCharts(30); dashRenderStrategyRankChart(); } }, 300000);

// Clock
function updateClock() {
  var d = new Date();
  document.getElementById('clock').textContent = d.toLocaleTimeString('en-US', {hour12:false});
}
setInterval(updateClock, 1000); updateClock();

// ═══════════════════════════════════════
// DASHBOARD (NEW - Charts, Insights, Alerts)
// ═══════════════════════════════════════
function esc(s) { if (s == null) return ''; var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
function num(v, dec) { return v != null ? Number(v).toFixed(dec||2) : '\u2014'; }

var DASH_REFRESH_SECONDS = 15;
var dCurrentSort = { col: 'pnl', dir: 'desc' };
var dCurrentGroupFilter = 'ALL';
var dGroupingEnabled = false;
var dCachedInstances = [];
var equityChart = null, dailyPnlChart = null, strategyRankChart = null, sparklineChart = null;
var perfCharts = {};
var chartDefaults = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { grid: { color: 'rgba(30,41,59,0.5)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 10 } } },
    y: { grid: { color: 'rgba(30,41,59,0.5)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 10 } } }
  }
};

// ── Tab navigation ──
function switchDashTab(tabName) {
  document.querySelectorAll('.dash-tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.dtab === tabName); });
  document.querySelectorAll('.dash-tab-content').forEach(function(c) { c.classList.toggle('active', c.id === 'dtab-' + tabName); });
}
function toggleErrorPanel() { document.getElementById('error-panel').classList.toggle('open'); }
function toggleCompact() { document.body.classList.toggle('compact-mode'); document.getElementById('compact-toggle').classList.toggle('active'); }

function dashUpdateTime() {
  var now = new Date();
  var ts = now.toLocaleTimeString('en-US', {hour12: false, timeZone: 'UTC'});
  document.getElementById('dash-last-update').textContent = ts;
  document.getElementById('dash-footer-time').textContent = ts + ' UTC';
}

// ── Main refresh ──
function dashRefreshAll() { dashRefreshStatus(); dashRefreshCharts(30); dashRefreshInsights(); dashRefreshScan(); }

async function dashRefreshStatus() {
  try {
    var r = await fetch('/api/vps/status');
    if (!r.ok) { var ed; try { ed = await r.json(); } catch(x) { ed = {}; } throw new Error(ed.message || 'HTTP ' + r.status); }
    var data = await r.json();
    if (data.error) throw new Error(data.message);
    document.getElementById('vps-banner').classList.remove('show');
    dashUpdateSummary(data.summary || {});
    dCachedInstances = data.instances || [];
    dashRenderInstances(dCachedInstances);
    dashUpdateOverviewTopBottom(dCachedInstances);
    dashUpdateTime();
  } catch(e) {
    var banner = document.getElementById('vps-banner');
    banner.classList.add('show');
    banner.innerHTML = 'VPS Error &mdash; ' + esc(e.message) + '. The Pipeline tab still works.';
  }
}

function dashUpdateSummary(s) {
  var pnl = s.daily_pnl || 0;
  var pnlEl = document.getElementById('sum-daily-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
  pnlEl.className = 'summary-value ' + (pnl >= 0 ? 'positive' : 'negative');
  document.getElementById('sum-positions').textContent = s.open_positions || 0;
  document.getElementById('sum-trades').textContent = s.total_trades || 0;
  var runEl = document.getElementById('sum-running');
  runEl.textContent = (s.running||0) + '/' + (s.total||0);
  runEl.className = 'summary-value ' + ((s.running||0) === (s.total||0) ? 'positive' : 'warning-text');
  var errEl = document.getElementById('sum-errors');
  errEl.textContent = s.errors || 0;
  errEl.className = 'summary-value ' + ((s.errors||0) > 0 ? 'negative' : '');
  if ((s.errors||0) > 0) document.getElementById('error-panel').classList.add('open');
  // Error details
  var errorList = document.getElementById('error-list');
  if (s.error_instances && s.error_instances.length > 0) {
    errorList.innerHTML = s.error_instances.map(function(e) {
      return '<div class="error-item"><span class="error-id">' + esc(e.id) + '</span>' +
        '<span class="error-meta">(' + e.errors + 'x, status: ' + esc(e.status) + ')</span>' +
        '<div class="error-detail">' + esc(e.last_error || 'no detail') + '</div></div>';
    }).join('');
  } else {
    errorList.innerHTML = '<div class="no-data">No errors</div>';
  }
}

// ── Instance table rendering ──
function dashRenderInstances(instances) {
  var tbody = document.getElementById('d-instances-body');
  if (!instances.length) { tbody.innerHTML = '<tr><td colspan="7" class="no-data" style="text-align:center;padding:2rem">No trading instances</td></tr>'; return; }
  var html = '';
  instances.forEach(function(inst) {
    var pnlCls = inst.daily_pnl > 0 ? 'pnl-positive' : inst.daily_pnl < 0 ? 'pnl-negative' : 'pnl-zero';
    var dimCls = (!inst.enabled || inst.service_status === 'SERVICE_STOPPED') ? ' dimmed' : '';
    var totalPnl = (inst.live_performance && inst.live_performance.total_pnl) || 0;
    var tag = inst.strategy_tag || getStratTag(inst.id);

    html += '<tr class="instance-row ' + pnlCls + dimCls + '"' +
      ' data-id="' + esc(inst.id) + '"' +
      ' data-strategy="' + esc(inst.strategy_display || inst.strategy) + '"' +
      ' data-pair="' + esc(inst.pair) + '"' +
      ' data-pnl="' + (inst.daily_pnl||0) + '"' +
      ' data-total-pnl="' + totalPnl + '"' +
      ' data-enabled="' + inst.enabled + '"' +
      ' data-status="' + esc(inst.service_status) + '"' +
      ' data-heartbeat="' + (inst.heartbeat_age_seconds||99999) + '"' +
      ' data-heartbeat-ok="' + inst.heartbeat_ok + '"' +
      ' data-group="' + esc(tag) + '"' +
      ' data-daily-trades="' + (inst.daily_trades||0) + '"' +
      ' data-daily-wins="' + (inst.daily_wins||0) + '"' +
      ' data-daily-losses="' + (inst.daily_losses||0) + '">';

    // Status cell
    html += '<td>';
    if (!inst.enabled) html += '<span class="status-dot status-unknown"></span><span class="no-data">Disabled</span>';
    else if (inst.service_status === 'SERVICE_RUNNING' && inst.heartbeat_ok) html += '<span class="status-dot status-running"></span>Running';
    else if (inst.service_status === 'SERVICE_RUNNING' && !inst.heartbeat_ok && inst.has_health) html += '<span class="status-dot status-stale"></span>Stale';
    else if (inst.service_status === 'SERVICE_STOPPED') html += '<span class="status-dot status-stopped"></span>Stopped';
    else if (inst.service_status === 'not_installed') html += '<span class="status-dot status-unknown"></span>Not installed';
    else html += '<span class="status-dot status-unknown"></span>' + esc(inst.service_status || 'Unknown');
    html += '</td>';

    // Strategy cell
    var badgeHtml = tag ? '<span class="strat-badge strat-' + esc(tag) + '">' + esc(tag.toUpperCase()) + '</span>' : '';
    html += '<td class="strategy-cell"><div class="strategy-name">' + badgeHtml + esc(inst.strategy_display || inst.strategy) + '</div>';
    html += '<div class="strategy-pair">' + esc(inst.pair) + ' <span class="tf-badge">' + esc(inst.timeframe) + '</span></div>';
    if (inst.auto_comment) html += '<div class="strategy-comment">' + esc(inst.auto_comment) + '</div>';
    else if (inst.description) html += '<div class="strategy-comment">' + esc(inst.description) + '</div>';
    html += '</td>';

    // Heartbeat
    html += '<td class="hide-mobile">';
    if (inst.heartbeat_ok) html += '<span style="color:var(--green)">' + esc(inst.heartbeat_display) + '</span>';
    else if (inst.has_health) html += '<span style="color:var(--yellow)">' + esc(inst.heartbeat_display) + '</span>';
    else html += '<span class="no-data">N/A</span>';
    html += '</td>';

    // Positions
    html += '<td class="hide-mobile">' + (inst.has_health ? inst.positions : '-') + '</td>';

    // P&L
    html += '<td class="pnl-cell">';
    if (inst.daily_pnl !== 0) html += '<span class="' + (inst.daily_pnl > 0 ? 'positive' : 'negative') + '">' + (inst.daily_pnl > 0 ? '+' : '') + inst.daily_pnl.toFixed(2) + '</span>';
    else html += '<span class="no-data">0.00</span>';
    html += '</td>';

    // W/L
    html += '<td class="pnl-cell">';
    if (inst.daily_trades > 0) html += '<span class="positive">' + inst.daily_wins + '</span> / <span class="negative">' + inst.daily_losses + '</span>';
    else html += '<span class="no-data">- / -</span>';
    html += '</td>';

    // Actions
    html += '<td class="hide-mobile">';
    if (inst.enabled) {
      html += '<button class="svc-btn start" onclick="dServiceAction(\'' + esc(inst.id) + '\',\'start\')" title="Start">St</button>';
      html += '<button class="svc-btn restart" onclick="dServiceAction(\'' + esc(inst.id) + '\',\'restart\')" title="Restart">Re</button>';
      html += '<button class="svc-btn stop" onclick="dServiceAction(\'' + esc(inst.id) + '\',\'stop\')" title="Stop">Sp</button>';
      html += '<button class="toggle-btn" onclick="dTogglePerf(\'' + esc(inst.id) + '\')" title="Performance">Perf</button>';
      html += '<button class="toggle-btn" onclick="dToggleTrades(\'' + esc(inst.id) + '\')" title="Trades">Trades</button>';
    }
    html += '</td></tr>';

    // Perf panel row
    html += '<tr class="panel-row" data-parent="' + esc(inst.id) + '"><td colspan="7" style="padding:0;border:none"><div class="perf-panel" id="perf-' + esc(inst.id) + '"><div class="perf-header"><span class="perf-title">Performance vs Backtest</span>';
    html += '<a class="export-btn" href="/api/vps/export/' + encodeURIComponent(inst.id) + '" title="Download CSV">Export CSV</a></div>';
    html += '<div id="perf-content-' + esc(inst.id) + '"><span class="no-data">Click Perf to load...</span></div></div></td></tr>';

    // Trades panel row
    html += '<tr class="panel-row" data-parent="' + esc(inst.id) + '"><td colspan="7" style="padding:0;border:none"><div class="trades-panel" id="trades-' + esc(inst.id) + '"><div class="perf-header"><span class="perf-title">Recent Trades</span></div>';
    html += '<div id="trades-content-' + esc(inst.id) + '"><span class="no-data">Click Trades to load...</span></div></div></td></tr>';
  });
  tbody.innerHTML = html;
  dApplySortAndFilter();
}

function getStratTag(id) {
  if (!id) return '';
  if (id.startsWith('rsi_')) return 'mean-rev';
  if (id.startsWith('ema_')) return 'trend';
  if (id.startsWith('bbsq_')) return 'volatility';
  if (id.startsWith('dch_')) return 'trend';
  if (id.startsWith('ldn_')) return 'session';
  if (id.startsWith('stadx_')) return 'momentum';
  if (id.startsWith('fpma_') || id.startsWith('fair_price')) return 'value';
  return '';
}

function getDFilterGroup(id) {
  if (!id) return 'OTHER';
  if (id.startsWith('rsi_')) return 'RSI';
  if (id.startsWith('ema_')) return 'EMA';
  if (id.startsWith('bbsq_')) return 'BBSQ';
  if (id.startsWith('dch_')) return 'DCH';
  if (id.startsWith('ldn_')) return 'LDN';
  if (id.startsWith('stadx_')) return 'STADX';
  if (id.startsWith('fpma_') || id.startsWith('fair_price')) return 'FPMA';
  return 'OTHER';
}

// ── Overview Top/Bottom ──
function dashUpdateOverviewTopBottom(instances) {
  var sorted = instances.slice().sort(function(a, b) { return b.daily_pnl - a.daily_pnl; });
  var top5 = sorted.slice(0, 5);
  var bottom5 = sorted.slice(-5).reverse();
  var combined = top5.concat([null], bottom5);
  var tbody = document.getElementById('overview-top-bottom');
  var html = '';
  combined.forEach(function(inst) {
    if (inst === null) { html += '<tr><td colspan="5" style="padding:4px;border:none;background:var(--bg-primary)"></td></tr>'; return; }
    var pnlCls = inst.daily_pnl > 0 ? 'positive' : inst.daily_pnl < 0 ? 'negative' : '';
    var totalPnl = (inst.live_performance && inst.live_performance.total_pnl) || 0;
    var totalCls = totalPnl > 0 ? 'positive' : totalPnl < 0 ? 'negative' : '';
    var statusHtml = '';
    if (inst.service_status === 'SERVICE_RUNNING' && inst.heartbeat_ok) statusHtml = '<span class="status-dot status-running"></span>';
    else if (inst.service_status === 'SERVICE_STOPPED') statusHtml = '<span class="status-dot status-stopped"></span>';
    else statusHtml = '<span class="status-dot status-unknown"></span>';
    html += '<tr><td>' + statusHtml + '</td>';
    html += '<td class="strategy-cell"><div class="strategy-name" style="font-size:0.78rem">' + esc((inst.strategy_display || inst.strategy) + ' / ' + inst.pair) + '</div></td>';
    html += '<td class="pnl-cell"><span class="' + pnlCls + '">' + (inst.daily_pnl > 0 ? '+' : '') + (inst.daily_pnl||0).toFixed(2) + '</span></td>';
    html += '<td class="pnl-cell"><span class="' + totalCls + '">' + (totalPnl > 0 ? '+' : '') + totalPnl.toFixed(2) + '</span></td>';
    html += '<td class="pnl-cell">' + (inst.daily_trades > 0 ? '<span class="positive">' + inst.daily_wins + '</span> / <span class="negative">' + inst.daily_losses + '</span>' : '<span class="no-data">-</span>') + '</td></tr>';
  });
  tbody.innerHTML = html;
}

// ── Table sorting ──
function dSortTable(col) {
  if (dCurrentSort.col === col) dCurrentSort.dir = dCurrentSort.dir === 'asc' ? 'desc' : 'asc';
  else { dCurrentSort.col = col; dCurrentSort.dir = col === 'pnl' ? 'desc' : 'asc'; }
  document.querySelectorAll('#d-main-table th').forEach(function(h) {
    h.classList.remove('sort-active');
    var arrow = h.querySelector('.sort-arrow');
    if (arrow) arrow.innerHTML = '&#9650;';
  });
  var th = document.querySelector('#d-main-table th[data-dsort="' + col + '"]');
  if (th) { th.classList.add('sort-active'); var arrow = th.querySelector('.sort-arrow'); if (arrow) arrow.innerHTML = dCurrentSort.dir === 'asc' ? '&#9650;' : '&#9660;'; }
  dApplySortAndFilter();
}

function dApplySortAndFilter() {
  var tbody = document.getElementById('d-instances-body');
  var rows = Array.from(tbody.querySelectorAll('tr.instance-row'));
  var panelRows = {};
  tbody.querySelectorAll('tr.panel-row').forEach(function(pr) {
    var pid = pr.dataset.parent;
    if (!panelRows[pid]) panelRows[pid] = [];
    panelRows[pid].push(pr);
  });
  rows.sort(function(a, b) {
    var va, vb;
    switch (dCurrentSort.col) {
      case 'pnl': va = parseFloat(a.dataset.pnl) || 0; vb = parseFloat(b.dataset.pnl) || 0; break;
      case 'strategy':
        va = (a.dataset.strategy + a.dataset.pair).toLowerCase();
        vb = (b.dataset.strategy + b.dataset.pair).toLowerCase();
        return dCurrentSort.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      case 'status': va = a.dataset.status || ''; vb = b.dataset.status || ''; return dCurrentSort.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      case 'heartbeat': va = parseFloat(a.dataset.heartbeat) || 99999; vb = parseFloat(b.dataset.heartbeat) || 99999; break;
      case 'pos': va = parseInt(a.querySelector('td:nth-child(4)').textContent) || 0; vb = parseInt(b.querySelector('td:nth-child(4)').textContent) || 0; break;
      case 'wl': va = parseInt(a.dataset.dailyWins) || 0; vb = parseInt(b.dataset.dailyWins) || 0; break;
      default: va = 0; vb = 0;
    }
    return dCurrentSort.dir === 'asc' ? va - vb : vb - va;
  });
  rows.forEach(function(row) {
    tbody.appendChild(row);
    var id = row.dataset.id;
    if (panelRows[id]) panelRows[id].forEach(function(pr) { tbody.appendChild(pr); });
  });
  dFilterTable();
}

// ── Filtering ──
function setDGroupFilter(group) {
  dCurrentGroupFilter = group;
  document.querySelectorAll('.d-filter-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.dfilter === group); });
  dFilterTable();
}

function dFilterTable() {
  var search = (document.getElementById('d-search-input').value || '').toLowerCase();
  document.querySelectorAll('#d-instances-body tr.instance-row').forEach(function(row) {
    var id = row.dataset.id;
    var strat = (row.dataset.strategy || '').toLowerCase();
    var pair = (row.dataset.pair || '').toLowerCase();
    var group = getDFilterGroup(id);
    var matchesSearch = !search || strat.indexOf(search) >= 0 || pair.indexOf(search) >= 0 || id.toLowerCase().indexOf(search) >= 0;
    var matchesGroup = dCurrentGroupFilter === 'ALL' || group === dCurrentGroupFilter;
    row.classList.toggle('hidden-filter', !(matchesSearch && matchesGroup));
    document.querySelectorAll('tr.panel-row[data-parent="' + id + '"]').forEach(function(pr) { pr.style.display = (matchesSearch && matchesGroup) ? '' : 'none'; });
  });
}

// ── Grouping ──
function dToggleGrouping() {
  dGroupingEnabled = !dGroupingEnabled;
  document.getElementById('d-group-toggle').classList.toggle('active', dGroupingEnabled);
  if (dGroupingEnabled) dInsertGroupHeaders(); else dRemoveGroupHeaders();
}
function dInsertGroupHeaders() {
  dRemoveGroupHeaders();
  var tbody = document.getElementById('d-instances-body');
  var rows = Array.from(tbody.querySelectorAll('tr.instance-row:not(.hidden-filter)'));
  var lastGroup = null;
  rows.forEach(function(row) {
    var group = getDFilterGroup(row.dataset.id);
    if (group !== lastGroup) {
      var groupRows = rows.filter(function(r) { return getDFilterGroup(r.dataset.id) === group; });
      var groupPnl = groupRows.reduce(function(s, r) { return s + (parseFloat(r.dataset.pnl) || 0); }, 0);
      var pnlCls = groupPnl > 0 ? 'positive' : groupPnl < 0 ? 'negative' : '';
      var header = document.createElement('tr');
      header.className = 'group-header-row';
      header.dataset.group = group;
      header.innerHTML = '<td colspan="7"><span class="group-chevron">&#9660;</span>' + esc(group) + ' (' + groupRows.length + ')<span class="group-pnl ' + pnlCls + '">' + (groupPnl >= 0 ? '+' : '') + groupPnl.toFixed(2) + '</span></td>';
      header.onclick = function() { dToggleGroup(group); };
      row.parentNode.insertBefore(header, row);
      lastGroup = group;
    }
  });
}
function dRemoveGroupHeaders() {
  document.querySelectorAll('.group-header-row').forEach(function(r) { r.remove(); });
  document.querySelectorAll('tr.instance-row.group-collapsed').forEach(function(r) { r.classList.remove('group-collapsed'); r.style.display = ''; });
}
function dToggleGroup(group) {
  var header = document.querySelector('.group-header-row[data-group="' + group + '"]');
  var chevron = header.querySelector('.group-chevron');
  var isCollapsed = chevron.classList.contains('collapsed');
  chevron.classList.toggle('collapsed');
  document.querySelectorAll('#d-instances-body tr.instance-row').forEach(function(row) {
    if (getDFilterGroup(row.dataset.id) === group) {
      row.style.display = isCollapsed ? '' : 'none';
      row.classList.toggle('group-collapsed', !isCollapsed);
      document.querySelectorAll('tr.panel-row[data-parent="' + row.dataset.id + '"]').forEach(function(pr) { pr.style.display = isCollapsed ? '' : 'none'; });
    }
  });
}

// ── Service actions ──
async function dServiceAction(instanceId, action) {
  if (!confirm(action.toUpperCase() + ' service "' + instanceId + '"?')) return;
  try {
    var r = await fetch('/api/vps/service/' + instanceId + '/' + action, { method: 'POST' });
    var d = await r.json();
    alert(d.message || (d.ok ? 'Done' : 'Failed'));
    setTimeout(dashRefreshStatus, 1500);
  } catch(e) { alert('Request failed: ' + e.message); }
}

// ── Perf / Trades panels ──
function dTogglePerf(instanceId) {
  var panel = document.getElementById('perf-' + instanceId);
  if (!panel) return;
  var wasOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  if (!wasOpen) dLoadPerf(instanceId);
}

function dLoadPerf(instanceId) {
  var content = document.getElementById('perf-content-' + instanceId);
  content.innerHTML = '<span class="no-data">Loading...</span>';
  fetch('/api/vps/performance/' + instanceId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.expected && !data.live) { content.innerHTML = '<span class="no-data">No expectations data</span>'; return; }
      var ex = data.expected || {};
      var lp = data.live || {};
      var html = '<div class="perf-grid">';
      function perfItem(name, expVal, liveVal) {
        html += '<div class="perf-item"><span class="perf-metric-name">' + name + '</span><div class="perf-values">';
        html += '<span class="perf-expected">exp ' + expVal + '</span>';
        html += '<span class="perf-live">' + liveVal + '</span></div></div>';
      }
      perfItem('Win Rate', ((ex.win_rate||0)*100).toFixed(1) + '%', lp.trades_total > 0 ? ((lp.win_rate||0)*100).toFixed(1) + '%' : 'No trades');
      perfItem('Profit Factor', (ex.profit_factor||0).toFixed(2), lp.trades_total > 0 ? (lp.profit_factor||0).toFixed(2) : '--');
      perfItem('Trades/Month', (ex.avg_trades_per_month||0).toFixed(1), lp.trades_per_month > 0 ? lp.trades_per_month.toFixed(1) : '--');
      perfItem('Sharpe', (ex.sharpe||0).toFixed(2), lp.trades_total >= 30 ? '--' : 'Need 30+ trades');
      perfItem('Max Drawdown', (ex.max_drawdown_pct||0).toFixed(1) + '%', lp.trades_total > 0 ? (lp.max_drawdown_pct||0).toFixed(1) + '%' : '--');
      perfItem('Total Trades', 'fwd ' + (ex.forward_trades||'?'), lp.trades_total || 0);
      html += '</div>';
      // Live vs backtest bar chart
      html += '<div class="perf-chart-wrap"><canvas id="perf-chart-' + instanceId + '"></canvas></div>';
      content.innerHTML = html;
      // Render chart
      setTimeout(function() { dRenderPerfChart(instanceId, data); }, 50);
    })
    .catch(function() { content.innerHTML = '<span class="no-data">Failed to load performance data</span>'; });
}

function dRenderPerfChart(instanceId, data) {
  var canvas = document.getElementById('perf-chart-' + instanceId);
  if (!canvas || !data.expected || !data.live) return;
  var metrics = ['win_rate', 'profit_factor', 'trades_per_month'];
  var metricLabels = ['Win Rate', 'Profit Factor', 'Trades/Mo'];
  var expected = metrics.map(function(m) { var key = m === 'trades_per_month' ? 'avg_trades_per_month' : m; return data.expected[key] || 0; });
  var actual = metrics.map(function(m) { return data.live[m] || 0; });
  var actualColors = metrics.map(function(_, i) { if (expected[i] === 0) return '#10b981'; return (actual[i] / expected[i]) < 0.75 ? '#ef4444' : '#10b981'; });
  if (perfCharts[instanceId]) perfCharts[instanceId].destroy();
  perfCharts[instanceId] = new Chart(canvas, {
    type: 'bar',
    data: { labels: metricLabels, datasets: [
      { label: 'Expected', data: expected, backgroundColor: 'rgba(90,106,128,0.3)', borderColor: '#5a6a80', borderWidth: 1, borderRadius: 3 },
      { label: 'Actual', data: actual, backgroundColor: actualColors, borderRadius: 3 }
    ]},
    options: { ...chartDefaults, plugins: { legend: { display: true, labels: { color: '#8896ab', font: { family: 'Inter', size: 11 } } } },
      scales: { x: { grid: { display: false }, ticks: { color: '#8896ab', font: { family: 'Inter', size: 11 } } }, y: { grid: { color: 'rgba(30,41,59,0.5)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 10 } } } }
    }
  });
}

function dToggleTrades(instanceId) {
  var panel = document.getElementById('trades-' + instanceId);
  if (!panel) return;
  var wasOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  if (!wasOpen) dLoadTrades(instanceId);
}

function dLoadTrades(instanceId) {
  var content = document.getElementById('trades-content-' + instanceId);
  content.innerHTML = '<span class="no-data">Loading...</span>';
  fetch('/api/vps/trades/' + instanceId + '?limit=30')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var trades = data.trades || [];
      if (!trades.length) { content.innerHTML = '<span class="no-data">No closed trades yet</span>'; return; }
      var html = '<table class="trades-table"><thead><tr><th>Time</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Reason</th><th style="text-align:right">P&L</th></tr></thead><tbody>';
      trades.forEach(function(t) {
        var pnl = t.realized_pnl || 0;
        var cls = pnl >= 0 ? 'positive' : 'negative';
        var exitTime = t.exit_time ? t.exit_time.substring(0, 16).replace('T', ' ') : '--';
        html += '<tr><td style="font-family:JetBrains Mono,monospace">' + esc(exitTime) + '</td>';
        html += '<td>' + esc(t.direction || '--') + '</td>';
        html += '<td>' + (t.entry_price ? parseFloat(t.entry_price).toFixed(5) : '--') + '</td>';
        html += '<td>' + (t.exit_price ? parseFloat(t.exit_price).toFixed(5) : '--') + '</td>';
        html += '<td style="font-family:Inter,sans-serif">' + esc(t.exit_reason || '--') + '</td>';
        html += '<td class="pnl-cell ' + cls + '">' + (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + '</td></tr>';
      });
      html += '</tbody></table>';
      content.innerHTML = html;
    })
    .catch(function() { content.innerHTML = '<span class="no-data">Failed to load trades</span>'; });
}

// ── Charts ──
function dashRefreshCharts(days) {
  fetch('/api/vps/portfolio-history?days=' + (days || 30))
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var history = data.history || [];
      dashRenderEquityChart(history);
      dashRenderDailyPnlChart(history);
      dashRenderSparkline(history.slice(-7));
    })
    .catch(function(err) { console.error('Chart data failed:', err); });
}

function setDashRange(days) {
  document.querySelectorAll('.range-btn').forEach(function(b) { b.classList.remove('active'); });
  event.target.classList.add('active');
  dashRefreshCharts(days || 365);
}

function dashRenderEquityChart(history) {
  var ctx = document.getElementById('chart-equity');
  if (!ctx || !history.length) return;
  var labels = history.map(function(h) { return h.date.substring(5); });
  var data = history.map(function(h) { return h.cumulative_pnl; });
  if (equityChart) equityChart.destroy();
  equityChart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [{ data: data, borderColor: '#10b981', borderWidth: 2, fill: true, backgroundColor: 'rgba(16,185,129,0.08)', tension: 0.3, pointRadius: 0, pointHitRadius: 8 }] },
    options: { ...chartDefaults, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111827', borderColor: '#2a3a52', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 11 }, callbacks: { label: function(ctx) { return 'P&L: ' + ctx.parsed.y.toFixed(2); } } } } }
  });
}

function dashRenderDailyPnlChart(history) {
  var ctx = document.getElementById('chart-daily-pnl');
  if (!ctx || !history.length) return;
  var labels = history.map(function(h) { return h.date.substring(5); });
  var data = history.map(function(h) { return h.pnl; });
  var colors = data.map(function(v) { return v >= 0 ? '#10b981' : '#ef4444'; });
  if (dailyPnlChart) dailyPnlChart.destroy();
  dailyPnlChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderRadius: 2 }] },
    options: { ...chartDefaults, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111827', borderColor: '#2a3a52', borderWidth: 1, bodyFont: { family: 'JetBrains Mono', size: 11 }, callbacks: { label: function(ctx) { return 'P&L: ' + ctx.parsed.y.toFixed(2); } } } } }
  });
}

function dashRenderSparkline(history) {
  var ctx = document.getElementById('sparkline-pnl');
  if (!ctx || !history.length) return;
  var data = history.map(function(h) { return h.pnl; });
  var trend = data.length >= 2 && data[data.length - 1] >= data[0];
  var color = trend ? '#10b981' : '#ef4444';
  if (sparklineChart) sparklineChart.destroy();
  sparklineChart = new Chart(ctx, {
    type: 'line',
    data: { labels: data.map(function() { return ''; }), datasets: [{ data: data, borderColor: color, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
  });
}

function dashRenderStrategyRankChart() {
  if (!dCachedInstances.length) return;
  var ctx = document.getElementById('chart-strategy-rank');
  if (!ctx) return;
  var tagColors = { 'mean-rev': '#8b5cf6', 'trend': '#06b6d4', 'value': '#10b981', 'momentum': '#f59e0b', 'volatility': '#f59e0b', 'session': '#06b6d4', 'other': '#5a6a80' };
  var withPnl = dCachedInstances.filter(function(i) { return i.live_performance && i.live_performance.total_pnl !== 0; })
    .map(function(i) { return { label: (i.strategy_display || i.strategy) + ' / ' + i.pair, pnl: i.live_performance.total_pnl, tag: i.strategy_tag || getStratTag(i.id) || 'other' }; })
    .sort(function(a, b) { return b.pnl - a.pnl; });
  var top10 = withPnl.slice(0, 10);
  var bottom10 = withPnl.slice(-10).reverse();
  var combined = top10.concat(bottom10.filter(function(b) { return top10.indexOf(b) < 0; }));
  if (!combined.length) { if (strategyRankChart) strategyRankChart.destroy(); return; }
  if (strategyRankChart) strategyRankChart.destroy();
  strategyRankChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: combined.map(function(c) { return c.label; }), datasets: [{ data: combined.map(function(c) { return c.pnl; }), backgroundColor: combined.map(function(c) { return c.pnl >= 0 ? (tagColors[c.tag] || '#10b981') : '#ef4444'; }), borderRadius: 3 }] },
    options: { ...chartDefaults, indexAxis: 'y', scales: { x: { grid: { color: 'rgba(30,41,59,0.5)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 10 } } }, y: { grid: { display: false }, ticks: { color: '#8896ab', font: { family: 'Inter', size: 11 }, mirror: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111827', borderColor: '#2a3a52', borderWidth: 1, bodyFont: { family: 'JetBrains Mono', size: 11 }, callbacks: { label: function(ctx) { return 'Total P&L: ' + ctx.parsed.x.toFixed(2); } } } } }
  });
}

// ── Insights ──
function dashRefreshInsights() {
  fetch('/api/vps/insights')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      dashRenderBestWorst(data);
      dashRenderAlerts(data);
      dashRenderFrequency(data);
      dashRenderHeatmap(data);
      dashRenderAlertsTab(data);
    })
    .catch(function(err) { console.error('Insights failed:', err); });
}

function dashRenderBestWorst(data) {
  var el = document.getElementById('insight-best-worst');
  var html = '';
  if (data.best_today && data.best_today.length) data.best_today.forEach(function(b) { html += '<div class="insight-item"><span class="insight-label">' + esc(b.strategy || b.id) + '</span><span class="insight-value positive">+' + b.pnl.toFixed(2) + '</span></div>'; });
  if (data.worst_today && data.worst_today.length) data.worst_today.forEach(function(w) { html += '<div class="insight-item"><span class="insight-label">' + esc(w.strategy || w.id) + '</span><span class="insight-value negative">' + w.pnl.toFixed(2) + '</span></div>'; });
  el.innerHTML = html || '<span class="no-data">No P&L data today</span>';
}

function dashRenderAlerts(data) {
  var el = document.getElementById('insight-alerts');
  var html = '';
  if (data.streak_alerts && data.streak_alerts.length) data.streak_alerts.forEach(function(a) { html += '<div class="insight-item"><span class="insight-label">' + esc(a.id) + '</span><span class="alert-badge">' + a.count + ' losses in a row</span></div>'; });
  if (data.dd_alerts && data.dd_alerts.length) data.dd_alerts.forEach(function(a) { html += '<div class="insight-item"><span class="insight-label">' + esc(a.strategy || a.id) + '</span><span class="alert-badge">DD ' + a.live_dd + '% (exp ' + a.expected_dd + '%)</span></div>'; });
  el.innerHTML = html || '<span class="no-data">No alerts</span>';
}

function dashRenderFrequency(data) {
  var el = document.getElementById('insight-frequency');
  var html = '';
  if (data.frequency_alerts && data.frequency_alerts.length) data.frequency_alerts.forEach(function(f) { html += '<div class="insight-item"><span class="insight-label">' + esc(f.strategy || f.id) + ' ' + (f.pair || '') + '</span><span class="insight-value warning-text">' + f.actual + '/mo (exp ' + f.expected + ')</span></div>'; });
  el.innerHTML = html || '<span class="no-data">All within expected range</span>';
}

function dashRenderHeatmap(data) {
  var el = document.getElementById('insight-heatmap');
  if (!data.pair_pnl || Object.keys(data.pair_pnl).length === 0) { el.innerHTML = '<span class="no-data">No pair data</span>'; return; }
  var values = Object.values(data.pair_pnl);
  var maxAbs = Math.max.apply(null, values.map(Math.abs).concat([0.01]));
  var html = '';
  Object.entries(data.pair_pnl).forEach(function(entry) {
    var pair = entry[0], pnl = entry[1];
    var intensity = Math.min(Math.abs(pnl) / maxAbs, 1);
    var bg;
    if (pnl > 0) bg = 'rgba(16, 185, 129, ' + (0.1 + intensity * 0.5) + ')';
    else if (pnl < 0) bg = 'rgba(239, 68, 68, ' + (0.1 + intensity * 0.5) + ')';
    else bg = 'rgba(90, 106, 128, 0.1)';
    var cls = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : '';
    html += '<div class="pair-cell" style="background:' + bg + '"><div style="font-size:0.6rem;color:var(--text-muted)">' + pair.replace('_', '/') + '</div><div class="' + cls + '">' + (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + '</div></div>';
  });
  el.innerHTML = html;
}

function dashRenderAlertsTab(data) {
  var errEl = document.getElementById('alerts-errors');
  var errorList = document.getElementById('error-list');
  if (errorList) errEl.innerHTML = errorList.innerHTML;
  var streakEl = document.getElementById('alerts-streaks');
  if (data.streak_alerts && data.streak_alerts.length) streakEl.innerHTML = data.streak_alerts.map(function(a) { return '<div class="insight-item"><span class="insight-label">' + esc(a.id) + '</span><span class="alert-badge">' + a.count + ' consecutive losses</span></div>'; }).join('');
  else streakEl.innerHTML = '<span class="no-data">No losing streaks detected (3+ threshold)</span>';
  var ddEl = document.getElementById('alerts-dd');
  if (data.dd_alerts && data.dd_alerts.length) ddEl.innerHTML = data.dd_alerts.map(function(a) { return '<div class="insight-item"><span class="insight-label">' + esc(a.strategy || a.id) + ' ' + (a.pair || '') + '</span><span class="alert-badge">Live DD: ' + a.live_dd + '% vs Expected: ' + a.expected_dd + '%</span></div>'; }).join('');
  else ddEl.innerHTML = '<span class="no-data">All drawdowns within expected bounds</span>';
  var freqEl = document.getElementById('alerts-freq');
  if (data.frequency_alerts && data.frequency_alerts.length) freqEl.innerHTML = data.frequency_alerts.map(function(f) { return '<div class="insight-item"><span class="insight-label">' + esc(f.strategy || f.id) + ' ' + (f.pair || '') + '</span><span class="insight-value warning-text">' + f.actual + ' trades/mo (expected ' + f.expected + ')</span></div>'; }).join('');
  else freqEl.innerHTML = '<span class="no-data">All trading at expected frequency</span>';
}

// ── Scan ──
function dashRefreshScan() {
  fetch('/api/vps/scan')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var section = document.getElementById('scan-section');
      if (data.status === 'no_scan') { section.style.display = 'none'; return; }
      section.style.display = 'block';
      document.getElementById('scan-phase').textContent = data.phase || '--';
      document.getElementById('scan-strategy').textContent = data.strategy || '--';
      var total = data.total_combos || 0, done = data.completed || 0;
      document.getElementById('scan-progress').textContent = done + '/' + total;
      document.getElementById('scan-bar').style.width = (total > 0 ? (done / total * 100) : 0) + '%';
      var results = (data.results || []).slice().sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
      document.getElementById('scan-green').textContent = results.filter(function(r) { return r.rating === 'GREEN'; }).length;
      var tbody = document.getElementById('scan-body');
      tbody.innerHTML = results.map(function(r, i) {
        var rc = r.rating === 'GREEN' ? 'var(--green)' : r.rating === 'YELLOW' ? 'var(--yellow)' : 'var(--red)';
        return '<tr><td>' + (i + 1) + '</td><td style="font-weight:500">' + esc(r.pair || '') + '</td><td style="color:var(--text-muted)">' + esc(r.timeframe || '') + '</td>' +
          '<td style="text-align:right">' + (r.score || 0).toFixed(1) + '</td><td style="color:' + rc + ';font-weight:600">' + esc(r.rating || '--') + '</td>' +
          '<td style="text-align:right">' + ((r.wf_pass_rate || 0) * 100).toFixed(0) + '%</td><td style="text-align:right">' + (r.sharpe || 0).toFixed(2) + '</td>' +
          '<td style="text-align:right">' + ((r.stability || 0) * 100).toFixed(1) + '%</td><td style="text-align:right">' + (r.elapsed_minutes || 0).toFixed(0) + 'm</td></tr>';
      }).join('');
    })
    .catch(function() {});
}

// ── Dashboard lifecycle ──
var dashRefreshTimer = null;
function startDash() {
  dashRefreshStatus();
  dashRefreshCharts(30);
  dashRefreshInsights();
  dashRefreshScan();
  setTimeout(function() { dashRenderStrategyRankChart(); }, 500);
  if (dashRefreshTimer) clearInterval(dashRefreshTimer);
  dashRefreshTimer = setInterval(function() { dashRefreshStatus(); dashRefreshInsights(); dashRefreshScan(); }, DASH_REFRESH_SECONDS * 1000);
}
function stopDash() { if (dashRefreshTimer) { clearInterval(dashRefreshTimer); dashRefreshTimer = null; } }

// ═══════════════════════════════════════
// LEADERBOARD
// ═══════════════════════════════════════
async function loadLeaderboard() {
  try {
    var r = await fetch('/data/leaderboard.json');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var ct = r.headers.get('content-type') || '';
    if (ct.indexOf('json') === -1) throw new Error('leaderboard.json not found (run build_web.py to generate)');
    lbData = await r.json();
    lbLoaded = true;
    buildLB();
  } catch(e) {
    document.getElementById('lb-body').innerHTML = '<tr><td colspan="19" class="text-red" style="text-align:center;padding:2rem">Failed to load: '+esc(e.message)+'</td></tr>';
  }
}

function buildLB() {
  var runs = lbData.runs;
  var compare = lbData.compare || {};

  // Summary strip
  var total = runs.length;
  var green = runs.filter(function(r) { return r.rating === 'GREEN'; }).length;
  var yellow = runs.filter(function(r) { return r.rating === 'YELLOW' && r.score > 0; }).length;
  var red = runs.filter(function(r) { return r.status === 'COMPLETE' && r.score === 0; }).length;
  var failed = runs.filter(function(r) { return r.status === 'FAILED'; }).length;
  var partial = runs.filter(function(r) { return r.status === 'PARTIAL'; }).length;
  var best = runs.reduce(function(a, b) { return (a.score||0) > (b.score||0) ? a : b; }, {});
  var bestStr = best.score > 0 ? best.pair + ' ' + best.timeframe + ' - ' + best.score.toFixed(0) : 'None';

  document.getElementById('lb-subtitle').textContent = total + ' pipeline runs \u00B7 Data: ' + (lbData.generated_at || '');

  document.getElementById('lb-summary').innerHTML =
    '<div class="summary-item"><div class="summary-num">'+total+'</div><div class="summary-label">Total Runs</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#10b981">'+green+'</div><div class="summary-label">Green</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#f59e0b">'+yellow+'</div><div class="summary-label">Yellow</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#ef4444">'+(red+failed)+'</div><div class="summary-label">Red/Failed</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#5a6a80">'+partial+'</div><div class="summary-label">Partial</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#3b82f6">'+bestStr+'</div><div class="summary-label">Best Run</div></div>';

  // Filters
  var pairs = []; var tfs = [];
  runs.forEach(function(r) { if (pairs.indexOf(r.pair) === -1) pairs.push(r.pair); if (tfs.indexOf(r.timeframe) === -1) tfs.push(r.timeframe); });
  pairs.sort(); tfs.sort();

  var fbar = document.getElementById('lb-filters');
  fbar.innerHTML = '';

  function addFilterGroup(label, filterKey, values) {
    var g = document.createElement('div'); g.className = 'filter-group';
    g.innerHTML = '<span class="filter-label">'+label+'</span>';
    var allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active'; allBtn.textContent = 'All';
    allBtn.dataset.filter = filterKey; allBtn.dataset.value = 'ALL';
    g.appendChild(allBtn);
    values.forEach(function(v) {
      var b = document.createElement('button'); b.className = 'filter-btn';
      b.textContent = v; b.dataset.filter = filterKey; b.dataset.value = v;
      g.appendChild(b);
    });
    fbar.appendChild(g);
  }

  addFilterGroup('Pair', 'pair', pairs);
  addFilterGroup('TF', 'tf', tfs);
  addFilterGroup('Rating', 'rating', ['GREEN', 'YELLOW', 'RED']);
  addFilterGroup('Status', 'status', ['COMPLETE', 'PARTIAL', 'FAILED']);

  // Bind filter clicks
  fbar.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      btn.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      activeFilters[btn.dataset.filter] = btn.dataset.value;
      applyFilters();
    });
  });

  // Build rows
  var tbody = document.getElementById('lb-body');
  tbody.innerHTML = runs.map(function(r) {
    var ratingBg, ratingFg;
    if (r.rating === 'GREEN') { ratingBg = '#065f46'; ratingFg = '#10b981'; }
    else if (r.rating === 'YELLOW') { ratingBg = '#78350f'; ratingFg = '#f59e0b'; }
    else { ratingBg = '#7f1d1d'; ratingFg = '#ef4444'; }

    var statusHtml;
    if (r.status === 'FAILED') statusHtml = '<span style="color:#ef4444">FAILED</span>';
    else if (r.status === 'PARTIAL') statusHtml = '<span style="color:#5a6a80">'+r.stages_done+'/7</span>';
    else statusHtml = '<span style="color:#10b981">OK</span>';

    var scoreDisplay = r.score > 0 ? r.score.toFixed(0) : '-';
    var hasCompare = !!compare[r.run_id];
    var cbDisabled = hasCompare ? '' : ' disabled';
    var cbOpacity = hasCompare ? '' : ' style="opacity:0.3"';
    var descEsc = esc(r.description || '');
    var np = r.net_profit;
    var npColor = np > 0 ? '#10b981' : (np != null ? '#ef4444' : '#5a6a80');
    var npStr = np != null ? '$' + np.toLocaleString(undefined, {maximumFractionDigits:0}) : '-';
    var fb = r.forward_back_ratio;

    return '<tr data-pair="'+r.pair+'" data-tf="'+r.timeframe+'" data-strategy="'+r.strategy+'" data-status="'+r.status+'" data-rating="'+r.rating+'" data-run="'+r.run_id+'" onclick="showRunDetail(\''+r.run_id+'\')">' +
      '<td'+cbOpacity+' onclick="event.stopPropagation()"><input type="checkbox" class="compare-check" data-run="'+r.run_id+'"'+cbDisabled+'></td>' +
      '<td>'+esc(r.pair)+'</td>' +
      '<td>'+esc(r.timeframe)+'</td>' +
      '<td class="strategy-col">'+esc(r.strategy)+'</td>' +
      '<td class="desc-col" title="'+descEsc+'">'+descEsc+'</td>' +
      '<td class="score-col" style="color:'+ratingFg+'"><strong>'+scoreDisplay+'</strong></td>' +
      '<td><span style="background:'+ratingBg+';color:'+ratingFg+';padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">'+r.rating+'</span></td>' +
      '<td>'+statusHtml+'</td>' +
      '<td>'+(r.created||'').substring(0,19)+'</td>' +
      '<td style="color:'+npColor+'">'+npStr+'</td>' +
      '<td>'+(r.back_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.forward_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.back_trades||0)+'</td>' +
      '<td>'+(r.forward_trades||0)+'</td>' +
      '<td>'+(r.back_max_dd||0).toFixed(1)+'%</td>' +
      '<td>'+(fb||0).toFixed(2)+'</td>' +
      '<td>'+((r.win_rate||0)*100).toFixed(0)+'%</td>' +
      '<td>'+(r.total_time_min||0).toFixed(1)+'m</td>' +
      '<td class="runid-col"><a onclick="event.stopPropagation();showRunDetail(\''+r.run_id+'\')">'+esc(r.run_id)+'</a></td>' +
    '</tr>';
  }).join('');

  // Footer
  document.getElementById('lb-footer').textContent = 'OANDA Trading System \u00B7 ' + total + ' pipeline runs \u00B7 Generated ' + (lbData.generated_at || '');

  // Bind checkboxes
  document.querySelectorAll('.compare-check').forEach(function(cb) {
    cb.addEventListener('change', updateToolbar);
  });

  // Default sort by score descending
  var scoreHeader = document.querySelector('#leaderboard th[data-col="5"]');
  if (scoreHeader) scoreHeader.click();
}

// ── Sorting ──
var currentSort = { col: -1, dir: 'desc' };
document.querySelectorAll('#leaderboard th[data-col]').forEach(function(th) {
  th.addEventListener('click', function() {
    var col = parseInt(th.dataset.col);
    var dir = (currentSort.col === col && currentSort.dir === 'desc') ? 'asc' : 'desc';
    currentSort = { col: col, dir: dir };

    document.querySelectorAll('#leaderboard th').forEach(function(h) { h.classList.remove('sort-asc', 'sort-desc'); });
    th.classList.add('sort-' + dir);

    var tbody = document.querySelector('#leaderboard tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort(function(a, b) {
      var aText = a.cells[col] ? a.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';
      var bText = b.cells[col] ? b.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';

      if (/^\d{4}-\d{2}-\d{2}T/.test(aText) && /^\d{4}-\d{2}-\d{2}T/.test(bText)) {
        return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
      }

      var aNum = parseFloat(aText);
      var bNum = parseFloat(bText);
      if (!isNaN(aNum) && !isNaN(bNum)) return dir === 'asc' ? aNum - bNum : bNum - aNum;
      return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
    });

    rows.forEach(function(r) { tbody.appendChild(r); });
  });
});

// ── Filtering ──
var activeFilters = { pair: 'ALL', tf: 'ALL', rating: 'ALL', status: 'ALL' };

function applyFilters() {
  var rows = document.querySelectorAll('#leaderboard tbody tr');
  rows.forEach(function(row) {
    if (!row.dataset.pair) return;
    var show = true;
    if (activeFilters.pair !== 'ALL' && row.dataset.pair !== activeFilters.pair) show = false;
    if (activeFilters.tf !== 'ALL' && row.dataset.tf !== activeFilters.tf) show = false;
    if (activeFilters.rating !== 'ALL' && row.dataset.rating !== activeFilters.rating) show = false;
    if (activeFilters.status !== 'ALL' && row.dataset.status !== activeFilters.status) show = false;
    row.classList.toggle('hidden', !show);
  });
}

// ── Comparison ──
function updateToolbar() {
  var n = document.querySelectorAll('.compare-check:checked').length;
  document.getElementById('compare-count').textContent = n;
  document.getElementById('compare-toolbar').classList.toggle('visible', n >= 2);
}

function clearSelection() {
  document.querySelectorAll('.compare-check:checked').forEach(function(cb) { cb.checked = false; });
  updateToolbar();
}

function closeComparison() {
  document.getElementById('compare-section').classList.remove('visible');
}

function runComparison() {
  var checked = document.querySelectorAll('.compare-check:checked');
  var runIds = Array.from(checked).map(function(cb) { return cb.dataset.run; });
  if (runIds.length < 2) return;

  var section = document.getElementById('compare-section');
  section.classList.add('visible');

  var compare = lbData.compare || {};
  var allData = [];
  for (var i = 0; i < runIds.length && i < 6; i++) {
    var d = compare[runIds[i]];
    if (d) allData.push({ runId: runIds[i], data: d });
  }

  if (allData.length < 2) {
    document.getElementById('compare-chart').innerHTML = '<div style="text-align:center;padding:40px;color:#5a6a80">Not enough runs with equity data (need 2+).</div>';
    document.getElementById('compare-metrics').innerHTML = '';
    return;
  }

  buildEquityOverlay(document.getElementById('compare-chart'), allData);
  buildMetricsTable(document.getElementById('compare-metrics'), allData);
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function buildEquityOverlay(chartDiv, allData) {
  var traces = [], annotations = [], shapes = [];

  for (var i = 0; i < allData.length; i++) {
    var d = allData[i].data;
    var color = COLORS[i % COLORS.length];
    var meta = d.meta || {};
    var score = (d.decision || {}).score || 0;
    var backR2 = d.back_r_squared || 0;
    var fwdR2 = d.forward_r_squared || 0;
    var label = (meta.strategy || allData[i].runId) + ' (' + score.toFixed(0) + ')';
    var backEq = d.back_equity || [];
    var fwdEq = d.forward_equity || [];
    var initCap = d.initial_capital || 10000;

    if (backEq.length > 0) {
      var bx = backEq.map(function(p) { return p.timestamp; });
      var by = backEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: bx, y: by, type: 'scatter', mode: 'lines',
        name: label + ' Back R\u00B2=' + backR2.toFixed(3),
        line: { color: color, width: 2 }, legendgroup: 'run'+i,
      });
      if (fwdEq.length > 0) {
        shapes.push({ type:'line', x0:bx[bx.length-1], x1:bx[bx.length-1], y0:0, y1:1, yref:'paper', line:{color:color,width:1,dash:'dot'}, opacity:0.4 });
      }
    }

    if (fwdEq.length > 0) {
      var fx = fwdEq.map(function(p) { return p.timestamp; });
      var fy = fwdEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: fx, y: fy, type: 'scatter', mode: 'lines',
        name: label + ' Fwd R\u00B2=' + fwdR2.toFixed(3),
        line: { color: color, width: 2, dash: 'dash' }, legendgroup: 'run'+i,
      });
      annotations.push({
        x: fx[fx.length-1], y: fy[fy.length-1],
        text: 'R\u00B2=' + fwdR2.toFixed(3),
        showarrow: true, arrowhead: 0, arrowcolor: color,
        ax: 40, ay: -20 - (i * 18),
        font: { color: color, size: 11, family: 'JetBrains Mono, monospace' },
        bgcolor: 'rgba(10,14,26,0.8)', bordercolor: color, borderwidth: 1, borderpad: 3,
      });
    }
  }

  Plotly.newPlot(chartDiv, traces, mobileLayout({
    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
    font: { color: '#8896ab', family: 'Inter, system-ui, sans-serif', size: 12 },
    xaxis: { gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    yaxis: { title: 'Profit ($)', gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    margin: { l: 60, r: 30, t: 30, b: 50 },
    legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { size: 11 } },
    hoverlabel: { bgcolor: '#111827', bordercolor: '#2a3a52', font: { color: '#e2e8f0', size: 12 } },
    shapes: shapes, annotations: annotations,
  }), { responsive: true, displayModeBar: false });
}

function buildMetricsTable(container, allData) {
  var metrics = [
    { key: 'score', label: 'Score', fmt: function(v){return v.toFixed(1);}, higher: true },
    { key: 'back_return', label: 'Back Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'forward_return', label: 'Fwd Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'back_trades', label: 'Back Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'forward_trades', label: 'Fwd Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'win_rate', label: 'Win Rate', fmt: function(v){return (v*100).toFixed(1)+'%';}, higher: true },
    { key: 'profit_factor', label: 'Profit Factor', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_sharpe', label: 'Back Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'forward_sharpe', label: 'Fwd Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_r2', label: 'Back R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'forward_r2', label: 'Fwd R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'back_max_dd', label: 'Max DD %', fmt: function(v){return v.toFixed(1)+'%';}, higher: false },
    { key: 'stability', label: 'Stability %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
  ];

  var runMetrics = allData.map(function(item, idx) {
    var d = item.data; var meta = d.meta || {};
    return {
      label: (meta.strategy || item.runId) + ' (#' + (d.best_rank || '?') + ')',
      color: COLORS[idx % COLORS.length],
      score: (d.decision||{}).score || 0,
      back_return: d.back_return || 0, forward_return: d.forward_return || 0,
      back_trades: d.back_trades || 0, forward_trades: d.forward_trades || 0,
      win_rate: d.win_rate || 0, profit_factor: d.profit_factor || 0,
      back_sharpe: d.back_sharpe || 0, forward_sharpe: d.forward_sharpe || 0,
      back_r2: d.back_r_squared || 0, forward_r2: d.forward_r_squared || 0,
      back_max_dd: d.back_max_dd || 0, stability: (d.stability_mean || 0) * 100,
    };
  });

  var headerCells = '<th class="metric-label-col">Metric</th>';
  runMetrics.forEach(function(rm) { headerCells += '<th style="color:'+rm.color+'">'+rm.label+'</th>'; });

  var bodyRows = '';
  metrics.forEach(function(m) {
    var vals = runMetrics.map(function(rm) { return rm[m.key]; });
    var bestVal = m.higher ? Math.max.apply(null, vals) : Math.min.apply(null, vals);
    bodyRows += '<tr><td class="metric-label-col">' + m.label + '</td>';
    runMetrics.forEach(function(rm) {
      var v = rm[m.key];
      var cls = (v === bestVal && runMetrics.length > 1) ? ' class="best-val"' : '';
      bodyRows += '<td' + cls + '>' + m.fmt(v) + '</td>';
    });
    bodyRows += '</tr>';
  });

  container.innerHTML = '<table class="compare-metrics-table"><thead><tr>'+headerCells+'</tr></thead><tbody>'+bodyRows+'</tbody></table>';
}

// ── Run Detail (Enhanced) ──
var currentDetailRun = null;

// -- Formatters --
function rdN(v, d) { if (v == null || isNaN(v)) return '\u2014'; var n = Number(v).toFixed(d == null ? 2 : d); var p = n.split('.'); p[0] = p[0].replace(/\B(?=(\d{3})+(?!\d))/g, ','); return p.join('.'); }
function rdPct(v, d) { if (v == null || isNaN(v)) return '\u2014'; return rdN(v, d == null ? 1 : d) + '%'; }
function rdPctR(v, d) { if (v == null || isNaN(v)) return '\u2014'; return rdPct(v * 100, d); }
function rdDlr(v) { if (v == null || isNaN(v)) return '\u2014'; var s = Math.abs(v).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ','); return (v >= 0 ? '$' : '-$') + s; }
function rdSc(s) { if (s >= 70) return '#10b981'; if (s >= 40) return '#f59e0b'; return '#ef4444'; }
function rdRc(r) { if (r === 'GREEN' || r === 'STABLE') return ['#065f46','#10b981']; if (r === 'YELLOW' || r === 'MODERATE') return ['#78350f','#f59e0b']; return ['#7f1d1d','#ef4444']; }
function rdVc(v) { return v > 0 ? '#10b981' : v < 0 ? '#ef4444' : '#8896ab'; }

function rdSection(title, bodyHtml, collapsed) {
  return '<div class="rd-section' + (collapsed ? ' collapsed' : '') + '"><div class="rd-section-head" onclick="rdToggle(this.parentElement)"><h3>' + title + '</h3><span class="rd-chevron">\u25BC</span></div><div class="rd-section-body">' + bodyHtml + '</div></div>';
}

// -- Section: Header --
function rdHeader(run, det) {
  var rc = rdRc(run.rating);
  var rec = det && det.decision ? (det.decision.recommendation || '') : '';
  var cfg = det ? (det.config || {}) : {};
  var h = '<div class="rd-header" style="border-left:3px solid '+rc[1]+'">';
  h += '<div class="rd-title-row"><div><div class="rd-title">' + esc(run.pair) + ' ' + esc(run.timeframe) + ' \u2014 ' + esc(run.strategy) + '</div>';
  h += '<div class="rd-meta">' + esc(run.run_id) + ' \u00B7 ' + esc(run.description || '') + ' \u00B7 ' + (run.created || '').substring(0, 19) + '</div></div>';
  h += '<div class="rd-score-block"><div class="rd-score-big" style="color:'+rc[1]+'">' + (run.score > 0 ? run.score.toFixed(0) : '-') + '<span style="font-size:0.9rem;color:'+rc[1]+';background:'+rc[0]+';padding:2px 8px;border-radius:4px;margin-left:8px;vertical-align:middle">' + run.rating + '</span></div>';
  if (rec) h += '<div class="rd-recommendation">' + esc(rec) + '</div>';
  h += '</div></div>';
  if (cfg.data_years || cfg.train_months) {
    h += '<div class="rd-config-strip">';
    if (cfg.data_years) h += '<div class="rd-config-item">Data: <span>' + cfg.data_years + 'yr</span></div>';
    if (cfg.train_months) h += '<div class="rd-config-item">Train: <span>' + cfg.train_months + 'mo</span></div>';
    if (cfg.test_months) h += '<div class="rd-config-item">Test: <span>' + cfg.test_months + 'mo</span></div>';
    if (cfg.holdout_months) h += '<div class="rd-config-item">Holdout: <span>' + cfg.holdout_months + 'mo</span></div>';
    if (cfg.trials_per_stage) h += '<div class="rd-config-item">Trials: <span>' + cfg.trials_per_stage + '/' + (cfg.final_trials||'') + '</span></div>';
    if (cfg.spread_pips) h += '<div class="rd-config-item">Spread: <span>' + cfg.spread_pips + 'pip</span></div>';
    if (cfg.initial_capital) h += '<div class="rd-config-item">Capital: <span>' + rdDlr(cfg.initial_capital) + '</span></div>';
    h += '</div>';
  }
  h += '</div>';
  return h;
}

// -- Section: Performance --
function rdPerformance(run, det, comp) {
  var ext = det ? (det.extended || {}) : {};
  var c = comp || {};
  function row(label, bv, fv, color) {
    var bc = color ? ' style="color:' + (typeof color === 'function' ? color(bv) : color) + '"' : '';
    var fc = color ? ' style="color:' + (typeof color === 'function' ? color(fv) : color) + '"' : '';
    return '<tr><td>' + label + '</td><td' + bc + '>' + bv + '</td><td' + fc + '>' + fv + '</td></tr>';
  }
  var h = '<table class="rd-perf-table"><thead><tr><th>Metric</th><th>Backtest</th><th>Forward</th></tr></thead><tbody>';
  h += row('Quality Score', rdN(ext.back_quality_score, 1), rdN(ext.forward_quality_score, 1));
  h += row('Return %', rdPct(run.back_return, 1), rdPct(run.forward_return, 1), rdVc);
  h += row('Trades', run.back_trades || 0, run.forward_trades || 0);
  h += row('Win Rate', rdPctR(run.win_rate), rdPctR(ext.forward_win_rate));
  h += row('Profit Factor', rdN(c.back_profit_factor || c.profit_factor, 2), rdN(ext.forward_profit_factor, 2));
  h += row('Sharpe', rdN(run.back_sharpe, 2), rdN(run.forward_sharpe, 2));
  h += row('Sortino', rdN(ext.back_sortino, 2), rdN(ext.forward_sortino, 2));
  h += row('R\u00B2', rdN(c.back_r_squared, 3), rdN(ext.forward_r_squared || c.forward_r_squared, 3));
  h += row('Max DD %', rdPct(run.back_max_dd, 1), rdPct(ext.forward_max_dd, 1));
  h += row('Ulcer Index', rdN(ext.back_ulcer, 2), rdN(ext.forward_ulcer, 2));
  h += '</tbody></table>';
  var fb = ext.forward_back_ratio || run.forward_back_ratio || 0;
  var fbColor = fb >= 0.7 ? '#10b981' : fb >= 0.4 ? '#f59e0b' : '#ef4444';
  h += '<div class="rd-fb-banner"><div class="rd-fb-label">Forward / Back Ratio</div><div class="rd-fb-value" style="color:' + fbColor + '">' + rdPct(fb * 100, 1) + '</div></div>';
  if (det && det.recovery_factor != null) h += '<div style="text-align:center;margin-top:6px;font-size:0.72rem;color:#5a6a80">Recovery Factor: <span style="color:#8896ab;font-family:JetBrains Mono,monospace">' + rdN(det.recovery_factor, 2) + '</span></div>';
  return rdSection('Performance Overview', h);
}

// -- Section: Confidence --
function rdConfidence(det) {
  var c = det.confidence; if (!c || c.total_score == null) return '';
  var h = '<div class="rd-conf-total"><div class="score" style="color:' + rdSc(c.total_score) + '">' + rdN(c.total_score, 1) + ' <span style="font-size:0.7rem">/100</span></div><div class="label">Confidence Score \u2014 ' + (c.rating || '') + '</div></div>';
  var components = [
    ['BT Quality', c.backtest_quality_score, (c.weights||{}).backtest_quality],
    ['F/B Ratio', c.forward_back_score, (c.weights||{}).forward_back],
    ['Walk-Forward', c.walkforward_score, (c.weights||{}).walkforward],
    ['Stability', c.stability_score, (c.weights||{}).stability],
    ['Monte Carlo', c.montecarlo_score, (c.weights||{}).montecarlo],
    ['Quality Score', c.quality_score, (c.weights||{}).quality_score],
  ];
  components.forEach(function(r) {
    var score = r[1] != null ? r[1] : 0;
    var weight = r[2] != null ? r[2] : 0;
    h += '<div class="rd-conf-row"><div class="rd-conf-label">' + r[0] + '</div>';
    h += '<div class="rd-conf-bar-bg"><div class="rd-conf-bar-fill" style="width:' + Math.min(score, 100) + '%;background:' + rdSc(score) + '"></div></div>';
    h += '<div class="rd-conf-score" style="color:' + rdSc(score) + '">' + rdN(score, 0) + '</div>';
    h += '<div class="rd-conf-weight">' + (weight * 100).toFixed(0) + '%</div></div>';
  });
  return rdSection('Confidence Breakdown', h);
}

// -- Section: Walk-Forward --
function rdWalkforward(det) {
  var wf = det.walkforward; if (!wf) return '';
  var st = wf.stats || {};
  var wins = wf.windows || [];
  if (!wins.length) return '';
  var h = '<div class="rd-wf-summary"><strong style="color:#e2e8f0">' + (st.n_passed||0) + '/' + (st.n_windows||0) + '</strong> windows passed <span style="color:#5a6a80">(' + rdPctR(st.pass_rate) + ')</span>';
  if (st.oos_n_windows > 0) h += ' \u00B7 <span style="color:#3b82f6">' + st.oos_n_windows + ' OOS</span> (' + (st.oos_n_passed||0) + ' passed)';
  h += '</div>';
  h += '<div style="overflow-x:auto"><table class="rd-wf-table"><thead><tr><th>#</th><th>OOS</th><th>Trades</th><th>QScore</th><th>Sharpe</th><th>Sortino</th><th>Return%</th><th>MaxDD%</th><th>WinRate</th><th>PF</th><th>R\u00B2</th><th>Ulcer</th><th></th></tr></thead><tbody>';
  wins.forEach(function(w) {
    var cls = (w.passed ? 'wf-pass' : 'wf-fail') + (w.out_of_sample ? ' wf-oos' : '');
    var dotColor = w.passed ? '#22c55e' : '#ef4444';
    h += '<tr class="' + cls + '"><td>' + w.window + '</td>';
    h += '<td>' + (w.out_of_sample ? '<span style="color:#3b82f6;font-size:0.65rem">OOS</span>' : '') + '</td>';
    h += '<td>' + (w.trades || 0) + '</td>';
    h += '<td>' + rdN(w.quality_score, 1) + '</td>';
    h += '<td>' + rdN(w.sharpe, 2) + '</td>';
    h += '<td>' + rdN(w.sortino, 2) + '</td>';
    h += '<td style="color:' + rdVc(w['return']) + '">' + rdPct(w['return'], 1) + '</td>';
    h += '<td>' + rdPct(w.max_dd, 1) + '</td>';
    h += '<td>' + rdPctR(w.win_rate) + '</td>';
    h += '<td>' + rdN(w.profit_factor, 2) + '</td>';
    h += '<td>' + rdN(w.r_squared, 3) + '</td>';
    h += '<td>' + rdN(w.ulcer, 2) + '</td>';
    h += '<td><span class="rd-wf-dot" style="background:' + dotColor + ';box-shadow:0 0 4px ' + dotColor + '"></span></td></tr>';
  });
  h += '</tbody></table></div>';
  return rdSection('Walk-Forward Analysis', h);
}

// -- Section: Monte Carlo --
function rdMonteCarlo(det) {
  var mc = det.montecarlo; if (!mc || mc.status === 'unknown') return '';
  var h = '<div class="rd-mc-grid">';
  // Return Distribution
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Return Distribution (' + (mc.n_iterations||0) + ' sims)</div>';
  h += '<div class="rd-mc-row"><span class="lbl">Original</span><span class="val" style="color:#3b82f6">' + rdPct(mc.original_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Mean</span><span class="val">' + rdPct(mc.mean_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">5th pct</span><span class="val" style="color:#ef4444">' + rdPct(mc.pct_5_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">25th pct</span><span class="val">' + rdPct(mc.pct_25_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Median</span><span class="val">' + rdPct(mc.pct_50_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">75th pct</span><span class="val">' + rdPct(mc.pct_75_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">95th pct</span><span class="val" style="color:#10b981">' + rdPct(mc.pct_95_return, 1) + '</span></div>';
  h += '</div>';
  // Drawdown Distribution
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Drawdown Distribution</div>';
  h += '<div class="rd-mc-row"><span class="lbl">Original MaxDD</span><span class="val" style="color:#3b82f6">' + rdPct(mc.original_max_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Mean DD</span><span class="val">' + rdPct(mc.mean_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">5th pct DD</span><span class="val" style="color:#10b981">' + rdPct(mc.pct_5_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Median DD</span><span class="val">' + rdPct(mc.pct_50_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">95th pct DD</span><span class="val" style="color:#ef4444">' + rdPct(mc.pct_95_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Worst DD</span><span class="val" style="color:#ef4444">' + rdPct(mc.max_dd, 1) + '</span></div>';
  h += '</div>';
  // Risk Metrics
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Risk Metrics</div>';
  h += '<div class="rd-mc-row"><span class="lbl">VaR 95%</span><span class="val">' + rdPct(mc.var_95, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Exp. Shortfall</span><span class="val">' + rdPct(mc.expected_shortfall, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(Positive)</span><span class="val" style="color:' + (mc.prob_positive >= 90 ? '#10b981' : mc.prob_positive >= 70 ? '#f59e0b' : '#ef4444') + '">' + rdPct(mc.prob_positive, 0) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(&gt;5%)</span><span class="val">' + rdPct(mc.prob_above_5pct, 0) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(&gt;10%)</span><span class="val">' + rdPct(mc.prob_above_10pct, 0) + '</span></div>';
  h += '</div>';
  // Bootstrap CIs + Permutation
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Bootstrap &amp; Permutation</div>';
  if (mc.bootstrap_sharpe_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">Sharpe CI</span><span class="val">[' + rdN(mc.bootstrap_sharpe_ci_lower, 2) + ', ' + rdN(mc.bootstrap_sharpe_ci_upper, 2) + ']</span></div>';
  }
  if (mc.bootstrap_wr_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">WinRate CI</span><span class="val">[' + rdPctR(mc.bootstrap_wr_ci_lower) + ', ' + rdPctR(mc.bootstrap_wr_ci_upper) + ']</span></div>';
  }
  if (mc.bootstrap_pf_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">PF CI</span><span class="val">[' + rdN(mc.bootstrap_pf_ci_lower, 2) + ', ' + rdN(mc.bootstrap_pf_ci_upper, 2) + ']</span></div>';
  }
  if (mc.perm_p_value != null) {
    var sigColor = mc.perm_significant_01 ? '#10b981' : mc.perm_significant_05 ? '#f59e0b' : '#ef4444';
    var sigLabel = mc.perm_significant_01 ? 'p<0.01' : mc.perm_significant_05 ? 'p<0.05' : 'Not sig.';
    h += '<div class="rd-mc-row"><span class="lbl">Perm. p-value</span><span class="val">' + rdN(mc.perm_p_value, 4) + '</span></div>';
    h += '<div class="rd-mc-row"><span class="lbl">Significance</span><span class="val" style="color:' + sigColor + '">' + sigLabel + '</span></div>';
  }
  if (mc.perm_original_sharpe != null) {
    h += '<div class="rd-mc-row"><span class="lbl">Orig. Sharpe</span><span class="val">' + rdN(mc.perm_original_sharpe, 3) + '</span></div>';
  }
  h += '</div></div>';
  return rdSection('Monte Carlo Simulation', h);
}

// -- Section: Stability --
function rdStability(det) {
  var s = det.stability; if (!s) return '';
  var rc = rdRc(s.rating);
  var h = '<div class="rd-stab-grid">';
  h += '<div class="rd-stab-card"><div class="val"><span style="background:'+rc[0]+';color:'+rc[1]+';padding:2px 10px;border-radius:4px;font-size:0.82rem">' + (s.rating||'?') + '</span></div><div class="lbl">Rating</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:' + rdSc(s.mean_stability * 100) + '">' + rdPctR(s.mean_stability) + '</div><div class="lbl">Mean Stability</div></div>';
  h += '<div class="rd-stab-card"><div class="val">' + rdPctR(s.min_stability) + '</div><div class="lbl">Min Stability</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:#10b981">' + (s.n_stable||0) + '</div><div class="lbl">Stable Params</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:' + (s.n_unstable > 0 ? '#ef4444' : '#5a6a80') + '">' + (s.n_unstable||0) + '</div><div class="lbl">Unstable</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:#5a6a80">' + (s.n_skipped||0) + '</div><div class="lbl">Skipped</div></div>';
  h += '</div>';
  return rdSection('Stability Analysis', h);
}

// -- Section: Trade Analysis --
function rdTrades(det) {
  var ts = det.trade_summary; if (!ts || !ts.total_trades) return '';
  var h = '<div class="rd-trade-grid">';
  h += '<div class="rd-trade-card"><div class="lbl">Total Trades</div><div class="val">' + (ts.total_trades||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Net Profit</div><div class="val" style="color:'+rdVc(ts.total_net_profit)+'">' + rdDlr(ts.total_net_profit) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Gross Profit</div><div class="val text-green">' + rdDlr(ts.gross_profit) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Gross Loss</div><div class="val text-red">' + rdDlr(ts.gross_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Win Rate</div><div class="val">' + rdPctR(ts.win_rate) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Profit Factor</div><div class="val">' + rdN(ts.profit_factor, 2) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Expected Payoff</div><div class="val" style="color:'+rdVc(ts.expected_payoff)+'">' + rdDlr(ts.expected_payoff) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Bars Held</div><div class="val">' + rdN(ts.avg_bars_held, 1) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Win</div><div class="val text-green">' + rdDlr(ts.avg_win) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Loss</div><div class="val text-red">' + rdDlr(ts.avg_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Largest Win</div><div class="val text-green">' + rdDlr(ts.largest_win) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Largest Loss</div><div class="val text-red">' + rdDlr(ts.largest_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Max Consec. Wins</div><div class="val">' + (ts.max_consecutive_wins||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Max Consec. Losses</div><div class="val">' + (ts.max_consecutive_losses||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Long / Short</div><div class="val">' + (ts.long_trades||0) + ' / ' + (ts.short_trades||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg MFE (R)</div><div class="val">' + rdN(ts.avg_mfe_r, 2) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg MAE (R)</div><div class="val">' + rdN(ts.avg_mae_r, 2) + '</div></div>';
  h += '</div>';
  // Exit reasons
  var er = ts.exit_reason_counts || {};
  var erKeys = Object.keys(er);
  if (erKeys.length > 0) {
    var maxCount = Math.max.apply(null, erKeys.map(function(k) { return er[k]; }));
    var erColors = { tp: '#10b981', sl: '#ef4444', trailing: '#3b82f6', time: '#8b5cf6', stale: '#f59e0b', break_even: '#06b6d4', force_close: '#ec4899' };
    h += '<div style="margin-top:8px;font-size:0.72rem;color:#5a6a80;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Exit Reasons</div>';
    h += '<table class="rd-exit-table">';
    erKeys.sort(function(a,b) { return er[b] - er[a]; }).forEach(function(k) {
      var pct = maxCount > 0 ? (er[k] / maxCount * 100) : 0;
      var color = erColors[k] || '#8896ab';
      h += '<tr><td>' + k.toUpperCase() + '</td><td>' + er[k] + '</td><td><span class="rd-exit-bar" style="width:' + pct + '%;background:' + color + '"></span></td></tr>';
    });
    h += '</table>';
  }
  return rdSection('Trade Analysis', h);
}

// -- Section: Monthly Returns --
function rdMonthly(det) {
  var m = det.monthly_returns; if (!m) return '';
  var years = Object.keys(m).sort();
  if (!years.length) return '';
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function cellColor(v) {
    if (v == null || v === 0) return 'background:#0d1320';
    var a = Math.min(Math.abs(v) / 8, 1);
    return v > 0 ? 'background:rgba(16,185,129,' + (0.1 + a * 0.5) + ')' : 'background:rgba(239,68,68,' + (0.1 + a * 0.5) + ')';
  }
  var h = '<div style="overflow-x:auto"><table class="rd-monthly-table"><thead><tr><th>Year</th>';
  months.forEach(function(mo) { h += '<th>' + mo + '</th>'; });
  h += '<th>Total</th></tr></thead><tbody>';
  years.forEach(function(yr) {
    var yd = m[yr] || {};
    var total = 0;
    h += '<tr><td>' + yr + '</td>';
    months.forEach(function(mo) {
      var v = yd[mo];
      if (v != null) total += v;
      var style = cellColor(v);
      var color = v > 0 ? '#10b981' : v < 0 ? '#ef4444' : '#5a6a80';
      h += '<td style="' + style + ';color:' + color + '">' + (v != null ? v.toFixed(1) : '') + '</td>';
    });
    h += '<td style="' + cellColor(total) + ';color:' + (total > 0 ? '#10b981' : '#ef4444') + ';font-weight:600">' + total.toFixed(1) + '</td></tr>';
  });
  h += '</tbody></table></div>';
  return rdSection('Monthly Returns (%)', h);
}

// -- Section: Parameters --
function rdParams(det) {
  var params = det.extended ? det.extended.params : null;
  if (!params) return '';
  var keys = Object.keys(params).sort();
  if (!keys.length) return '';
  var half = Math.ceil(keys.length / 2);
  function paramTable(ks) {
    var h = '<table class="rd-params-table">';
    ks.forEach(function(k) {
      var v = params[k];
      if (typeof v === 'boolean') v = v ? 'True' : 'False';
      else if (typeof v === 'number') v = Number.isInteger(v) ? v.toString() : v.toFixed(4);
      h += '<tr><td>' + k + '</td><td>' + v + '</td></tr>';
    });
    return h + '</table>';
  }
  var h = '<div class="rd-params-grid">' + paramTable(keys.slice(0, half)) + paramTable(keys.slice(half)) + '</div>';
  return rdSection('Best Candidate Parameters', h, true);
}

// -- Charts --
function rdRenderCharts(comp, det) {
  var chartArea = document.getElementById('rd-charts-area');
  if (!chartArea) return;
  // Equity chart
  var eqDiv = document.getElementById('rd-equity-chart');
  if (comp && (comp.back_equity || comp.forward_equity)) {
    var traces = [], shapes = [];
    var ic = comp.initial_capital || 10000;
    if (comp.back_equity && comp.back_equity.length) {
      traces.push({ x: comp.back_equity.map(function(p){return p.timestamp;}), y: comp.back_equity.map(function(p){return p.equity-ic;}), name: 'Backtest (R\u00B2=' + rdN(comp.back_r_squared,3) + ')', line:{color:'#3b82f6',width:2}, type:'scatter' });
      if (comp.forward_equity && comp.forward_equity.length) {
        var st = comp.back_equity[comp.back_equity.length-1].timestamp;
        shapes.push({type:'line',x0:st,x1:st,y0:0,y1:1,yref:'paper',line:{color:'#3b82f6',width:1,dash:'dot'},opacity:0.5});
      }
    }
    if (comp.forward_equity && comp.forward_equity.length) {
      traces.push({ x: comp.forward_equity.map(function(p){return p.timestamp;}), y: comp.forward_equity.map(function(p){return p.equity-ic;}), name: 'Forward (R\u00B2=' + rdN(comp.forward_r_squared,3) + ')', line:{color:'#10b981',width:2,dash:'dash'}, type:'scatter' });
    }
    var layout = { paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#8896ab',family:'Inter,system-ui,sans-serif',size:11}, xaxis:{gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, yaxis:{title:'Profit ($)',gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, margin:{l:55,r:20,t:15,b:40}, legend:{orientation:'h',y:-0.18,x:0.5,xanchor:'center',font:{size:10}}, hoverlabel:{bgcolor:'#111827',bordercolor:'#2a3a52',font:{color:'#e2e8f0',size:11}}, shapes:shapes };
    Plotly.newPlot(eqDiv, traces, mobileLayout(layout), {responsive:true,displayModeBar:false});
  } else {
    eqDiv.innerHTML = '<div style="text-align:center;padding:50px;color:#5a6a80">No equity data</div>';
  }
  // Drawdown chart
  var ddDiv = document.getElementById('rd-dd-chart');
  var ddCurve = det ? det.drawdown_curve : null;
  if (ddCurve && ddCurve.length > 0) {
    var dx = ddCurve.map(function(p){return p.timestamp||p.trade_num;});
    var dy = ddCurve.map(function(p){return -(p.drawdown||0);});
    Plotly.newPlot(ddDiv, [{x:dx,y:dy,type:'scatter',mode:'lines',fill:'tozeroy',fillcolor:'rgba(239,68,68,0.15)',line:{color:'#ef4444',width:1.5},name:'Drawdown %'}], mobileLayout({ paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#8896ab',family:'Inter,system-ui,sans-serif',size:11}, xaxis:{gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, yaxis:{title:'Drawdown %',gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, margin:{l:55,r:20,t:10,b:40}, showlegend:false, hoverlabel:{bgcolor:'#111827',bordercolor:'#2a3a52',font:{color:'#e2e8f0',size:11}} }), {responsive:true,displayModeBar:false});
  } else {
    ddDiv.innerHTML = '<div style="text-align:center;padding:30px;color:#5a6a80">No drawdown data</div>';
  }
}

// -- Main showRunDetail --
function showRunDetail(runId) {
  if (currentDetailRun === runId) { closeRunDetail(); return; }
  currentDetailRun = runId;
  var run = lbData.runs.find(function(r) { return r.run_id === runId; });
  var comp = (lbData.compare || {})[runId];
  var det = (lbData.detail || {})[runId];
  if (!run) return;

  var rc = rdRc(run.rating);
  var panel = document.getElementById('run-detail');
  panel.style.setProperty('--rd-accent', rc[1]);

  var html = '<div class="rd-inner">';
  // Close button - sticky top-right
  html += '<div class="rd-close-btn"><button onclick="closeRunDetail()">\u2715 Back to Leaderboard</button></div>';
  // Header
  html += rdHeader(run, det);
  // Charts section (top - the money shot)
  html += '<div class="rd-section"><div class="rd-section-head" onclick="rdToggle(this.parentElement)"><h3>Equity Curve &amp; Drawdown</h3><span class="rd-chevron">\u25BC</span></div><div class="rd-section-body" id="rd-charts-area">';
  html += '<div id="rd-equity-chart" style="height:420px"></div>';
  html += '<div id="rd-dd-chart" style="height:250px;margin-top:12px"></div>';
  html += '</div></div>';
  // Performance
  html += rdPerformance(run, det, comp);
  // Trade Analysis
  if (det) html += rdTrades(det);
  // Monthly Returns
  if (det) html += rdMonthly(det);
  // Walk-Forward
  if (det) html += rdWalkforward(det);
  // Confidence
  if (det) html += rdConfidence(det);
  // Stability
  if (det) html += rdStability(det);
  // Monte Carlo
  if (det) html += rdMonteCarlo(det);
  // Parameters
  if (det) html += rdParams(det);
  html += '</div>'; // close rd-inner

  panel.innerHTML = html;
  panel.classList.add('visible');
  document.body.classList.add('rd-open');

  // Render charts after DOM insertion
  setTimeout(function() { rdRenderCharts(comp, det); }, 50);
  panel.scrollTop = 0;
}

function closeRunDetail() {
  currentDetailRun = null;
  var panel = document.getElementById('run-detail');
  panel.classList.remove('visible');
  panel.innerHTML = '';
  document.body.classList.remove('rd-open');
}

function rdToggle(section) {
  section.classList.toggle('collapsed');
}

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
(function() {
  var hash = location.hash.replace('#', '') || 'dashboard';
  if (hash === 'leaderboard' || hash === 'pipeline') switchView('leaderboard');
  else switchView('dashboard');
})();
</script>
</body>
</html>
