<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OANDA Trading System</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0e1a;
    --bg-card: #111827;
    --bg-card-hover: #1a2332;
    --bg-input: #1e293b;
    --border: #1e293b;
    --border-light: #334155;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --green: #22c55e;
    --green-dim: #16a34a;
    --yellow: #eab308;
    --red: #ef4444;
    --red-dim: #dc2626;
    --orange: #f97316;
    --purple: #a855f7;
    --cyan: #06b6d4;
  }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* ── NAV ── */
  .nav {
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    gap: 0;
  }
  .nav-brand {
    font-weight: 700;
    font-size: 1rem;
    color: var(--accent);
    margin-right: 2rem;
    white-space: nowrap;
    padding: 0.75rem 0;
    font-family: 'JetBrains Mono', monospace;
  }
  .nav-tab {
    padding: 0.75rem 1.25rem;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    font-size: 0.875rem;
    font-weight: 500;
    user-select: none;
  }
  .nav-tab:hover { color: var(--text); }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .nav-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  /* ── LAYOUT ── */
  .container { max-width: 1400px; margin: 0 auto; padding: 1.25rem; }
  .view { display: none; }
  .view.active { display: block; }

  /* ── CARDS ── */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
  }
  .card-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.25rem; }
  .card-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  /* ── TABLES ── */
  .table-wrap { overflow-x: auto; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  th {
    text-align: left;
    padding: 0.625rem 0.75rem;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    position: sticky;
    top: 0;
    background: var(--bg-card);
  }
  th:hover { color: var(--text-dim); }
  th .sort-arrow { margin-left: 4px; font-size: 0.6rem; }
  td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--bg-card-hover); }

  /* ── STATUS DOTS ── */
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-yellow { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
  .dot-red { background: var(--red); box-shadow: 0 0 6px var(--red); }
  .dot-gray { background: var(--text-muted); }

  /* ── BADGES ── */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
  }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-yellow { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge-blue { background: rgba(59,130,246,0.15); color: var(--accent); }
  .badge-gray { background: rgba(100,116,139,0.15); color: var(--text-muted); }

  /* ── BUTTONS ── */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid var(--border-light);
    background: var(--bg-input);
    color: var(--text-dim);
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'Inter', sans-serif;
  }
  .btn:hover { background: var(--border-light); color: var(--text); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-accent { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-accent:hover { background: var(--accent-hover); }
  .btn-sm { padding: 2px 6px; font-size: 0.65rem; }
  .btn-danger { border-color: var(--red-dim); color: var(--red); }
  .btn-danger:hover { background: rgba(239,68,68,0.15); }

  /* ── FILTER BAR ── */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
  }
  .filter-group { display: flex; gap: 2px; }
  .filter-group label {
    font-size: 0.65rem;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-right: 4px;
    align-self: center;
  }
  .filter-btn {
    padding: 3px 8px;
    border-radius: 3px;
    border: 1px solid var(--border-light);
    background: transparent;
    color: var(--text-dim);
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .filter-btn:hover:not(.active) { background: var(--bg-input); }

  /* ── BANNER ── */
  .banner {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.8rem;
    display: none;
  }
  .banner-error {
    background: rgba(239,68,68,0.1);
    border: 1px solid var(--red-dim);
    color: var(--red);
  }
  .banner.show { display: block; }

  /* ── EXPANDABLE PANELS ── */
  .expand-panel {
    display: none;
    padding: 1rem;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }
  .expand-panel.open { display: block; }
  .expand-row td { padding: 0; }

  /* ── DETAIL PANEL ── */
  .detail-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    margin-top: 1rem;
  }
  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .detail-header h3 { font-size: 1rem; }
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .metric-item {
    background: var(--bg);
    border-radius: 6px;
    padding: 0.625rem;
  }
  .metric-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); }
  .metric-value { font-size: 1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

  /* ── COMPARE TOOLBAR ── */
  .compare-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border-top: 1px solid var(--accent);
    padding: 0.75rem 1.5rem;
    display: none;
    align-items: center;
    justify-content: space-between;
    z-index: 90;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
  }
  .compare-toolbar.show { display: flex; }

  /* ── MONO VALUES ── */
  .mono { font-family: 'JetBrains Mono', monospace; }
  .text-green { color: var(--green); }
  .text-red { color: var(--red); }
  .text-yellow { color: var(--yellow); }
  .text-dim { color: var(--text-dim); }
  .text-muted { color: var(--text-muted); }
  .text-right { text-align: right; }

  /* ── LOADING ── */
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border-light); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── RESPONSIVE ── */
  @media (max-width: 768px) {
    .nav { padding: 0 0.75rem; }
    .nav-brand { font-size: 0.85rem; margin-right: 0.75rem; }
    .nav-tab { padding: 0.625rem 0.75rem; font-size: 0.8rem; }
    .container { padding: 0.75rem; }
    .cards { grid-template-columns: repeat(2, 1fr); }
    .card-value { font-size: 1.1rem; }
    .nav-right { display: none; }
  }

  /* ── CHECKBOX ── */
  .cb { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }

  /* ── PERF TABLE ── */
  .perf-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 0.75rem;
  }
  @media (max-width: 900px) { .perf-grid { grid-template-columns: 1fr; } }

  /* ── WF BAR ── */
  .wf-bar { height: 6px; border-radius: 3px; background: var(--bg-input); overflow: hidden; width: 80px; display: inline-block; vertical-align: middle; }
  .wf-bar-fill { height: 100%; border-radius: 3px; }

  /* ── SECTION HEADING ── */
  .section-heading {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
</style>
</head>
<body>

<!-- ═══ NAVIGATION ═══ -->
<nav class="nav">
  <div class="nav-brand">OANDA System</div>
  <div class="nav-tab active" data-view="dashboard" onclick="switchView('dashboard')">Trading</div>
  <div class="nav-tab" data-view="leaderboard" onclick="switchView('leaderboard')">Pipeline</div>
  <div class="nav-right">
    <span id="clock"></span>
  </div>
</nav>

<!-- ═══ DASHBOARD VIEW ═══ -->
<div id="view-dashboard" class="view active">
  <div class="container">
    <div id="vps-banner" class="banner banner-error">VPS Offline — Live trading data unavailable. The leaderboard still works.</div>

    <!-- Summary Cards -->
    <div class="cards">
      <div class="card">
        <div class="card-label">Daily P&amp;L</div>
        <div class="card-value mono" id="sum-pnl">—</div>
      </div>
      <div class="card">
        <div class="card-label">Open Positions</div>
        <div class="card-value mono" id="sum-positions">—</div>
      </div>
      <div class="card">
        <div class="card-label">Trades Today</div>
        <div class="card-value mono" id="sum-trades">—</div>
      </div>
      <div class="card">
        <div class="card-label">Running</div>
        <div class="card-value mono" id="sum-running">—</div>
      </div>
      <div class="card">
        <div class="card-label">Errors</div>
        <div class="card-value mono" id="sum-errors">—</div>
      </div>
    </div>

    <!-- Instances Table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th>Strategy</th>
            <th>Pair / TF</th>
            <th>Heartbeat</th>
            <th>Positions</th>
            <th class="text-right">Daily P&L</th>
            <th>W / L</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="instances-body">
          <tr><td colspan="8" class="text-dim" style="text-align:center;padding:2rem;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ LEADERBOARD VIEW ═══ -->
<div id="view-leaderboard" class="view">
  <div class="container">
    <!-- Filter Bar -->
    <div class="filter-bar" id="lb-filters"></div>

    <!-- Leaderboard Table -->
    <div class="table-wrap">
      <table id="lb-table">
        <thead>
          <tr>
            <th style="width:30px;"></th>
            <th data-sort="pair">Pair</th>
            <th data-sort="timeframe">TF</th>
            <th data-sort="strategy">Strategy</th>
            <th data-sort="score" class="text-right">Score</th>
            <th data-sort="rating">Rating</th>
            <th data-sort="back_return" class="text-right">Back Ret%</th>
            <th data-sort="forward_return" class="text-right">Fwd Ret%</th>
            <th data-sort="forward_back_ratio" class="text-right">F/B</th>
            <th data-sort="back_trades" class="text-right">Trades</th>
            <th data-sort="win_rate" class="text-right">WR%</th>
            <th data-sort="back_max_dd" class="text-right">MaxDD%</th>
            <th data-sort="back_sharpe" class="text-right">Sharpe</th>
            <th data-sort="status">Status</th>
            <th data-sort="created">Date</th>
            <th data-sort="description">Description</th>
          </tr>
        </thead>
        <tbody id="lb-body">
          <tr><td colspan="16" class="text-dim" style="text-align:center;padding:2rem;">Loading leaderboard...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Detail Panel -->
    <div id="lb-detail" class="detail-panel" style="display:none;"></div>
  </div>
</div>

<!-- Compare Toolbar -->
<div id="compare-toolbar" class="compare-toolbar">
  <span><span id="compare-count">0</span> runs selected</span>
  <div>
    <button class="btn" onclick="clearCompare()">Clear</button>
    <button class="btn btn-accent" onclick="showCompare()">Compare</button>
  </div>
</div>

<script>
// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
let currentView = 'dashboard';
let dashboardTimer = null;
let vpsOnline = false;

// Leaderboard state
let lbData = null;
let lbLoaded = false;
let lbSort = { key: 'score', dir: -1 };
let lbFilters = { pair: null, timeframe: null, rating: null, status: null };
let lbSelected = new Set();
let lbDetailId = null;

// ═══════════════════════════════════════
// VIEW SWITCHING
// ═══════════════════════════════════════
function switchView(view) {
  currentView = view;
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');

  if (view === 'dashboard') {
    startDashboardRefresh();
  } else {
    stopDashboardRefresh();
    if (!lbLoaded) loadLeaderboard();
  }
  history.replaceState(null, '', '#' + view);
}

// ═══════════════════════════════════════
// CLOCK
// ═══════════════════════════════════════
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false }) + ' UTC' + (now.getTimezoneOffset() > 0 ? '-' : '+') + Math.abs(now.getTimezoneOffset()/60);
}
setInterval(updateClock, 1000);
updateClock();

// ═══════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════
async function fetchDashboard() {
  try {
    const resp = await fetch('/api/vps/status');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if (data.error) throw new Error(data.message || 'VPS error');
    vpsOnline = true;
    document.getElementById('vps-banner').classList.remove('show');
    renderDashboard(data);
  } catch (e) {
    vpsOnline = false;
    document.getElementById('vps-banner').classList.add('show');
    renderDashboardOffline();
  }
}

function renderDashboard(data) {
  const s = data.summary || {};
  const pnl = s.daily_pnl || 0;
  const el = (id, val) => { document.getElementById(id).textContent = val; };
  const pnlEl = document.getElementById('sum-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
  pnlEl.className = 'card-value mono ' + (pnl >= 0 ? 'text-green' : 'text-red');
  el('sum-positions', s.open_positions || 0);
  el('sum-trades', s.total_trades || 0);
  el('sum-running', (s.running || 0) + '/' + (s.total || 0));
  const errEl = document.getElementById('sum-errors');
  errEl.textContent = s.errors || 0;
  errEl.className = 'card-value mono ' + ((s.errors || 0) > 0 ? 'text-red' : '');

  const instances = data.instances || [];
  const tbody = document.getElementById('instances-body');
  if (!instances.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-dim" style="text-align:center;padding:2rem;">No trading instances configured</td></tr>';
    return;
  }

  tbody.innerHTML = instances.map(inst => {
    const statusDot = inst.heartbeat_ok ? 'dot-green' : (inst.status === 'error' ? 'dot-red' : 'dot-yellow');
    const statusLabel = inst.heartbeat_ok ? 'Running' : (inst.status === 'error' ? 'Error' : (inst.service_status === 'SERVICE_STOPPED' ? 'Stopped' : 'Stale'));
    const dpnl = inst.daily_pnl || 0;
    const pnlClass = dpnl >= 0 ? 'text-green' : 'text-red';
    const pnlStr = (dpnl >= 0 ? '+' : '') + dpnl.toFixed(2);

    return `<tr>
      <td><span class="dot ${statusDot}"></span>${statusLabel}</td>
      <td>${esc(inst.strategy)}${inst.id ? '<br><span class="text-muted" style="font-size:0.7rem">' + esc(inst.id) + '</span>' : ''}</td>
      <td class="mono">${esc(inst.pair)} ${esc(inst.timeframe)}</td>
      <td>${inst.heartbeat_display || '—'}</td>
      <td class="mono">${inst.positions || 0}</td>
      <td class="mono text-right ${pnlClass}">${pnlStr}</td>
      <td class="mono">${inst.daily_wins || 0} / ${inst.daily_losses || 0}</td>
      <td>
        <div style="display:flex;gap:3px;flex-wrap:wrap;">
          <button class="btn btn-sm" onclick="svcAction('${inst.id}','start')" title="Start">Start</button>
          <button class="btn btn-sm" onclick="svcAction('${inst.id}','restart')" title="Restart">Restart</button>
          <button class="btn btn-sm btn-danger" onclick="svcAction('${inst.id}','stop')" title="Stop">Stop</button>
          <button class="btn btn-sm" onclick="togglePanel('perf','${inst.id}')">Perf</button>
          <button class="btn btn-sm" onclick="togglePanel('trades','${inst.id}')">Trades</button>
        </div>
      </td>
    </tr>
    <tr class="expand-row" id="perf-panel-${inst.id}"><td colspan="8"><div class="expand-panel" id="perf-content-${inst.id}"></div></td></tr>
    <tr class="expand-row" id="trades-panel-${inst.id}"><td colspan="8"><div class="expand-panel" id="trades-content-${inst.id}"></div></td></tr>`;
  }).join('');
}

function renderDashboardOffline() {
  const el = (id, val) => { document.getElementById(id).textContent = val; };
  el('sum-pnl', '—'); el('sum-positions', '—'); el('sum-trades', '—'); el('sum-running', '—'); el('sum-errors', '—');
  document.getElementById('instances-body').innerHTML = '<tr><td colspan="8" class="text-dim" style="text-align:center;padding:2rem;">VPS offline — cannot load trading data</td></tr>';
}

// Expandable panels
const openPanels = {};
async function togglePanel(type, instanceId) {
  const key = type + '-' + instanceId;
  const panel = document.getElementById(type + '-content-' + instanceId);
  if (openPanels[key]) {
    panel.classList.remove('open');
    delete openPanels[key];
    return;
  }
  openPanels[key] = true;
  panel.innerHTML = '<div class="spinner"></div> Loading...';
  panel.classList.add('open');

  try {
    const endpoint = type === 'perf' ? 'performance' : 'trades';
    const resp = await fetch(`/api/vps/${endpoint}/${instanceId}`);
    const data = await resp.json();
    if (data.error) throw new Error(data.message);

    if (type === 'perf') {
      renderPerfPanel(panel, data);
    } else {
      renderTradesPanel(panel, data);
    }
  } catch (e) {
    panel.innerHTML = `<span class="text-red">Error: ${esc(e.message)}</span>`;
  }
}

function renderPerfPanel(panel, data) {
  const live = data.live || {};
  const exp = data.expected || {};
  const cmp = data.comparison || {};

  function statusIcon(s) {
    if (s === 'ok') return '<span class="text-green">OK</span>';
    if (s === 'warning') return '<span class="text-yellow">WARN</span>';
    if (s === 'alert') return '<span class="text-red">ALERT</span>';
    return '<span class="text-muted">—</span>';
  }

  function row(label, liveVal, expVal, status) {
    return `<tr><td>${label}</td><td class="mono text-right">${liveVal}</td><td class="mono text-right">${expVal}</td><td class="text-right">${statusIcon(status)}</td></tr>`;
  }

  panel.innerHTML = `
    <div class="section-heading">Performance vs Backtest Expectations</div>
    <table style="max-width:500px">
      <thead><tr><th>Metric</th><th class="text-right">Live</th><th class="text-right">Expected</th><th class="text-right">Status</th></tr></thead>
      <tbody>
        ${row('Win Rate', pct(live.win_rate), pct(exp.win_rate), cmp.win_rate_status)}
        ${row('Profit Factor', num(live.profit_factor), num(exp.profit_factor), cmp.profit_factor_status)}
        ${row('Trades/Month', num(live.trades_per_month), num(exp.trades_per_month), cmp.trades_per_month_status)}
        ${row('Total Trades', live.trades || 0, '—', '')}
        ${row('Max DD%', pct(live.max_drawdown_pct), '—', '')}
        ${row('Total P&L', num(live.total_pnl), '—', '')}
      </tbody>
    </table>`;
}

function renderTradesPanel(panel, data) {
  const trades = data.trades || [];
  if (!trades.length) { panel.innerHTML = '<span class="text-dim">No trades yet</span>'; return; }

  panel.innerHTML = `
    <div class="section-heading">Recent Trades (${trades.length})</div>
    <div style="overflow-x:auto;">
    <table>
      <thead><tr><th>Time</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Reason</th><th class="text-right">P&L</th></tr></thead>
      <tbody>${trades.map(t => {
        const pnl = t.realized_pnl || 0;
        const cls = pnl >= 0 ? 'text-green' : 'text-red';
        return `<tr>
          <td class="mono">${shortTime(t.exit_time || t.entry_time)}</td>
          <td><span class="badge ${t.direction === 'BUY' ? 'badge-green' : 'badge-red'}">${t.direction}</span></td>
          <td class="mono">${num(t.entry_price, 5)}</td>
          <td class="mono">${t.exit_price ? num(t.exit_price, 5) : '—'}</td>
          <td>${esc(t.exit_reason || '—')}</td>
          <td class="mono text-right ${cls}">${(pnl >= 0 ? '+' : '') + pnl.toFixed(2)}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>
    </div>`;
}

// Service control
async function svcAction(instanceId, action) {
  if (!confirm(`${action.toUpperCase()} service "${instanceId}"?`)) return;
  try {
    const resp = await fetch(`/api/vps/service/${instanceId}/${action}`, { method: 'POST' });
    const data = await resp.json();
    alert(data.message || (data.ok ? 'Done' : 'Failed'));
    fetchDashboard();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function startDashboardRefresh() {
  fetchDashboard();
  if (dashboardTimer) clearInterval(dashboardTimer);
  dashboardTimer = setInterval(fetchDashboard, 15000);
}
function stopDashboardRefresh() {
  if (dashboardTimer) { clearInterval(dashboardTimer); dashboardTimer = null; }
}

// ═══════════════════════════════════════
// LEADERBOARD
// ═══════════════════════════════════════
async function loadLeaderboard() {
  try {
    const resp = await fetch('/data/leaderboard.json');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    lbData = await resp.json();
    lbLoaded = true;
    buildFilters();
    renderLeaderboard();
  } catch (e) {
    document.getElementById('lb-body').innerHTML = `<tr><td colspan="16" class="text-red" style="text-align:center;padding:2rem;">Failed to load leaderboard: ${esc(e.message)}</td></tr>`;
  }
}

function buildFilters() {
  const runs = lbData.runs;
  const pairs = [...new Set(runs.map(r => r.pair))].sort();
  const tfs = [...new Set(runs.map(r => r.timeframe))].sort();
  const ratings = ['GREEN', 'YELLOW', 'RED'];
  const statuses = [...new Set(runs.map(r => r.status))].sort();

  const container = document.getElementById('lb-filters');
  container.innerHTML = '';

  function addGroup(label, key, values) {
    const div = document.createElement('div');
    div.className = 'filter-group';
    div.innerHTML = `<label>${label}</label>`;
    values.forEach(v => {
      const btn = document.createElement('button');
      btn.className = 'filter-btn';
      btn.textContent = v;
      btn.onclick = () => {
        if (lbFilters[key] === v) { lbFilters[key] = null; btn.classList.remove('active'); }
        else {
          div.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          lbFilters[key] = v;
          btn.classList.add('active');
        }
        renderLeaderboard();
      };
      div.appendChild(btn);
    });
    container.appendChild(div);
  }

  addGroup('Pair', 'pair', pairs);
  addGroup('TF', 'timeframe', tfs);
  addGroup('Rating', 'rating', ratings);
  addGroup('Status', 'status', statuses);

  // Generated timestamp
  if (lbData.generated_at) {
    const span = document.createElement('span');
    span.className = 'text-muted';
    span.style.marginLeft = 'auto';
    span.style.fontSize = '0.7rem';
    span.textContent = 'Data: ' + lbData.generated_at;
    container.appendChild(span);
  }
}

function getFilteredRuns() {
  let runs = lbData.runs;
  if (lbFilters.pair) runs = runs.filter(r => r.pair === lbFilters.pair);
  if (lbFilters.timeframe) runs = runs.filter(r => r.timeframe === lbFilters.timeframe);
  if (lbFilters.rating) runs = runs.filter(r => r.rating === lbFilters.rating);
  if (lbFilters.status) runs = runs.filter(r => r.status === lbFilters.status);

  // Sort
  const key = lbSort.key;
  const dir = lbSort.dir;
  runs.sort((a, b) => {
    let va = a[key], vb = b[key];
    if (va == null) va = '';
    if (vb == null) vb = '';
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * dir;
    return String(va).localeCompare(String(vb)) * dir;
  });
  return runs;
}

function renderLeaderboard() {
  const runs = getFilteredRuns();
  const tbody = document.getElementById('lb-body');

  if (!runs.length) {
    tbody.innerHTML = '<tr><td colspan="16" class="text-dim" style="text-align:center;padding:2rem;">No runs match filters</td></tr>';
    return;
  }

  tbody.innerHTML = runs.map(r => {
    const ratingClass = r.rating === 'GREEN' ? 'badge-green' : r.rating === 'YELLOW' ? 'badge-yellow' : 'badge-red';
    const statusClass = r.status === 'COMPLETE' ? 'badge-blue' : r.status === 'FAILED' ? 'badge-red' : 'badge-gray';
    const checked = lbSelected.has(r.run_id) ? 'checked' : '';
    const fb = r.forward_back_ratio;
    const fbStr = fb ? (fb * 100).toFixed(1) + '%' : '—';

    return `<tr style="cursor:pointer;" onclick="showDetail('${r.run_id}')">
      <td onclick="event.stopPropagation()"><input type="checkbox" class="cb" ${checked} onchange="toggleSelect('${r.run_id}', this.checked)"></td>
      <td class="mono">${esc(r.pair)}</td>
      <td class="mono">${esc(r.timeframe)}</td>
      <td>${shortStrategy(r.strategy)}</td>
      <td class="mono text-right">${r.score ? r.score.toFixed(1) : '0'}</td>
      <td><span class="badge ${ratingClass}">${r.rating || '—'}</span></td>
      <td class="mono text-right">${r.back_return ? r.back_return.toFixed(1) : '0'}%</td>
      <td class="mono text-right">${r.forward_return ? r.forward_return.toFixed(1) : '0'}%</td>
      <td class="mono text-right">${fbStr}</td>
      <td class="mono text-right">${r.back_trades || 0}</td>
      <td class="mono text-right">${r.win_rate ? (r.win_rate * 100).toFixed(1) : '0'}%</td>
      <td class="mono text-right">${r.back_max_dd ? r.back_max_dd.toFixed(1) : '0'}%</td>
      <td class="mono text-right">${r.back_sharpe ? r.back_sharpe.toFixed(2) : '—'}</td>
      <td><span class="badge ${statusClass}">${r.status || '—'}</span></td>
      <td class="text-muted">${r.created ? r.created.substring(0, 10) : '—'}</td>
      <td class="text-dim" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;">${esc(r.description || '')}</td>
    </tr>`;
  }).join('');

  // Update sort arrows
  document.querySelectorAll('#lb-table th[data-sort]').forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.remove();
    if (th.dataset.sort === lbSort.key) {
      const span = document.createElement('span');
      span.className = 'sort-arrow';
      span.textContent = lbSort.dir === 1 ? '▲' : '▼';
      th.appendChild(span);
    }
  });

  updateCompareToolbar();
}

// Sort handler
document.querySelectorAll('#lb-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (lbSort.key === key) lbSort.dir *= -1;
    else { lbSort.key = key; lbSort.dir = -1; }
    renderLeaderboard();
  });
});

// Selection / Compare
function toggleSelect(runId, checked) {
  if (checked) lbSelected.add(runId); else lbSelected.delete(runId);
  updateCompareToolbar();
}

function updateCompareToolbar() {
  const toolbar = document.getElementById('compare-toolbar');
  document.getElementById('compare-count').textContent = lbSelected.size;
  toolbar.classList.toggle('show', lbSelected.size >= 2);
}

function clearCompare() {
  lbSelected.clear();
  document.querySelectorAll('#lb-body .cb').forEach(cb => cb.checked = false);
  updateCompareToolbar();
  document.getElementById('lb-detail').style.display = 'none';
  lbDetailId = null;
}

function showCompare() {
  if (lbSelected.size < 2) return;
  const panel = document.getElementById('lb-detail');
  const compare = lbData.compare || {};
  const selectedRuns = lbData.runs.filter(r => lbSelected.has(r.run_id));

  // Build traces for equity overlay
  const traces = [];
  const colors = ['#3b82f6', '#22c55e', '#f97316', '#a855f7', '#ef4444', '#06b6d4', '#eab308'];

  selectedRuns.forEach((r, i) => {
    const c = compare[r.run_id];
    const color = colors[i % colors.length];
    if (c && c.back_equity && c.back_equity.length) {
      traces.push({
        x: c.back_equity.map(p => p.timestamp || p.date || p.x),
        y: c.back_equity.map(p => p.equity || p.y),
        name: `${r.pair} ${r.timeframe} #${r.score?.toFixed(0) || '?'} (back)`,
        line: { color, width: 2 },
        type: 'scatter'
      });
    }
    if (c && c.forward_equity && c.forward_equity.length) {
      traces.push({
        x: c.forward_equity.map(p => p.timestamp || p.date || p.x),
        y: c.forward_equity.map(p => p.equity || p.y),
        name: `${r.pair} ${r.timeframe} #${r.score?.toFixed(0) || '?'} (fwd)`,
        line: { color, width: 2, dash: 'dash' },
        type: 'scatter'
      });
    }
  });

  // Metrics comparison table
  const metricKeys = [
    ['Score', 'score', v => v?.toFixed(1) || '0'],
    ['Rating', 'rating', v => v || '—'],
    ['Back Return%', 'back_return', v => v?.toFixed(1) + '%' || '0%'],
    ['Fwd Return%', 'forward_return', v => v?.toFixed(1) + '%' || '0%'],
    ['F/B Ratio', 'forward_back_ratio', v => v ? (v * 100).toFixed(1) + '%' : '—'],
    ['Trades', 'back_trades', v => v || 0],
    ['WR%', 'win_rate', v => v ? (v * 100).toFixed(1) + '%' : '0%'],
    ['MaxDD%', 'back_max_dd', v => v?.toFixed(1) + '%' || '0%'],
    ['Sharpe', 'back_sharpe', v => v?.toFixed(2) || '—'],
  ];

  panel.innerHTML = `
    <div class="detail-header">
      <h3>Comparison: ${selectedRuns.length} runs</h3>
      <button class="btn" onclick="document.getElementById('lb-detail').style.display='none'">Close</button>
    </div>
    <div id="compare-chart" style="height:350px;margin-bottom:1rem;"></div>
    <div style="overflow-x:auto;">
      <table>
        <thead><tr>
          <th>Metric</th>
          ${selectedRuns.map(r => `<th class="text-right">${r.pair} ${r.timeframe}<br><span class="text-muted">${r.created?.substring(0, 10) || ''}</span></th>`).join('')}
        </tr></thead>
        <tbody>
          ${metricKeys.map(([label, key, fmt]) => `<tr>
            <td>${label}</td>
            ${selectedRuns.map(r => `<td class="mono text-right">${fmt(r[key])}</td>`).join('')}
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  if (traces.length) {
    Plotly.newPlot('compare-chart', traces, {
      paper_bgcolor: '#111827',
      plot_bgcolor: '#0a0e1a',
      font: { color: '#94a3b8', family: 'Inter, sans-serif', size: 11 },
      margin: { t: 20, r: 20, b: 40, l: 60 },
      xaxis: { gridcolor: '#1e293b', linecolor: '#1e293b' },
      yaxis: { gridcolor: '#1e293b', linecolor: '#1e293b', title: 'Equity' },
      legend: { orientation: 'h', y: -0.15, font: { size: 10 } },
      showlegend: true
    }, { responsive: true, displayModeBar: false });
  }
}

// Detail panel for single run
function showDetail(runId) {
  if (lbDetailId === runId) {
    document.getElementById('lb-detail').style.display = 'none';
    lbDetailId = null;
    return;
  }
  lbDetailId = runId;
  const panel = document.getElementById('lb-detail');
  const run = lbData.runs.find(r => r.run_id === runId);
  const comp = (lbData.compare || {})[runId];
  if (!run) return;

  const ratingClass = run.rating === 'GREEN' ? 'badge-green' : run.rating === 'YELLOW' ? 'badge-yellow' : 'badge-red';

  // Metrics
  const fb = run.forward_back_ratio;
  const metrics = [
    ['Score', run.score?.toFixed(1) || '0'],
    ['Rating', `<span class="badge ${ratingClass}">${run.rating || '—'}</span>`],
    ['Back Return%', (run.back_return?.toFixed(1) || '0') + '%'],
    ['Fwd Return%', (run.forward_return?.toFixed(1) || '0') + '%'],
    ['F/B Ratio', fb ? (fb * 100).toFixed(1) + '%' : '—'],
    ['Back Trades', run.back_trades || 0],
    ['Fwd Trades', run.forward_trades || 0],
    ['Win Rate', run.win_rate ? (run.win_rate * 100).toFixed(1) + '%' : '0%'],
    ['MaxDD%', (run.back_max_dd?.toFixed(1) || '0') + '%'],
    ['Sharpe', run.back_sharpe?.toFixed(2) || '—'],
    ['Candidates', run.n_candidates || 0],
    ['Time', run.total_time_min ? run.total_time_min.toFixed(1) + ' min' : '—'],
  ];

  // Extra compare metrics
  let extraMetrics = '';
  if (comp) {
    const extras = [
      ['R² (back)', comp.back_r_squared?.toFixed(3)],
      ['R² (fwd)', comp.forward_r_squared?.toFixed(3)],
      ['PF', comp.back_profit_factor?.toFixed(2) || comp.profit_factor?.toFixed(2)],
      ['Stability', comp.stability_mean?.toFixed(1)],
    ].filter(([_, v]) => v != null);
    extraMetrics = extras.map(([l, v]) => `
      <div class="metric-item">
        <div class="metric-label">${l}</div>
        <div class="metric-value">${v}</div>
      </div>`).join('');
  }

  panel.innerHTML = `
    <div class="detail-header">
      <h3>${esc(run.pair)} ${esc(run.timeframe)} — ${shortStrategy(run.strategy)}</h3>
      <div>
        <span class="text-muted" style="margin-right:0.75rem;font-size:0.75rem;">${esc(run.run_id)}</span>
        <button class="btn" onclick="document.getElementById('lb-detail').style.display='none';lbDetailId=null;">Close</button>
      </div>
    </div>
    ${run.description ? `<p class="text-dim" style="margin-bottom:0.75rem;font-size:0.8rem;">${esc(run.description)}</p>` : ''}
    <div class="metrics-grid">
      ${metrics.map(([l, v]) => `<div class="metric-item"><div class="metric-label">${l}</div><div class="metric-value">${v}</div></div>`).join('')}
      ${extraMetrics}
    </div>
    <div id="detail-chart" style="height:300px;"></div>`;

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Plot equity curve
  if (comp) {
    const traces = [];
    if (comp.back_equity && comp.back_equity.length) {
      traces.push({
        x: comp.back_equity.map(p => p.timestamp || p.date || p.x),
        y: comp.back_equity.map(p => p.equity || p.y),
        name: 'Backtest',
        line: { color: '#3b82f6', width: 2 },
        type: 'scatter'
      });
    }
    if (comp.forward_equity && comp.forward_equity.length) {
      traces.push({
        x: comp.forward_equity.map(p => p.timestamp || p.date || p.x),
        y: comp.forward_equity.map(p => p.equity || p.y),
        name: 'Forward',
        line: { color: '#22c55e', width: 2, dash: 'dash' },
        type: 'scatter'
      });
    }
    if (traces.length) {
      Plotly.newPlot('detail-chart', traces, {
        paper_bgcolor: '#111827',
        plot_bgcolor: '#0a0e1a',
        font: { color: '#94a3b8', family: 'Inter, sans-serif', size: 11 },
        margin: { t: 10, r: 20, b: 40, l: 60 },
        xaxis: { gridcolor: '#1e293b', linecolor: '#1e293b' },
        yaxis: { gridcolor: '#1e293b', linecolor: '#1e293b', title: 'Equity ($)' },
        legend: { orientation: 'h', y: -0.2 },
        showlegend: true
      }, { responsive: true, displayModeBar: false });
    }
  }
}

// ═══════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}
function num(v, dec = 2) { return v != null ? Number(v).toFixed(dec) : '—'; }
function pct(v) { return v != null ? (Number(v) * 100).toFixed(1) + '%' : '—'; }
function shortTime(iso) {
  if (!iso) return '—';
  return iso.replace('T', ' ').substring(0, 16);
}
function shortStrategy(s) {
  if (!s) return '—';
  return s.replace('RSI_Divergence_', 'RSI ').replace('EMA_Cross_ML', 'EMA Cross').replace('_Full', '');
}

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
(function init() {
  const hash = location.hash.replace('#', '') || 'dashboard';
  if (hash === 'leaderboard' || hash === 'pipeline') {
    switchView('leaderboard');
  } else {
    switchView('dashboard');
  }
})();
</script>
</body>
</html>
