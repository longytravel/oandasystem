<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OANDA Trading System</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0a0e1a;
    color: #e2e8f0;
    min-height: 100vh;
    line-height: 1.5;
    padding-bottom: 70px;
  }
  a { color: #3b82f6; text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* ── NAV ── */
  .nav {
    background: #111827;
    border-bottom: 1px solid #1e293b;
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center;
    padding: 0 32px; gap: 0;
  }
  .nav-brand {
    font-weight: 700; font-size: 1rem; color: #3b82f6;
    margin-right: 24px; white-space: nowrap; padding: 12px 0;
    font-family: 'JetBrains Mono', monospace;
  }
  .nav-tab {
    padding: 12px 20px; color: #5a6a80; cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s; font-size: 0.85rem; font-weight: 500; user-select: none;
  }
  .nav-tab:hover { color: #e2e8f0; }
  .nav-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
  .nav-right {
    margin-left: auto; display: flex; align-items: center; gap: 12px;
    font-size: 0.75rem; color: #5a6a80; font-family: 'JetBrains Mono', monospace;
  }

  /* ── VIEWS ── */
  .view { display: none; }
  .view.active { display: block; }

  /* ══════════════════════════════════════
     DASHBOARD VIEW
     ══════════════════════════════════════ */
  .dash-container { max-width: 1400px; margin: 0 auto; padding: 20px 32px; }
  .cards {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .card {
    background: #111827; border: 1px solid #1e293b; border-radius: 8px; padding: 16px;
  }
  .card-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em; color: #5a6a80; margin-bottom: 4px; }
  .card-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  .banner {
    padding: 10px 16px; border-radius: 6px; margin-bottom: 16px;
    font-size: 0.82rem; display: none;
    background: rgba(239,68,68,0.1); border: 1px solid #dc2626; color: #ef4444;
  }
  .banner.show { display: block; }

  .dash-table { overflow-x: auto; background: #111827; border: 1px solid #1e293b; border-radius: 8px; }
  .dash-table table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .dash-table th {
    text-align: left; padding: 10px 12px; font-size: 0.68rem;
    text-transform: uppercase; letter-spacing: 0.04em; color: #5a6a80;
    border-bottom: 1px solid #1e293b; background: #111827;
  }
  .dash-table td { padding: 8px 12px; border-bottom: 1px solid rgba(30,41,59,0.4); white-space: nowrap; }
  .dash-table tr:hover td { background: rgba(255,255,255,0.02); }

  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot-green { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
  .dot-yellow { background: #eab308; box-shadow: 0 0 6px #eab308; }
  .dot-red { background: #ef4444; box-shadow: 0 0 6px #ef4444; }

  .btn {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 4px; border: 1px solid #334155;
    background: #1e293b; color: #8896ab; font-size: 0.7rem;
    cursor: pointer; transition: all 0.15s; font-family: 'Inter', sans-serif;
  }
  .btn:hover { background: #334155; color: #e2e8f0; }
  .btn-danger { border-color: #dc2626; color: #ef4444; }
  .btn-danger:hover { background: rgba(239,68,68,0.15); }

  .expand-panel { display: none; padding: 16px; background: #0a0e1a; border-bottom: 1px solid #1e293b; }
  .expand-panel.open { display: block; }
  .expand-panel table { max-width: 600px; }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 0.75rem; font-weight: 600; font-family: 'JetBrains Mono', monospace;
  }
  .badge-green { background: #065f46; color: #10b981; }
  .badge-yellow { background: #78350f; color: #f59e0b; }
  .badge-red { background: #7f1d1d; color: #ef4444; }
  .badge-blue { background: rgba(59,130,246,0.15); color: #3b82f6; }

  /* ══════════════════════════════════════
     LEADERBOARD VIEW (matching generate_index.py)
     ══════════════════════════════════════ */
  .page-header {
    padding: 24px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 16px;
  }
  .page-title { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  .page-subtitle { font-size: 0.78rem; color: #5a6a80; }
  .summary-strip { display: flex; gap: 24px; flex-wrap: wrap; }
  .summary-item { text-align: center; }
  .summary-num { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; }
  .summary-label { font-size: 0.68rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.05em; }

  .filter-bar {
    padding: 12px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: #0d1320;
  }
  .filter-group { display: flex; align-items: center; gap: 4px; }
  .filter-label { font-size: 0.7rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.04em; margin-right: 4px; }
  .filter-btn {
    background: #111827; border: 1px solid #1e293b; color: #8896ab;
    padding: 4px 10px; border-radius: 4px; font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s;
  }
  .filter-btn:hover { border-color: #3b82f6; color: #e2e8f0; }
  .filter-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #3b82f6; }
  .filter-btn.clear-btn { background: transparent; border-color: transparent; color: #5a6a80; font-family: 'Inter', sans-serif; }
  .filter-btn.clear-btn:hover { color: #ef4444; }

  .table-container { padding: 0 16px; overflow-x: auto; }
  #leaderboard { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 8px; }
  #leaderboard th {
    padding: 10px 10px; text-align: left; font-weight: 500; color: #5a6a80;
    text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.68rem;
    border-bottom: 1px solid #1e293b; cursor: pointer; user-select: none;
    white-space: nowrap; position: sticky; top: 47px; background: #0a0e1a; z-index: 10;
  }
  #leaderboard th:hover { color: #8896ab; }
  #leaderboard th.sort-asc::after { content: ' \25B2'; font-size: 0.6rem; }
  #leaderboard th.sort-desc::after { content: ' \25BC'; font-size: 0.6rem; }
  #leaderboard th.no-sort { cursor: default; }
  #leaderboard th.no-sort:hover { color: #5a6a80; }
  #leaderboard td {
    padding: 8px 10px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; white-space: nowrap;
  }
  #leaderboard tr:hover td { background: rgba(255,255,255,0.02); }
  #leaderboard tr.hidden { display: none; }
  .score-col { font-size: 1rem; }
  .strategy-col { font-family: 'Inter', sans-serif; color: #8896ab; font-size: 0.75rem; }
  .desc-col { font-family: 'Inter', sans-serif; color: #6b7f99; font-size: 0.7rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .runid-col { font-size: 0.68rem; color: #5a6a80; }
  .compare-check { width: 16px; height: 16px; cursor: pointer; accent-color: #3b82f6; }

  /* Compare toolbar */
  .compare-toolbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #111827; border-top: 2px solid #3b82f6;
    padding: 12px 32px; display: flex; align-items: center; gap: 16px;
    z-index: 1000; transform: translateY(100%); transition: transform 0.25s ease;
  }
  .compare-toolbar.visible { transform: translateY(0); }
  .compare-toolbar .count { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #3b82f6; font-weight: 600; }
  .compare-toolbar button {
    padding: 8px 20px; border-radius: 6px; font-family: 'Inter', sans-serif;
    font-size: 0.82rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s;
  }
  .compare-toolbar .btn-compare { background: #3b82f6; color: white; }
  .compare-toolbar .btn-compare:hover { background: #2563eb; }
  .compare-toolbar .btn-clear { background: transparent; color: #5a6a80; border: 1px solid #1e293b; }
  .compare-toolbar .btn-clear:hover { color: #ef4444; border-color: #ef4444; }

  /* Compare section */
  #compare-section { display: none; padding: 24px 32px; border-top: 2px solid #3b82f6; margin-top: 16px; }
  #compare-section.visible { display: block; }
  .compare-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .compare-title { font-size: 1.1rem; font-weight: 700; color: #3b82f6; }
  .compare-close {
    background: transparent; border: 1px solid #1e293b; color: #5a6a80;
    padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.78rem;
  }
  .compare-close:hover { color: #ef4444; border-color: #ef4444; }
  .compare-chart-panel { background: #111827; border: 1px solid #1e293b; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
  .compare-chart-header { padding: 12px 16px; border-bottom: 1px solid #1e293b; font-size: 0.82rem; font-weight: 600; color: #8896ab; }
  .compare-metrics-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .compare-metrics-table th {
    position: static; padding: 10px 14px; text-align: left; font-weight: 600;
    color: #5a6a80; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.04em;
    border-bottom: 1px solid #1e293b; background: #0d1320; cursor: default;
  }
  .compare-metrics-table th:hover { color: #5a6a80; }
  .compare-metrics-table td {
    padding: 8px 14px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
  }
  .compare-metrics-table .metric-label-col { color: #8896ab; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 0.78rem; width: 140px; }
  .compare-metrics-table .best-val { color: #10b981; font-weight: 600; }

  .text-green { color: #10b981; }
  .text-red { color: #ef4444; }
  .text-dim { color: #5a6a80; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .text-right { text-align: right; }
  .footer { text-align: center; padding: 16px; color: #5a6a80; font-size: 0.7rem; border-top: 1px solid #1e293b; margin-top: 20px; }

  /* Run detail panel - full-screen overlay */
  #leaderboard tr[data-run] { cursor: pointer; }
  .runid-col a { cursor: pointer; }
  .run-detail { display: none; }
  .run-detail.visible {
    display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 200; background: #0a0e1a; overflow-y: auto; padding: 0;
  }
  .rd-inner { max-width: 1200px; margin: 0 auto; padding: 32px 40px; }
  body.rd-open { overflow: hidden; }

  .rd-header {
    padding: 28px 32px; background: #111827; border: 1px solid #1e293b;
    border-radius: 8px; margin: 0 0 20px;
  }
  .rd-title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
  .rd-title { font-size: 1.4rem; font-weight: 700; }
  .rd-meta { font-size: 0.8rem; color: #5a6a80; margin-top: 4px; word-break: break-all; }
  .rd-score-block { text-align: right; flex-shrink: 0; }
  .rd-score-big { font-size: 2.8rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; line-height: 1; }
  .rd-recommendation { font-size: 0.72rem; color: #8896ab; margin-top: 4px; font-style: italic; max-width: 200px; text-align: right; }
  .rd-config-strip {
    display: flex; gap: 14px; flex-wrap: wrap; margin-top: 10px;
    padding-top: 10px; border-top: 1px solid #1e293b;
  }
  .rd-config-item { font-size: 0.78rem; color: #5a6a80; font-family: 'JetBrains Mono', monospace; }
  .rd-config-item span { color: #8896ab; }
  .rd-close-btn {
    position: sticky; top: 0; z-index: 10; display: flex; justify-content: flex-end;
    padding: 12px 0 8px; background: #0a0e1a;
  }
  .rd-close-btn button {
    padding: 10px 20px; border-radius: 6px; font-size: 0.88rem;
    font-family: 'Inter', sans-serif; font-weight: 600;
    background: #1e293b; border: 1px solid #334155; color: #8896ab;
    cursor: pointer; transition: all 0.15s;
  }
  .rd-close-btn button:hover { background: #334155; color: #e2e8f0; }

  /* Sections */
  .rd-section {
    margin: 0 0 16px; background: #111827;
    border: 1px solid #1e293b; border-radius: 8px; overflow: hidden;
  }
  .rd-section-head {
    padding: 14px 24px; cursor: pointer; display: flex;
    align-items: center; justify-content: space-between;
    border-left: 4px solid var(--rd-accent, #3b82f6); user-select: none;
  }
  .rd-section-head:hover { background: rgba(255,255,255,0.02); }
  .rd-section-head h3 {
    font-size: 0.9rem; font-weight: 600; color: #8896ab;
    text-transform: uppercase; letter-spacing: 0.05em; margin: 0;
  }
  .rd-chevron { color: #5a6a80; font-size: 0.7rem; transition: transform 0.2s; }
  .rd-section.collapsed .rd-section-body { display: none; }
  .rd-section.collapsed .rd-chevron { transform: rotate(-90deg); }
  .rd-section-body { padding: 24px 28px; border-top: 1px solid #1e293b; }

  /* Performance table */
  .rd-perf-table { width: 100%; border-collapse: collapse; }
  .rd-perf-table th {
    padding: 10px 16px; text-align: right; font-size: 0.78rem;
    color: #5a6a80; text-transform: uppercase; letter-spacing: 0.04em;
    border-bottom: 1px solid #1e293b; position: static; cursor: default; width: 33%;
  }
  .rd-perf-table th:first-child { text-align: left; }
  .rd-perf-table th:hover { color: #5a6a80; }
  .rd-perf-table td {
    padding: 10px 16px; font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem; text-align: right; border-bottom: 1px solid rgba(30,41,59,0.3);
  }
  .rd-perf-table td:first-child { text-align: left; font-family: 'Inter', sans-serif; color: #8896ab; font-weight: 500; font-size: 0.88rem; }
  .rd-fb-banner {
    text-align: center; padding: 14px; margin-top: 14px;
    background: #0d1320; border-radius: 6px;
  }
  .rd-fb-label { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; }
  .rd-fb-value { font-size: 1.6rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

  /* Confidence bars */
  .rd-conf-total { text-align: center; margin-bottom: 18px; padding: 14px; background: #0d1320; border-radius: 6px; }
  .rd-conf-total .score { font-size: 2.2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
  .rd-conf-total .label { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; margin-top: 2px; }
  .rd-conf-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .rd-conf-label { width: 120px; font-size: 0.82rem; color: #8896ab; flex-shrink: 0; }
  .rd-conf-bar-bg { flex: 1; height: 24px; background: #0d1320; border-radius: 4px; overflow: hidden; }
  .rd-conf-bar-fill { height: 100%; border-radius: 4px; min-width: 2px; }
  .rd-conf-score { width: 40px; text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.88rem; flex-shrink: 0; }
  .rd-conf-weight { width: 36px; text-align: right; font-size: 0.72rem; color: #5a6a80; flex-shrink: 0; }

  /* WF table */
  .rd-wf-summary { margin-bottom: 12px; font-size: 0.92rem; }
  .rd-wf-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .rd-wf-table th {
    padding: 8px 10px; text-align: right; font-size: 0.72rem;
    color: #5a6a80; text-transform: uppercase; border-bottom: 1px solid #1e293b;
    background: #0d1320; position: static; cursor: default;
  }
  .rd-wf-table th:first-child, .rd-wf-table th:nth-child(2) { text-align: center; }
  .rd-wf-table th:hover { color: #5a6a80; }
  .rd-wf-table td {
    padding: 7px 10px; font-family: 'JetBrains Mono', monospace;
    text-align: right; border-bottom: 1px solid rgba(30,41,59,0.25); font-size: 0.82rem;
  }
  .rd-wf-table td:first-child, .rd-wf-table td:nth-child(2) { text-align: center; }
  .rd-wf-table tr.wf-fail td { opacity: 0.5; }
  .rd-wf-table tr.wf-oos td { background: rgba(59,130,246,0.04); }
  .rd-wf-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }

  /* MC cards */
  .rd-mc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .rd-mc-card { background: #0d1320; border-radius: 6px; padding: 20px; }
  .rd-mc-card-title { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; margin-bottom: 8px; font-weight: 600; }
  .rd-mc-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.88rem; }
  .rd-mc-row .lbl { color: #8896ab; font-size: 0.82rem; }
  .rd-mc-row .val { font-family: 'JetBrains Mono', monospace; }

  /* Stability */
  .rd-stab-grid { display: flex; gap: 16px; flex-wrap: wrap; }
  .rd-stab-card { background: #0d1320; border-radius: 6px; padding: 18px 28px; text-align: center; min-width: 120px; }
  .rd-stab-card .val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .rd-stab-card .lbl { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; margin-top: 3px; }

  /* Trade analysis */
  .rd-trade-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 14px; }
  .rd-trade-card { background: #0d1320; border-radius: 6px; padding: 14px 18px; }
  .rd-trade-card .lbl { font-size: 0.72rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; }
  .rd-trade-card .val { font-size: 1.2rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .rd-exit-table { width: 100%; border-collapse: collapse; max-width: 500px; }
  .rd-exit-table td { padding: 3px 8px; font-size: 0.75rem; border-bottom: 1px solid rgba(30,41,59,0.25); }
  .rd-exit-table td:first-child { color: #8896ab; }
  .rd-exit-table td:nth-child(2) { font-family: 'JetBrains Mono', monospace; text-align: right; width: 60px; }
  .rd-exit-table td:nth-child(3) { width: 120px; }
  .rd-exit-bar { display: inline-block; height: 10px; border-radius: 2px; vertical-align: middle; }

  /* Monthly heatmap */
  .rd-monthly-table { border-collapse: collapse; font-size: 0.82rem; }
  .rd-monthly-table th {
    padding: 6px 10px; font-size: 0.68rem; color: #5a6a80;
    text-transform: uppercase; border-bottom: 1px solid #1e293b;
    text-align: center; position: static; cursor: default;
  }
  .rd-monthly-table th:hover { color: #5a6a80; }
  .rd-monthly-table td {
    padding: 6px 10px; text-align: center; font-family: 'JetBrains Mono', monospace;
    border: 1px solid rgba(30,41,59,0.25); min-width: 54px; font-size: 0.82rem;
  }
  .rd-monthly-table td:first-child { font-weight: 700; color: #8896ab; border-left: none; }

  /* Params table */
  .rd-params-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 24px; }
  @media (max-width: 700px) { .rd-params-grid { grid-template-columns: 1fr; } }
  .rd-params-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .rd-params-table td { padding: 6px 12px; border-bottom: 1px solid rgba(30,41,59,0.2); }
  .rd-params-table td:first-child { color: #8896ab; width: 50%; }
  .rd-params-table td:last-child { font-family: 'JetBrains Mono', monospace; }

  /* ══════════════════════════════════════
     MOBILE RESPONSIVE
     ══════════════════════════════════════ */
  @media (max-width: 768px) {
    /* Nav */
    .nav { padding: 0 12px; }
    .nav-brand { font-size: 0.85rem; margin-right: 12px; }
    .nav-tab { padding: 10px 14px; font-size: 0.78rem; min-height: 44px; display: flex; align-items: center; }
    .nav-right { font-size: 0.68rem; gap: 8px; }

    /* Dashboard */
    .dash-container { padding: 12px; }
    .cards { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
    .card { padding: 12px; }
    .card-value { font-size: 1.2rem; }
    .dash-table table { font-size: 0.75rem; }
    .dash-table th, .dash-table td { padding: 6px 8px; }
    .dash-table th:nth-child(5), .dash-table td:nth-child(5),
    .dash-table th:nth-child(7), .dash-table td:nth-child(7) { display: none; }
    .btn { padding: 6px 8px; font-size: 0.68rem; min-height: 36px; }

    /* Leaderboard header */
    .page-header { padding: 16px; flex-direction: column; align-items: flex-start; gap: 12px; }
    .page-title { font-size: 1.1rem; }
    .summary-strip { gap: 16px; }
    .summary-num { font-size: 1.1rem; }
    .summary-label { font-size: 0.62rem; }

    /* Filter bar - horizontal scroll */
    .filter-bar {
      padding: 10px 12px; gap: 8px; overflow-x: auto;
      -webkit-overflow-scrolling: touch; flex-wrap: nowrap;
    }
    .filter-group { flex-shrink: 0; }
    .filter-btn { padding: 6px 8px; font-size: 0.7rem; min-height: 36px; touch-action: manipulation; }

    /* Leaderboard table */
    .table-container { padding: 0 8px; -webkit-overflow-scrolling: touch; }
    #leaderboard { font-size: 0.72rem; }
    #leaderboard th, #leaderboard td { padding: 6px 6px; }
    #leaderboard td { font-size: 0.7rem; }
    .score-col { font-size: 0.88rem; }
    /* Hide: Strategy(4), Description(5), BackSh(11), FwdSh(12), MaxDD(15), Time(18), RunID(19) */
    #leaderboard th:nth-child(4), #leaderboard td:nth-child(4),
    #leaderboard th:nth-child(5), #leaderboard td:nth-child(5),
    #leaderboard th:nth-child(11), #leaderboard td:nth-child(11),
    #leaderboard th:nth-child(12), #leaderboard td:nth-child(12),
    #leaderboard th:nth-child(15), #leaderboard td:nth-child(15),
    #leaderboard th:nth-child(18), #leaderboard td:nth-child(18),
    #leaderboard th:nth-child(19), #leaderboard td:nth-child(19) { display: none; }
    .compare-check { width: 20px; height: 20px; }

    /* Compare */
    #compare-section { padding: 16px; }
    #compare-chart { height: 280px !important; }
    .compare-toolbar { padding: 10px 16px; gap: 10px; }
    .compare-toolbar button { padding: 8px 14px; font-size: 0.78rem; min-height: 44px; touch-action: manipulation; }
    .compare-metrics-table th, .compare-metrics-table td { padding: 6px 8px; font-size: 0.72rem; }

    /* Run Detail */
    .rd-inner { padding: 16px; }
    .rd-header { padding: 18px 16px; }
    .rd-title { font-size: 1.1rem; }
    .rd-score-big { font-size: 2rem; }
    .rd-score-big > span { font-size: 0.75rem !important; }
    .rd-recommendation { font-size: 0.68rem; max-width: 140px; }
    .rd-config-strip { gap: 8px; }
    .rd-config-item { font-size: 0.72rem; }
    .rd-close-btn button { padding: 8px 14px; font-size: 0.82rem; min-height: 44px; touch-action: manipulation; }

    /* Charts */
    #rd-equity-chart { height: 280px !important; }
    #rd-dd-chart { height: 180px !important; }

    /* Sections */
    .rd-section-body { padding: 16px; }
    .rd-section-head { padding: 12px 16px; min-height: 44px; touch-action: manipulation; }
    .rd-section-head h3 { font-size: 0.82rem; }

    /* Performance table */
    .rd-perf-table td { font-size: 0.82rem; padding: 8px 10px; }
    .rd-perf-table td:first-child { font-size: 0.8rem; }
    .rd-fb-value { font-size: 1.3rem; }

    /* Confidence */
    .rd-conf-label { width: 85px; font-size: 0.75rem; }
    .rd-conf-score { font-size: 0.82rem; }
    .rd-conf-total .score { font-size: 1.8rem; }

    /* MC grid - single column on mobile */
    .rd-mc-grid { grid-template-columns: 1fr; }
    .rd-mc-row { font-size: 0.82rem; }
    .rd-mc-row .lbl { font-size: 0.78rem; }

    /* Stability */
    .rd-stab-card { padding: 14px 18px; min-width: 100px; }
    .rd-stab-card .val { font-size: 1.2rem; }

    /* Trade grid - 2 columns */
    .rd-trade-grid { grid-template-columns: repeat(2, 1fr); }
    .rd-trade-card .val { font-size: 1rem; }

    /* WF table */
    .rd-wf-table { font-size: 0.72rem; }
    .rd-wf-table th, .rd-wf-table td { padding: 5px 6px; }

    /* Monthly table */
    .rd-monthly-table td { min-width: 40px; padding: 5px 6px; font-size: 0.72rem; }
    .rd-monthly-table th { padding: 5px 6px; font-size: 0.62rem; }

    /* Params - single column */
    .rd-params-grid { grid-template-columns: 1fr; }

    /* Footer */
    .footer { font-size: 0.65rem; padding: 12px; }
  }

  @media (max-width: 480px) {
    /* Nav - hide clock, tighter spacing */
    .nav-brand { font-size: 0.78rem; margin-right: 8px; }
    .nav-tab { padding: 10px 10px; font-size: 0.72rem; }
    .nav-right { display: none; }

    /* Dashboard cards - 2 columns fixed */
    .cards { grid-template-columns: repeat(2, 1fr); }
    .card-value { font-size: 1rem; }
    .card-label { font-size: 0.62rem; }
    /* Also hide Heartbeat column */
    .dash-table th:nth-child(4), .dash-table td:nth-child(4) { display: none; }

    /* Leaderboard - hide more: checkbox(1), Date(9), BackTr(13), FwdTr(14) */
    #leaderboard th:nth-child(1), #leaderboard td:nth-child(1),
    #leaderboard th:nth-child(9), #leaderboard td:nth-child(9),
    #leaderboard th:nth-child(13), #leaderboard td:nth-child(13),
    #leaderboard th:nth-child(14), #leaderboard td:nth-child(14) { display: none; }

    .summary-strip { gap: 10px; }
    .summary-num { font-size: 0.95rem; }

    /* Run detail - stack header vertically */
    .rd-title-row { flex-direction: column; }
    .rd-score-block { text-align: left; }
    .rd-score-big { font-size: 1.8rem; }
    .rd-title { font-size: 1rem; }
    .rd-meta { font-size: 0.72rem; }

    /* Even smaller charts */
    #rd-equity-chart { height: 240px !important; }
    #rd-dd-chart { height: 150px !important; }
    #compare-chart { height: 240px !important; }

    .rd-trade-card { padding: 10px 12px; }
    .rd-trade-card .val { font-size: 0.92rem; }
    .rd-stab-grid { gap: 8px; }
    .rd-stab-card { padding: 10px 14px; }
    .rd-stab-card .val { font-size: 1rem; }

    .compare-toolbar { flex-wrap: wrap; padding: 8px 12px; }
  }
</style>
</head>
<body>

<!-- ═══ NAVIGATION ═══ -->
<nav class="nav">
  <div class="nav-brand">OANDA System</div>
  <div class="nav-tab active" data-view="dashboard" onclick="switchView('dashboard')">Trading</div>
  <div class="nav-tab" data-view="leaderboard" onclick="switchView('leaderboard')">Pipeline</div>
  <div class="nav-right"><span id="clock"></span></div>
</nav>

<!-- ═══ DASHBOARD VIEW ═══ -->
<div id="view-dashboard" class="view active">
  <div class="dash-container">
    <div id="vps-banner" class="banner">VPS Offline &mdash; Live trading data unavailable. The Pipeline tab still works.</div>
    <div class="cards">
      <div class="card"><div class="card-label">Daily P&amp;L</div><div class="card-value mono" id="sum-pnl">&mdash;</div></div>
      <div class="card"><div class="card-label">Open Positions</div><div class="card-value mono" id="sum-positions">&mdash;</div></div>
      <div class="card"><div class="card-label">Trades Today</div><div class="card-value mono" id="sum-trades">&mdash;</div></div>
      <div class="card"><div class="card-label">Running</div><div class="card-value mono" id="sum-running">&mdash;</div></div>
      <div class="card"><div class="card-label">Errors</div><div class="card-value mono" id="sum-errors">&mdash;</div></div>
    </div>
    <div class="dash-table">
      <table>
        <thead><tr>
          <th>Status</th><th>Strategy</th><th>Pair / TF</th><th>Heartbeat</th>
          <th>Positions</th><th style="text-align:right">Daily P&L</th><th>W / L</th><th>Actions</th>
        </tr></thead>
        <tbody id="instances-body">
          <tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ LEADERBOARD VIEW ═══ -->
<div id="view-leaderboard" class="view">
  <div class="page-header">
    <div>
      <div class="page-title">Pipeline Leaderboard</div>
      <div class="page-subtitle" id="lb-subtitle">Loading...</div>
    </div>
    <div class="summary-strip" id="lb-summary"></div>
  </div>
  <div class="filter-bar" id="lb-filters"></div>
  <div class="table-container">
    <table id="leaderboard">
      <thead><tr>
        <th class="no-sort" style="width:36px">&nbsp;</th>
        <th data-col="1">Pair</th>
        <th data-col="2">TF</th>
        <th data-col="3">Strategy</th>
        <th data-col="4">Description</th>
        <th data-col="5">Score</th>
        <th data-col="6">Rating</th>
        <th data-col="7">Status</th>
        <th data-col="8">Date</th>
        <th data-col="9">Profit</th>
        <th data-col="10">Back Sh</th>
        <th data-col="11">Fwd Sh</th>
        <th data-col="12">Back Tr</th>
        <th data-col="13">Fwd Tr</th>
        <th data-col="14">Max DD</th>
        <th data-col="15">F/B Ratio</th>
        <th data-col="16">Win %</th>
        <th data-col="17">Time</th>
        <th data-col="18">Run ID</th>
      </tr></thead>
      <tbody id="lb-body">
        <tr><td colspan="19" style="text-align:center;padding:2rem;color:#5a6a80">Loading leaderboard...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Comparison Section -->
  <div id="compare-section">
    <div class="compare-header">
      <div class="compare-title">Strategy Comparison</div>
      <button class="compare-close" onclick="closeComparison()">Close</button>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Equity Curves Overlay</div>
      <div id="compare-chart" style="height:450px"></div>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Metrics Comparison</div>
      <div id="compare-metrics" style="padding:0"></div>
    </div>
  </div>

  <!-- Run Detail Panel (content generated by showRunDetail) -->
  <div class="run-detail" id="run-detail"></div>

  <div class="footer" id="lb-footer"></div>
</div>

<!-- Compare Toolbar -->
<div class="compare-toolbar" id="compare-toolbar">
  <span class="count"><span id="compare-count">0</span> selected</span>
  <button class="btn-compare" onclick="runComparison()">Compare</button>
  <button class="btn-clear" onclick="clearSelection()">Clear</button>
</div>

<script>
// ═══════════════════════════════════════
// GLOBALS
// ═══════════════════════════════════════
var COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
function isMobile() { return window.innerWidth < 768; }
function mobileLayout(l) {
  if (!isMobile()) return l;
  l.margin = { l: 40, r: 10, t: 10, b: 30 };
  if (l.font) l.font.size = 10;
  if (l.legend) l.legend.font = Object.assign({}, l.legend.font || {}, { size: 9 });
  if (l.xaxis && l.xaxis.tickfont) l.xaxis.tickfont.size = 9;
  if (l.yaxis && l.yaxis.tickfont) l.yaxis.tickfont.size = 9;
  return l;
}
var currentView = 'dashboard';
var dashTimer = null;
var lbData = null;
var lbLoaded = false;

// ═══════════════════════════════════════
// VIEW SWITCH
// ═══════════════════════════════════════
function switchView(v) {
  currentView = v;
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.view === v); });
  document.querySelectorAll('.view').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('view-' + v).classList.add('active');
  if (v === 'dashboard') { startDash(); } else { stopDash(); if (!lbLoaded) loadLeaderboard(); }
  history.replaceState(null, '', '#' + v);
}

// Clock
function updateClock() {
  var d = new Date();
  document.getElementById('clock').textContent = d.toLocaleTimeString('en-US', {hour12:false});
}
setInterval(updateClock, 1000); updateClock();

// ═══════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════
function esc(s) { if (s == null) return ''; var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
function num(v, dec) { return v != null ? Number(v).toFixed(dec||2) : '\u2014'; }

async function fetchDash() {
  try {
    var r = await fetch('/api/vps/status');
    if (!r.ok) {
      // Try to read error detail from JSON body
      try {
        var errData = await r.json();
        if (errData.traceback) console.error('VPS error:', errData.traceback);
        throw new Error(errData.message || 'HTTP ' + r.status);
      } catch(parseErr) {
        throw new Error('HTTP ' + r.status);
      }
    }
    var data = await r.json();
    if (data.error) throw new Error(data.message);
    document.getElementById('vps-banner').classList.remove('show');
    renderDash(data);
  } catch(e) {
    var banner = document.getElementById('vps-banner');
    banner.classList.add('show');
    banner.innerHTML = 'VPS Error &mdash; ' + esc(e.message) + '. The Pipeline tab still works.';
    renderDashOff();
  }
}

function renderDash(data) {
  var s = data.summary || {};
  var pnl = s.daily_pnl || 0;
  var el = function(id, v) { document.getElementById(id).textContent = v; };
  var pnlEl = document.getElementById('sum-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
  pnlEl.className = 'card-value mono ' + (pnl >= 0 ? 'text-green' : 'text-red');
  el('sum-positions', s.open_positions || 0);
  el('sum-trades', s.total_trades || 0);
  el('sum-running', (s.running||0) + '/' + (s.total||0));
  var errEl = document.getElementById('sum-errors');
  errEl.textContent = s.errors || 0;
  errEl.className = 'card-value mono' + ((s.errors||0) > 0 ? ' text-red' : '');

  var insts = data.instances || [];
  var tbody = document.getElementById('instances-body');
  if (!insts.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">No trading instances configured</td></tr>'; return; }

  tbody.innerHTML = insts.map(function(i) {
    var dot = i.heartbeat_ok ? 'dot-green' : (i.status === 'error' ? 'dot-red' : 'dot-yellow');
    var lbl = i.heartbeat_ok ? 'Running' : (i.status === 'error' ? 'Error' : (i.service_status === 'SERVICE_STOPPED' ? 'Stopped' : 'Stale'));
    var dp = i.daily_pnl || 0;
    var pc = dp >= 0 ? 'text-green' : 'text-red';
    return '<tr>' +
      '<td><span class="dot '+dot+'"></span>'+lbl+'</td>' +
      '<td>'+esc(i.strategy)+'<br><span class="text-dim" style="font-size:0.7rem">'+esc(i.id||'')+'</span></td>' +
      '<td class="mono">'+esc(i.pair)+' '+esc(i.timeframe)+'</td>' +
      '<td>'+(i.heartbeat_display||'\u2014')+'</td>' +
      '<td class="mono">'+(i.positions||0)+'</td>' +
      '<td class="mono text-right '+pc+'">'+(dp>=0?'+':'')+dp.toFixed(2)+'</td>' +
      '<td class="mono">'+(i.daily_wins||0)+' / '+(i.daily_losses||0)+'</td>' +
      '<td><div style="display:flex;gap:3px;flex-wrap:wrap">' +
        '<button class="btn" onclick="svcAction(\''+i.id+'\',\'start\')">Start</button>' +
        '<button class="btn" onclick="svcAction(\''+i.id+'\',\'restart\')">Restart</button>' +
        '<button class="btn btn-danger" onclick="svcAction(\''+i.id+'\',\'stop\')">Stop</button>' +
        '<button class="btn" onclick="togglePanel(\'perf\',\''+i.id+'\')">Perf</button>' +
        '<button class="btn" onclick="togglePanel(\'trades\',\''+i.id+'\')">Trades</button>' +
      '</div></td>' +
    '</tr>' +
    '<tr id="perf-row-'+i.id+'"><td colspan="8"><div class="expand-panel" id="perf-'+i.id+'"></div></td></tr>' +
    '<tr id="trades-row-'+i.id+'"><td colspan="8"><div class="expand-panel" id="trades-'+i.id+'"></div></td></tr>';
  }).join('');
}

function renderDashOff() {
  ['sum-pnl','sum-positions','sum-trades','sum-running','sum-errors'].forEach(function(id) {
    document.getElementById(id).textContent = '\u2014';
    document.getElementById(id).className = 'card-value mono';
  });
  document.getElementById('instances-body').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">VPS offline \u2014 cannot load trading data</td></tr>';
}

var openPanels = {};
async function togglePanel(type, id) {
  var key = type+'-'+id;
  var panel = document.getElementById(type+'-'+id);
  if (openPanels[key]) { panel.classList.remove('open'); delete openPanels[key]; return; }
  openPanels[key] = true;
  panel.innerHTML = 'Loading...';
  panel.classList.add('open');
  try {
    var ep = type === 'perf' ? 'performance' : 'trades';
    var r = await fetch('/api/vps/'+ep+'/'+id);
    var d = await r.json();
    if (d.error) throw new Error(d.message);
    if (type === 'perf') renderPerf(panel, d); else renderTrades(panel, d);
  } catch(e) { panel.innerHTML = '<span class="text-red">Error: '+esc(e.message)+'</span>'; }
}

function renderPerf(panel, d) {
  var l = d.live||{}, ex = d.expected||{}, c = d.comparison||{};
  function si(s) { return s==='ok'?'<span class="text-green">OK</span>':s==='warning'?'<span style="color:#eab308">WARN</span>':s==='alert'?'<span class="text-red">ALERT</span>':'<span class="text-dim">\u2014</span>'; }
  function row(lb,lv,ev,st) { return '<tr><td>'+lb+'</td><td class="mono" style="text-align:right">'+lv+'</td><td class="mono" style="text-align:right">'+ev+'</td><td style="text-align:right">'+si(st)+'</td></tr>'; }
  function pct(v) { return v!=null?(v*100).toFixed(1)+'%':'\u2014'; }
  panel.innerHTML = '<div style="font-weight:600;margin-bottom:8px;font-size:0.85rem">Performance vs Backtest</div>' +
    '<table><thead><tr><th>Metric</th><th style="text-align:right">Live</th><th style="text-align:right">Expected</th><th style="text-align:right">Status</th></tr></thead><tbody>' +
    row('Win Rate', pct(l.win_rate), pct(ex.win_rate), c.win_rate_status) +
    row('Profit Factor', num(l.profit_factor), num(ex.profit_factor), c.profit_factor_status) +
    row('Trades/Month', num(l.trades_per_month), num(ex.trades_per_month), c.trades_per_month_status) +
    row('Total Trades', l.trades||0, '\u2014', '') +
    row('Max DD%', pct(l.max_drawdown_pct), '\u2014', '') +
    row('Total P&L', num(l.total_pnl), '\u2014', '') +
    '</tbody></table>';
}

function renderTrades(panel, d) {
  var trades = d.trades || [];
  if (!trades.length) { panel.innerHTML = '<span class="text-dim">No trades yet</span>'; return; }
  panel.innerHTML = '<div style="font-weight:600;margin-bottom:8px;font-size:0.85rem">Recent Trades ('+trades.length+')</div>' +
    '<div style="overflow-x:auto"><table><thead><tr><th>Time</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Reason</th><th style="text-align:right">P&L</th></tr></thead><tbody>' +
    trades.map(function(t) {
      var pnl = t.realized_pnl||0;
      return '<tr><td class="mono">'+(t.exit_time||t.entry_time||'').replace('T',' ').substring(0,16)+'</td>' +
        '<td><span class="badge '+(t.direction==='BUY'?'badge-green':'badge-red')+'">'+t.direction+'</span></td>' +
        '<td class="mono">'+num(t.entry_price,5)+'</td><td class="mono">'+(t.exit_price?num(t.exit_price,5):'\u2014')+'</td>' +
        '<td>'+esc(t.exit_reason||'\u2014')+'</td>' +
        '<td class="mono text-right '+(pnl>=0?'text-green':'text-red')+'">'+(pnl>=0?'+':'')+pnl.toFixed(2)+'</td></tr>';
    }).join('') + '</tbody></table></div>';
}

async function svcAction(id, action) {
  if (!confirm(action.toUpperCase()+' service "'+id+'"?')) return;
  try {
    var r = await fetch('/api/vps/service/'+id+'/'+action, {method:'POST'});
    var d = await r.json();
    alert(d.message || (d.ok ? 'Done' : 'Failed'));
    fetchDash();
  } catch(e) { alert('Error: '+e.message); }
}

function startDash() { fetchDash(); if (dashTimer) clearInterval(dashTimer); dashTimer = setInterval(fetchDash, 15000); }
function stopDash() { if (dashTimer) { clearInterval(dashTimer); dashTimer = null; } }

// ═══════════════════════════════════════
// LEADERBOARD
// ═══════════════════════════════════════
async function loadLeaderboard() {
  try {
    var r = await fetch('/data/leaderboard.json');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var ct = r.headers.get('content-type') || '';
    if (ct.indexOf('json') === -1) throw new Error('leaderboard.json not found (run build_web.py to generate)');
    lbData = await r.json();
    lbLoaded = true;
    buildLB();
  } catch(e) {
    document.getElementById('lb-body').innerHTML = '<tr><td colspan="19" class="text-red" style="text-align:center;padding:2rem">Failed to load: '+esc(e.message)+'</td></tr>';
  }
}

function buildLB() {
  var runs = lbData.runs;
  var compare = lbData.compare || {};

  // Summary strip
  var total = runs.length;
  var green = runs.filter(function(r) { return r.rating === 'GREEN'; }).length;
  var yellow = runs.filter(function(r) { return r.rating === 'YELLOW' && r.score > 0; }).length;
  var red = runs.filter(function(r) { return r.status === 'COMPLETE' && r.score === 0; }).length;
  var failed = runs.filter(function(r) { return r.status === 'FAILED'; }).length;
  var partial = runs.filter(function(r) { return r.status === 'PARTIAL'; }).length;
  var best = runs.reduce(function(a, b) { return (a.score||0) > (b.score||0) ? a : b; }, {});
  var bestStr = best.score > 0 ? best.pair + ' ' + best.timeframe + ' - ' + best.score.toFixed(0) : 'None';

  document.getElementById('lb-subtitle').textContent = total + ' pipeline runs \u00B7 Data: ' + (lbData.generated_at || '');

  document.getElementById('lb-summary').innerHTML =
    '<div class="summary-item"><div class="summary-num">'+total+'</div><div class="summary-label">Total Runs</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#10b981">'+green+'</div><div class="summary-label">Green</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#f59e0b">'+yellow+'</div><div class="summary-label">Yellow</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#ef4444">'+(red+failed)+'</div><div class="summary-label">Red/Failed</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#5a6a80">'+partial+'</div><div class="summary-label">Partial</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#3b82f6">'+bestStr+'</div><div class="summary-label">Best Run</div></div>';

  // Filters
  var pairs = []; var tfs = [];
  runs.forEach(function(r) { if (pairs.indexOf(r.pair) === -1) pairs.push(r.pair); if (tfs.indexOf(r.timeframe) === -1) tfs.push(r.timeframe); });
  pairs.sort(); tfs.sort();

  var fbar = document.getElementById('lb-filters');
  fbar.innerHTML = '';

  function addFilterGroup(label, filterKey, values) {
    var g = document.createElement('div'); g.className = 'filter-group';
    g.innerHTML = '<span class="filter-label">'+label+'</span>';
    var allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active'; allBtn.textContent = 'All';
    allBtn.dataset.filter = filterKey; allBtn.dataset.value = 'ALL';
    g.appendChild(allBtn);
    values.forEach(function(v) {
      var b = document.createElement('button'); b.className = 'filter-btn';
      b.textContent = v; b.dataset.filter = filterKey; b.dataset.value = v;
      g.appendChild(b);
    });
    fbar.appendChild(g);
  }

  addFilterGroup('Pair', 'pair', pairs);
  addFilterGroup('TF', 'tf', tfs);
  addFilterGroup('Rating', 'rating', ['GREEN', 'YELLOW', 'RED']);
  addFilterGroup('Status', 'status', ['COMPLETE', 'PARTIAL', 'FAILED']);

  // Bind filter clicks
  fbar.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      btn.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      activeFilters[btn.dataset.filter] = btn.dataset.value;
      applyFilters();
    });
  });

  // Build rows
  var tbody = document.getElementById('lb-body');
  tbody.innerHTML = runs.map(function(r) {
    var ratingBg, ratingFg;
    if (r.rating === 'GREEN') { ratingBg = '#065f46'; ratingFg = '#10b981'; }
    else if (r.rating === 'YELLOW') { ratingBg = '#78350f'; ratingFg = '#f59e0b'; }
    else { ratingBg = '#7f1d1d'; ratingFg = '#ef4444'; }

    var statusHtml;
    if (r.status === 'FAILED') statusHtml = '<span style="color:#ef4444">FAILED</span>';
    else if (r.status === 'PARTIAL') statusHtml = '<span style="color:#5a6a80">'+r.stages_done+'/7</span>';
    else statusHtml = '<span style="color:#10b981">OK</span>';

    var scoreDisplay = r.score > 0 ? r.score.toFixed(0) : '-';
    var hasCompare = !!compare[r.run_id];
    var cbDisabled = hasCompare ? '' : ' disabled';
    var cbOpacity = hasCompare ? '' : ' style="opacity:0.3"';
    var descEsc = esc(r.description || '');
    var np = r.net_profit;
    var npColor = np > 0 ? '#10b981' : (np != null ? '#ef4444' : '#5a6a80');
    var npStr = np != null ? '$' + np.toLocaleString(undefined, {maximumFractionDigits:0}) : '-';
    var fb = r.forward_back_ratio;

    return '<tr data-pair="'+r.pair+'" data-tf="'+r.timeframe+'" data-strategy="'+r.strategy+'" data-status="'+r.status+'" data-rating="'+r.rating+'" data-run="'+r.run_id+'" onclick="showRunDetail(\''+r.run_id+'\')">' +
      '<td'+cbOpacity+' onclick="event.stopPropagation()"><input type="checkbox" class="compare-check" data-run="'+r.run_id+'"'+cbDisabled+'></td>' +
      '<td>'+esc(r.pair)+'</td>' +
      '<td>'+esc(r.timeframe)+'</td>' +
      '<td class="strategy-col">'+esc(r.strategy)+'</td>' +
      '<td class="desc-col" title="'+descEsc+'">'+descEsc+'</td>' +
      '<td class="score-col" style="color:'+ratingFg+'"><strong>'+scoreDisplay+'</strong></td>' +
      '<td><span style="background:'+ratingBg+';color:'+ratingFg+';padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">'+r.rating+'</span></td>' +
      '<td>'+statusHtml+'</td>' +
      '<td>'+(r.created||'').substring(0,19)+'</td>' +
      '<td style="color:'+npColor+'">'+npStr+'</td>' +
      '<td>'+(r.back_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.forward_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.back_trades||0)+'</td>' +
      '<td>'+(r.forward_trades||0)+'</td>' +
      '<td>'+(r.back_max_dd||0).toFixed(1)+'%</td>' +
      '<td>'+(fb||0).toFixed(2)+'</td>' +
      '<td>'+((r.win_rate||0)*100).toFixed(0)+'%</td>' +
      '<td>'+(r.total_time_min||0).toFixed(1)+'m</td>' +
      '<td class="runid-col"><a onclick="event.stopPropagation();showRunDetail(\''+r.run_id+'\')">'+esc(r.run_id)+'</a></td>' +
    '</tr>';
  }).join('');

  // Footer
  document.getElementById('lb-footer').textContent = 'OANDA Trading System \u00B7 ' + total + ' pipeline runs \u00B7 Generated ' + (lbData.generated_at || '');

  // Bind checkboxes
  document.querySelectorAll('.compare-check').forEach(function(cb) {
    cb.addEventListener('change', updateToolbar);
  });

  // Default sort by score descending
  var scoreHeader = document.querySelector('#leaderboard th[data-col="5"]');
  if (scoreHeader) scoreHeader.click();
}

// ── Sorting ──
var currentSort = { col: -1, dir: 'desc' };
document.querySelectorAll('#leaderboard th[data-col]').forEach(function(th) {
  th.addEventListener('click', function() {
    var col = parseInt(th.dataset.col);
    var dir = (currentSort.col === col && currentSort.dir === 'desc') ? 'asc' : 'desc';
    currentSort = { col: col, dir: dir };

    document.querySelectorAll('#leaderboard th').forEach(function(h) { h.classList.remove('sort-asc', 'sort-desc'); });
    th.classList.add('sort-' + dir);

    var tbody = document.querySelector('#leaderboard tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort(function(a, b) {
      var aText = a.cells[col] ? a.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';
      var bText = b.cells[col] ? b.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';

      if (/^\d{4}-\d{2}-\d{2}T/.test(aText) && /^\d{4}-\d{2}-\d{2}T/.test(bText)) {
        return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
      }

      var aNum = parseFloat(aText);
      var bNum = parseFloat(bText);
      if (!isNaN(aNum) && !isNaN(bNum)) return dir === 'asc' ? aNum - bNum : bNum - aNum;
      return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
    });

    rows.forEach(function(r) { tbody.appendChild(r); });
  });
});

// ── Filtering ──
var activeFilters = { pair: 'ALL', tf: 'ALL', rating: 'ALL', status: 'ALL' };

function applyFilters() {
  var rows = document.querySelectorAll('#leaderboard tbody tr');
  rows.forEach(function(row) {
    if (!row.dataset.pair) return;
    var show = true;
    if (activeFilters.pair !== 'ALL' && row.dataset.pair !== activeFilters.pair) show = false;
    if (activeFilters.tf !== 'ALL' && row.dataset.tf !== activeFilters.tf) show = false;
    if (activeFilters.rating !== 'ALL' && row.dataset.rating !== activeFilters.rating) show = false;
    if (activeFilters.status !== 'ALL' && row.dataset.status !== activeFilters.status) show = false;
    row.classList.toggle('hidden', !show);
  });
}

// ── Comparison ──
function updateToolbar() {
  var n = document.querySelectorAll('.compare-check:checked').length;
  document.getElementById('compare-count').textContent = n;
  document.getElementById('compare-toolbar').classList.toggle('visible', n >= 2);
}

function clearSelection() {
  document.querySelectorAll('.compare-check:checked').forEach(function(cb) { cb.checked = false; });
  updateToolbar();
}

function closeComparison() {
  document.getElementById('compare-section').classList.remove('visible');
}

function runComparison() {
  var checked = document.querySelectorAll('.compare-check:checked');
  var runIds = Array.from(checked).map(function(cb) { return cb.dataset.run; });
  if (runIds.length < 2) return;

  var section = document.getElementById('compare-section');
  section.classList.add('visible');

  var compare = lbData.compare || {};
  var allData = [];
  for (var i = 0; i < runIds.length && i < 6; i++) {
    var d = compare[runIds[i]];
    if (d) allData.push({ runId: runIds[i], data: d });
  }

  if (allData.length < 2) {
    document.getElementById('compare-chart').innerHTML = '<div style="text-align:center;padding:40px;color:#5a6a80">Not enough runs with equity data (need 2+).</div>';
    document.getElementById('compare-metrics').innerHTML = '';
    return;
  }

  buildEquityOverlay(document.getElementById('compare-chart'), allData);
  buildMetricsTable(document.getElementById('compare-metrics'), allData);
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function buildEquityOverlay(chartDiv, allData) {
  var traces = [], annotations = [], shapes = [];

  for (var i = 0; i < allData.length; i++) {
    var d = allData[i].data;
    var color = COLORS[i % COLORS.length];
    var meta = d.meta || {};
    var score = (d.decision || {}).score || 0;
    var backR2 = d.back_r_squared || 0;
    var fwdR2 = d.forward_r_squared || 0;
    var label = (meta.strategy || allData[i].runId) + ' (' + score.toFixed(0) + ')';
    var backEq = d.back_equity || [];
    var fwdEq = d.forward_equity || [];
    var initCap = d.initial_capital || 10000;

    if (backEq.length > 0) {
      var bx = backEq.map(function(p) { return p.timestamp; });
      var by = backEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: bx, y: by, type: 'scatter', mode: 'lines',
        name: label + ' Back R\u00B2=' + backR2.toFixed(3),
        line: { color: color, width: 2 }, legendgroup: 'run'+i,
      });
      if (fwdEq.length > 0) {
        shapes.push({ type:'line', x0:bx[bx.length-1], x1:bx[bx.length-1], y0:0, y1:1, yref:'paper', line:{color:color,width:1,dash:'dot'}, opacity:0.4 });
      }
    }

    if (fwdEq.length > 0) {
      var fx = fwdEq.map(function(p) { return p.timestamp; });
      var fy = fwdEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: fx, y: fy, type: 'scatter', mode: 'lines',
        name: label + ' Fwd R\u00B2=' + fwdR2.toFixed(3),
        line: { color: color, width: 2, dash: 'dash' }, legendgroup: 'run'+i,
      });
      annotations.push({
        x: fx[fx.length-1], y: fy[fy.length-1],
        text: 'R\u00B2=' + fwdR2.toFixed(3),
        showarrow: true, arrowhead: 0, arrowcolor: color,
        ax: 40, ay: -20 - (i * 18),
        font: { color: color, size: 11, family: 'JetBrains Mono, monospace' },
        bgcolor: 'rgba(10,14,26,0.8)', bordercolor: color, borderwidth: 1, borderpad: 3,
      });
    }
  }

  Plotly.newPlot(chartDiv, traces, mobileLayout({
    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
    font: { color: '#8896ab', family: 'Inter, system-ui, sans-serif', size: 12 },
    xaxis: { gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    yaxis: { title: 'Profit ($)', gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    margin: { l: 60, r: 30, t: 30, b: 50 },
    legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { size: 11 } },
    hoverlabel: { bgcolor: '#111827', bordercolor: '#2a3a52', font: { color: '#e2e8f0', size: 12 } },
    shapes: shapes, annotations: annotations,
  }), { responsive: true, displayModeBar: false });
}

function buildMetricsTable(container, allData) {
  var metrics = [
    { key: 'score', label: 'Score', fmt: function(v){return v.toFixed(1);}, higher: true },
    { key: 'back_return', label: 'Back Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'forward_return', label: 'Fwd Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'back_trades', label: 'Back Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'forward_trades', label: 'Fwd Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'win_rate', label: 'Win Rate', fmt: function(v){return (v*100).toFixed(1)+'%';}, higher: true },
    { key: 'profit_factor', label: 'Profit Factor', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_sharpe', label: 'Back Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'forward_sharpe', label: 'Fwd Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_r2', label: 'Back R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'forward_r2', label: 'Fwd R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'back_max_dd', label: 'Max DD %', fmt: function(v){return v.toFixed(1)+'%';}, higher: false },
    { key: 'stability', label: 'Stability %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
  ];

  var runMetrics = allData.map(function(item, idx) {
    var d = item.data; var meta = d.meta || {};
    return {
      label: (meta.strategy || item.runId) + ' (#' + (d.best_rank || '?') + ')',
      color: COLORS[idx % COLORS.length],
      score: (d.decision||{}).score || 0,
      back_return: d.back_return || 0, forward_return: d.forward_return || 0,
      back_trades: d.back_trades || 0, forward_trades: d.forward_trades || 0,
      win_rate: d.win_rate || 0, profit_factor: d.profit_factor || 0,
      back_sharpe: d.back_sharpe || 0, forward_sharpe: d.forward_sharpe || 0,
      back_r2: d.back_r_squared || 0, forward_r2: d.forward_r_squared || 0,
      back_max_dd: d.back_max_dd || 0, stability: (d.stability_mean || 0) * 100,
    };
  });

  var headerCells = '<th class="metric-label-col">Metric</th>';
  runMetrics.forEach(function(rm) { headerCells += '<th style="color:'+rm.color+'">'+rm.label+'</th>'; });

  var bodyRows = '';
  metrics.forEach(function(m) {
    var vals = runMetrics.map(function(rm) { return rm[m.key]; });
    var bestVal = m.higher ? Math.max.apply(null, vals) : Math.min.apply(null, vals);
    bodyRows += '<tr><td class="metric-label-col">' + m.label + '</td>';
    runMetrics.forEach(function(rm) {
      var v = rm[m.key];
      var cls = (v === bestVal && runMetrics.length > 1) ? ' class="best-val"' : '';
      bodyRows += '<td' + cls + '>' + m.fmt(v) + '</td>';
    });
    bodyRows += '</tr>';
  });

  container.innerHTML = '<table class="compare-metrics-table"><thead><tr>'+headerCells+'</tr></thead><tbody>'+bodyRows+'</tbody></table>';
}

// ── Run Detail (Enhanced) ──
var currentDetailRun = null;

// -- Formatters --
function rdN(v, d) { if (v == null || isNaN(v)) return '\u2014'; var n = Number(v).toFixed(d == null ? 2 : d); var p = n.split('.'); p[0] = p[0].replace(/\B(?=(\d{3})+(?!\d))/g, ','); return p.join('.'); }
function rdPct(v, d) { if (v == null || isNaN(v)) return '\u2014'; return rdN(v, d == null ? 1 : d) + '%'; }
function rdPctR(v, d) { if (v == null || isNaN(v)) return '\u2014'; return rdPct(v * 100, d); }
function rdDlr(v) { if (v == null || isNaN(v)) return '\u2014'; var s = Math.abs(v).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ','); return (v >= 0 ? '$' : '-$') + s; }
function rdSc(s) { if (s >= 70) return '#10b981'; if (s >= 40) return '#f59e0b'; return '#ef4444'; }
function rdRc(r) { if (r === 'GREEN' || r === 'STABLE') return ['#065f46','#10b981']; if (r === 'YELLOW' || r === 'MODERATE') return ['#78350f','#f59e0b']; return ['#7f1d1d','#ef4444']; }
function rdVc(v) { return v > 0 ? '#10b981' : v < 0 ? '#ef4444' : '#8896ab'; }

function rdSection(title, bodyHtml, collapsed) {
  return '<div class="rd-section' + (collapsed ? ' collapsed' : '') + '"><div class="rd-section-head" onclick="rdToggle(this.parentElement)"><h3>' + title + '</h3><span class="rd-chevron">\u25BC</span></div><div class="rd-section-body">' + bodyHtml + '</div></div>';
}

// -- Section: Header --
function rdHeader(run, det) {
  var rc = rdRc(run.rating);
  var rec = det && det.decision ? (det.decision.recommendation || '') : '';
  var cfg = det ? (det.config || {}) : {};
  var h = '<div class="rd-header" style="border-left:3px solid '+rc[1]+'">';
  h += '<div class="rd-title-row"><div><div class="rd-title">' + esc(run.pair) + ' ' + esc(run.timeframe) + ' \u2014 ' + esc(run.strategy) + '</div>';
  h += '<div class="rd-meta">' + esc(run.run_id) + ' \u00B7 ' + esc(run.description || '') + ' \u00B7 ' + (run.created || '').substring(0, 19) + '</div></div>';
  h += '<div class="rd-score-block"><div class="rd-score-big" style="color:'+rc[1]+'">' + (run.score > 0 ? run.score.toFixed(0) : '-') + '<span style="font-size:0.9rem;color:'+rc[1]+';background:'+rc[0]+';padding:2px 8px;border-radius:4px;margin-left:8px;vertical-align:middle">' + run.rating + '</span></div>';
  if (rec) h += '<div class="rd-recommendation">' + esc(rec) + '</div>';
  h += '</div></div>';
  if (cfg.data_years || cfg.train_months) {
    h += '<div class="rd-config-strip">';
    if (cfg.data_years) h += '<div class="rd-config-item">Data: <span>' + cfg.data_years + 'yr</span></div>';
    if (cfg.train_months) h += '<div class="rd-config-item">Train: <span>' + cfg.train_months + 'mo</span></div>';
    if (cfg.test_months) h += '<div class="rd-config-item">Test: <span>' + cfg.test_months + 'mo</span></div>';
    if (cfg.holdout_months) h += '<div class="rd-config-item">Holdout: <span>' + cfg.holdout_months + 'mo</span></div>';
    if (cfg.trials_per_stage) h += '<div class="rd-config-item">Trials: <span>' + cfg.trials_per_stage + '/' + (cfg.final_trials||'') + '</span></div>';
    if (cfg.spread_pips) h += '<div class="rd-config-item">Spread: <span>' + cfg.spread_pips + 'pip</span></div>';
    if (cfg.initial_capital) h += '<div class="rd-config-item">Capital: <span>' + rdDlr(cfg.initial_capital) + '</span></div>';
    h += '</div>';
  }
  h += '</div>';
  return h;
}

// -- Section: Performance --
function rdPerformance(run, det, comp) {
  var ext = det ? (det.extended || {}) : {};
  var c = comp || {};
  function row(label, bv, fv, color) {
    var bc = color ? ' style="color:' + (typeof color === 'function' ? color(bv) : color) + '"' : '';
    var fc = color ? ' style="color:' + (typeof color === 'function' ? color(fv) : color) + '"' : '';
    return '<tr><td>' + label + '</td><td' + bc + '>' + bv + '</td><td' + fc + '>' + fv + '</td></tr>';
  }
  var h = '<table class="rd-perf-table"><thead><tr><th>Metric</th><th>Backtest</th><th>Forward</th></tr></thead><tbody>';
  h += row('Quality Score', rdN(ext.back_quality_score, 1), rdN(ext.forward_quality_score, 1));
  h += row('Return %', rdPct(run.back_return, 1), rdPct(run.forward_return, 1), rdVc);
  h += row('Trades', run.back_trades || 0, run.forward_trades || 0);
  h += row('Win Rate', rdPctR(run.win_rate), rdPctR(ext.forward_win_rate));
  h += row('Profit Factor', rdN(c.back_profit_factor || c.profit_factor, 2), rdN(ext.forward_profit_factor, 2));
  h += row('Sharpe', rdN(run.back_sharpe, 2), rdN(run.forward_sharpe, 2));
  h += row('Sortino', rdN(ext.back_sortino, 2), rdN(ext.forward_sortino, 2));
  h += row('R\u00B2', rdN(c.back_r_squared, 3), rdN(ext.forward_r_squared || c.forward_r_squared, 3));
  h += row('Max DD %', rdPct(run.back_max_dd, 1), rdPct(ext.forward_max_dd, 1));
  h += row('Ulcer Index', rdN(ext.back_ulcer, 2), rdN(ext.forward_ulcer, 2));
  h += '</tbody></table>';
  var fb = ext.forward_back_ratio || run.forward_back_ratio || 0;
  var fbColor = fb >= 0.7 ? '#10b981' : fb >= 0.4 ? '#f59e0b' : '#ef4444';
  h += '<div class="rd-fb-banner"><div class="rd-fb-label">Forward / Back Ratio</div><div class="rd-fb-value" style="color:' + fbColor + '">' + rdPct(fb * 100, 1) + '</div></div>';
  if (det && det.recovery_factor != null) h += '<div style="text-align:center;margin-top:6px;font-size:0.72rem;color:#5a6a80">Recovery Factor: <span style="color:#8896ab;font-family:JetBrains Mono,monospace">' + rdN(det.recovery_factor, 2) + '</span></div>';
  return rdSection('Performance Overview', h);
}

// -- Section: Confidence --
function rdConfidence(det) {
  var c = det.confidence; if (!c || c.total_score == null) return '';
  var h = '<div class="rd-conf-total"><div class="score" style="color:' + rdSc(c.total_score) + '">' + rdN(c.total_score, 1) + ' <span style="font-size:0.7rem">/100</span></div><div class="label">Confidence Score \u2014 ' + (c.rating || '') + '</div></div>';
  var components = [
    ['BT Quality', c.backtest_quality_score, (c.weights||{}).backtest_quality],
    ['F/B Ratio', c.forward_back_score, (c.weights||{}).forward_back],
    ['Walk-Forward', c.walkforward_score, (c.weights||{}).walkforward],
    ['Stability', c.stability_score, (c.weights||{}).stability],
    ['Monte Carlo', c.montecarlo_score, (c.weights||{}).montecarlo],
    ['Quality Score', c.quality_score, (c.weights||{}).quality_score],
  ];
  components.forEach(function(r) {
    var score = r[1] != null ? r[1] : 0;
    var weight = r[2] != null ? r[2] : 0;
    h += '<div class="rd-conf-row"><div class="rd-conf-label">' + r[0] + '</div>';
    h += '<div class="rd-conf-bar-bg"><div class="rd-conf-bar-fill" style="width:' + Math.min(score, 100) + '%;background:' + rdSc(score) + '"></div></div>';
    h += '<div class="rd-conf-score" style="color:' + rdSc(score) + '">' + rdN(score, 0) + '</div>';
    h += '<div class="rd-conf-weight">' + (weight * 100).toFixed(0) + '%</div></div>';
  });
  return rdSection('Confidence Breakdown', h);
}

// -- Section: Walk-Forward --
function rdWalkforward(det) {
  var wf = det.walkforward; if (!wf) return '';
  var st = wf.stats || {};
  var wins = wf.windows || [];
  if (!wins.length) return '';
  var h = '<div class="rd-wf-summary"><strong style="color:#e2e8f0">' + (st.n_passed||0) + '/' + (st.n_windows||0) + '</strong> windows passed <span style="color:#5a6a80">(' + rdPctR(st.pass_rate) + ')</span>';
  if (st.oos_n_windows > 0) h += ' \u00B7 <span style="color:#3b82f6">' + st.oos_n_windows + ' OOS</span> (' + (st.oos_n_passed||0) + ' passed)';
  h += '</div>';
  h += '<div style="overflow-x:auto"><table class="rd-wf-table"><thead><tr><th>#</th><th>OOS</th><th>Trades</th><th>QScore</th><th>Sharpe</th><th>Sortino</th><th>Return%</th><th>MaxDD%</th><th>WinRate</th><th>PF</th><th>R\u00B2</th><th>Ulcer</th><th></th></tr></thead><tbody>';
  wins.forEach(function(w) {
    var cls = (w.passed ? 'wf-pass' : 'wf-fail') + (w.out_of_sample ? ' wf-oos' : '');
    var dotColor = w.passed ? '#22c55e' : '#ef4444';
    h += '<tr class="' + cls + '"><td>' + w.window + '</td>';
    h += '<td>' + (w.out_of_sample ? '<span style="color:#3b82f6;font-size:0.65rem">OOS</span>' : '') + '</td>';
    h += '<td>' + (w.trades || 0) + '</td>';
    h += '<td>' + rdN(w.quality_score, 1) + '</td>';
    h += '<td>' + rdN(w.sharpe, 2) + '</td>';
    h += '<td>' + rdN(w.sortino, 2) + '</td>';
    h += '<td style="color:' + rdVc(w['return']) + '">' + rdPct(w['return'], 1) + '</td>';
    h += '<td>' + rdPct(w.max_dd, 1) + '</td>';
    h += '<td>' + rdPctR(w.win_rate) + '</td>';
    h += '<td>' + rdN(w.profit_factor, 2) + '</td>';
    h += '<td>' + rdN(w.r_squared, 3) + '</td>';
    h += '<td>' + rdN(w.ulcer, 2) + '</td>';
    h += '<td><span class="rd-wf-dot" style="background:' + dotColor + ';box-shadow:0 0 4px ' + dotColor + '"></span></td></tr>';
  });
  h += '</tbody></table></div>';
  return rdSection('Walk-Forward Analysis', h);
}

// -- Section: Monte Carlo --
function rdMonteCarlo(det) {
  var mc = det.montecarlo; if (!mc || mc.status === 'unknown') return '';
  var h = '<div class="rd-mc-grid">';
  // Return Distribution
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Return Distribution (' + (mc.n_iterations||0) + ' sims)</div>';
  h += '<div class="rd-mc-row"><span class="lbl">Original</span><span class="val" style="color:#3b82f6">' + rdPct(mc.original_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Mean</span><span class="val">' + rdPct(mc.mean_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">5th pct</span><span class="val" style="color:#ef4444">' + rdPct(mc.pct_5_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">25th pct</span><span class="val">' + rdPct(mc.pct_25_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Median</span><span class="val">' + rdPct(mc.pct_50_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">75th pct</span><span class="val">' + rdPct(mc.pct_75_return, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">95th pct</span><span class="val" style="color:#10b981">' + rdPct(mc.pct_95_return, 1) + '</span></div>';
  h += '</div>';
  // Drawdown Distribution
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Drawdown Distribution</div>';
  h += '<div class="rd-mc-row"><span class="lbl">Original MaxDD</span><span class="val" style="color:#3b82f6">' + rdPct(mc.original_max_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Mean DD</span><span class="val">' + rdPct(mc.mean_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">5th pct DD</span><span class="val" style="color:#10b981">' + rdPct(mc.pct_5_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Median DD</span><span class="val">' + rdPct(mc.pct_50_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">95th pct DD</span><span class="val" style="color:#ef4444">' + rdPct(mc.pct_95_dd, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Worst DD</span><span class="val" style="color:#ef4444">' + rdPct(mc.max_dd, 1) + '</span></div>';
  h += '</div>';
  // Risk Metrics
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Risk Metrics</div>';
  h += '<div class="rd-mc-row"><span class="lbl">VaR 95%</span><span class="val">' + rdPct(mc.var_95, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">Exp. Shortfall</span><span class="val">' + rdPct(mc.expected_shortfall, 1) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(Positive)</span><span class="val" style="color:' + (mc.prob_positive >= 90 ? '#10b981' : mc.prob_positive >= 70 ? '#f59e0b' : '#ef4444') + '">' + rdPct(mc.prob_positive, 0) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(&gt;5%)</span><span class="val">' + rdPct(mc.prob_above_5pct, 0) + '</span></div>';
  h += '<div class="rd-mc-row"><span class="lbl">P(&gt;10%)</span><span class="val">' + rdPct(mc.prob_above_10pct, 0) + '</span></div>';
  h += '</div>';
  // Bootstrap CIs + Permutation
  h += '<div class="rd-mc-card"><div class="rd-mc-card-title">Bootstrap &amp; Permutation</div>';
  if (mc.bootstrap_sharpe_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">Sharpe CI</span><span class="val">[' + rdN(mc.bootstrap_sharpe_ci_lower, 2) + ', ' + rdN(mc.bootstrap_sharpe_ci_upper, 2) + ']</span></div>';
  }
  if (mc.bootstrap_wr_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">WinRate CI</span><span class="val">[' + rdPctR(mc.bootstrap_wr_ci_lower) + ', ' + rdPctR(mc.bootstrap_wr_ci_upper) + ']</span></div>';
  }
  if (mc.bootstrap_pf_ci_lower != null) {
    h += '<div class="rd-mc-row"><span class="lbl">PF CI</span><span class="val">[' + rdN(mc.bootstrap_pf_ci_lower, 2) + ', ' + rdN(mc.bootstrap_pf_ci_upper, 2) + ']</span></div>';
  }
  if (mc.perm_p_value != null) {
    var sigColor = mc.perm_significant_01 ? '#10b981' : mc.perm_significant_05 ? '#f59e0b' : '#ef4444';
    var sigLabel = mc.perm_significant_01 ? 'p<0.01' : mc.perm_significant_05 ? 'p<0.05' : 'Not sig.';
    h += '<div class="rd-mc-row"><span class="lbl">Perm. p-value</span><span class="val">' + rdN(mc.perm_p_value, 4) + '</span></div>';
    h += '<div class="rd-mc-row"><span class="lbl">Significance</span><span class="val" style="color:' + sigColor + '">' + sigLabel + '</span></div>';
  }
  if (mc.perm_original_sharpe != null) {
    h += '<div class="rd-mc-row"><span class="lbl">Orig. Sharpe</span><span class="val">' + rdN(mc.perm_original_sharpe, 3) + '</span></div>';
  }
  h += '</div></div>';
  return rdSection('Monte Carlo Simulation', h);
}

// -- Section: Stability --
function rdStability(det) {
  var s = det.stability; if (!s) return '';
  var rc = rdRc(s.rating);
  var h = '<div class="rd-stab-grid">';
  h += '<div class="rd-stab-card"><div class="val"><span style="background:'+rc[0]+';color:'+rc[1]+';padding:2px 10px;border-radius:4px;font-size:0.82rem">' + (s.rating||'?') + '</span></div><div class="lbl">Rating</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:' + rdSc(s.mean_stability * 100) + '">' + rdPctR(s.mean_stability) + '</div><div class="lbl">Mean Stability</div></div>';
  h += '<div class="rd-stab-card"><div class="val">' + rdPctR(s.min_stability) + '</div><div class="lbl">Min Stability</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:#10b981">' + (s.n_stable||0) + '</div><div class="lbl">Stable Params</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:' + (s.n_unstable > 0 ? '#ef4444' : '#5a6a80') + '">' + (s.n_unstable||0) + '</div><div class="lbl">Unstable</div></div>';
  h += '<div class="rd-stab-card"><div class="val" style="color:#5a6a80">' + (s.n_skipped||0) + '</div><div class="lbl">Skipped</div></div>';
  h += '</div>';
  return rdSection('Stability Analysis', h);
}

// -- Section: Trade Analysis --
function rdTrades(det) {
  var ts = det.trade_summary; if (!ts || !ts.total_trades) return '';
  var h = '<div class="rd-trade-grid">';
  h += '<div class="rd-trade-card"><div class="lbl">Total Trades</div><div class="val">' + (ts.total_trades||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Net Profit</div><div class="val" style="color:'+rdVc(ts.total_net_profit)+'">' + rdDlr(ts.total_net_profit) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Gross Profit</div><div class="val text-green">' + rdDlr(ts.gross_profit) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Gross Loss</div><div class="val text-red">' + rdDlr(ts.gross_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Win Rate</div><div class="val">' + rdPctR(ts.win_rate) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Profit Factor</div><div class="val">' + rdN(ts.profit_factor, 2) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Expected Payoff</div><div class="val" style="color:'+rdVc(ts.expected_payoff)+'">' + rdDlr(ts.expected_payoff) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Bars Held</div><div class="val">' + rdN(ts.avg_bars_held, 1) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Win</div><div class="val text-green">' + rdDlr(ts.avg_win) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg Loss</div><div class="val text-red">' + rdDlr(ts.avg_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Largest Win</div><div class="val text-green">' + rdDlr(ts.largest_win) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Largest Loss</div><div class="val text-red">' + rdDlr(ts.largest_loss) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Max Consec. Wins</div><div class="val">' + (ts.max_consecutive_wins||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Max Consec. Losses</div><div class="val">' + (ts.max_consecutive_losses||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Long / Short</div><div class="val">' + (ts.long_trades||0) + ' / ' + (ts.short_trades||0) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg MFE (R)</div><div class="val">' + rdN(ts.avg_mfe_r, 2) + '</div></div>';
  h += '<div class="rd-trade-card"><div class="lbl">Avg MAE (R)</div><div class="val">' + rdN(ts.avg_mae_r, 2) + '</div></div>';
  h += '</div>';
  // Exit reasons
  var er = ts.exit_reason_counts || {};
  var erKeys = Object.keys(er);
  if (erKeys.length > 0) {
    var maxCount = Math.max.apply(null, erKeys.map(function(k) { return er[k]; }));
    var erColors = { tp: '#10b981', sl: '#ef4444', trailing: '#3b82f6', time: '#8b5cf6', stale: '#f59e0b', break_even: '#06b6d4', force_close: '#ec4899' };
    h += '<div style="margin-top:8px;font-size:0.72rem;color:#5a6a80;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Exit Reasons</div>';
    h += '<table class="rd-exit-table">';
    erKeys.sort(function(a,b) { return er[b] - er[a]; }).forEach(function(k) {
      var pct = maxCount > 0 ? (er[k] / maxCount * 100) : 0;
      var color = erColors[k] || '#8896ab';
      h += '<tr><td>' + k.toUpperCase() + '</td><td>' + er[k] + '</td><td><span class="rd-exit-bar" style="width:' + pct + '%;background:' + color + '"></span></td></tr>';
    });
    h += '</table>';
  }
  return rdSection('Trade Analysis', h);
}

// -- Section: Monthly Returns --
function rdMonthly(det) {
  var m = det.monthly_returns; if (!m) return '';
  var years = Object.keys(m).sort();
  if (!years.length) return '';
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function cellColor(v) {
    if (v == null || v === 0) return 'background:#0d1320';
    var a = Math.min(Math.abs(v) / 8, 1);
    return v > 0 ? 'background:rgba(16,185,129,' + (0.1 + a * 0.5) + ')' : 'background:rgba(239,68,68,' + (0.1 + a * 0.5) + ')';
  }
  var h = '<div style="overflow-x:auto"><table class="rd-monthly-table"><thead><tr><th>Year</th>';
  months.forEach(function(mo) { h += '<th>' + mo + '</th>'; });
  h += '<th>Total</th></tr></thead><tbody>';
  years.forEach(function(yr) {
    var yd = m[yr] || {};
    var total = 0;
    h += '<tr><td>' + yr + '</td>';
    months.forEach(function(mo) {
      var v = yd[mo];
      if (v != null) total += v;
      var style = cellColor(v);
      var color = v > 0 ? '#10b981' : v < 0 ? '#ef4444' : '#5a6a80';
      h += '<td style="' + style + ';color:' + color + '">' + (v != null ? v.toFixed(1) : '') + '</td>';
    });
    h += '<td style="' + cellColor(total) + ';color:' + (total > 0 ? '#10b981' : '#ef4444') + ';font-weight:600">' + total.toFixed(1) + '</td></tr>';
  });
  h += '</tbody></table></div>';
  return rdSection('Monthly Returns (%)', h);
}

// -- Section: Parameters --
function rdParams(det) {
  var params = det.extended ? det.extended.params : null;
  if (!params) return '';
  var keys = Object.keys(params).sort();
  if (!keys.length) return '';
  var half = Math.ceil(keys.length / 2);
  function paramTable(ks) {
    var h = '<table class="rd-params-table">';
    ks.forEach(function(k) {
      var v = params[k];
      if (typeof v === 'boolean') v = v ? 'True' : 'False';
      else if (typeof v === 'number') v = Number.isInteger(v) ? v.toString() : v.toFixed(4);
      h += '<tr><td>' + k + '</td><td>' + v + '</td></tr>';
    });
    return h + '</table>';
  }
  var h = '<div class="rd-params-grid">' + paramTable(keys.slice(0, half)) + paramTable(keys.slice(half)) + '</div>';
  return rdSection('Best Candidate Parameters', h, true);
}

// -- Charts --
function rdRenderCharts(comp, det) {
  var chartArea = document.getElementById('rd-charts-area');
  if (!chartArea) return;
  // Equity chart
  var eqDiv = document.getElementById('rd-equity-chart');
  if (comp && (comp.back_equity || comp.forward_equity)) {
    var traces = [], shapes = [];
    var ic = comp.initial_capital || 10000;
    if (comp.back_equity && comp.back_equity.length) {
      traces.push({ x: comp.back_equity.map(function(p){return p.timestamp;}), y: comp.back_equity.map(function(p){return p.equity-ic;}), name: 'Backtest (R\u00B2=' + rdN(comp.back_r_squared,3) + ')', line:{color:'#3b82f6',width:2}, type:'scatter' });
      if (comp.forward_equity && comp.forward_equity.length) {
        var st = comp.back_equity[comp.back_equity.length-1].timestamp;
        shapes.push({type:'line',x0:st,x1:st,y0:0,y1:1,yref:'paper',line:{color:'#3b82f6',width:1,dash:'dot'},opacity:0.5});
      }
    }
    if (comp.forward_equity && comp.forward_equity.length) {
      traces.push({ x: comp.forward_equity.map(function(p){return p.timestamp;}), y: comp.forward_equity.map(function(p){return p.equity-ic;}), name: 'Forward (R\u00B2=' + rdN(comp.forward_r_squared,3) + ')', line:{color:'#10b981',width:2,dash:'dash'}, type:'scatter' });
    }
    var layout = { paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#8896ab',family:'Inter,system-ui,sans-serif',size:11}, xaxis:{gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, yaxis:{title:'Profit ($)',gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, margin:{l:55,r:20,t:15,b:40}, legend:{orientation:'h',y:-0.18,x:0.5,xanchor:'center',font:{size:10}}, hoverlabel:{bgcolor:'#111827',bordercolor:'#2a3a52',font:{color:'#e2e8f0',size:11}}, shapes:shapes };
    Plotly.newPlot(eqDiv, traces, mobileLayout(layout), {responsive:true,displayModeBar:false});
  } else {
    eqDiv.innerHTML = '<div style="text-align:center;padding:50px;color:#5a6a80">No equity data</div>';
  }
  // Drawdown chart
  var ddDiv = document.getElementById('rd-dd-chart');
  var ddCurve = det ? det.drawdown_curve : null;
  if (ddCurve && ddCurve.length > 0) {
    var dx = ddCurve.map(function(p){return p.timestamp||p.trade_num;});
    var dy = ddCurve.map(function(p){return -(p.drawdown||0);});
    Plotly.newPlot(ddDiv, [{x:dx,y:dy,type:'scatter',mode:'lines',fill:'tozeroy',fillcolor:'rgba(239,68,68,0.15)',line:{color:'#ef4444',width:1.5},name:'Drawdown %'}], mobileLayout({ paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#8896ab',family:'Inter,system-ui,sans-serif',size:11}, xaxis:{gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, yaxis:{title:'Drawdown %',gridcolor:'rgba(42,58,82,0.4)',zerolinecolor:'#2a3a52',tickfont:{color:'#5a6a80'}}, margin:{l:55,r:20,t:10,b:40}, showlegend:false, hoverlabel:{bgcolor:'#111827',bordercolor:'#2a3a52',font:{color:'#e2e8f0',size:11}} }), {responsive:true,displayModeBar:false});
  } else {
    ddDiv.innerHTML = '<div style="text-align:center;padding:30px;color:#5a6a80">No drawdown data</div>';
  }
}

// -- Main showRunDetail --
function showRunDetail(runId) {
  if (currentDetailRun === runId) { closeRunDetail(); return; }
  currentDetailRun = runId;
  var run = lbData.runs.find(function(r) { return r.run_id === runId; });
  var comp = (lbData.compare || {})[runId];
  var det = (lbData.detail || {})[runId];
  if (!run) return;

  var rc = rdRc(run.rating);
  var panel = document.getElementById('run-detail');
  panel.style.setProperty('--rd-accent', rc[1]);

  var html = '<div class="rd-inner">';
  // Close button - sticky top-right
  html += '<div class="rd-close-btn"><button onclick="closeRunDetail()">\u2715 Back to Leaderboard</button></div>';
  // Header
  html += rdHeader(run, det);
  // Charts section (top - the money shot)
  html += '<div class="rd-section"><div class="rd-section-head" onclick="rdToggle(this.parentElement)"><h3>Equity Curve &amp; Drawdown</h3><span class="rd-chevron">\u25BC</span></div><div class="rd-section-body" id="rd-charts-area">';
  html += '<div id="rd-equity-chart" style="height:420px"></div>';
  html += '<div id="rd-dd-chart" style="height:250px;margin-top:12px"></div>';
  html += '</div></div>';
  // Performance
  html += rdPerformance(run, det, comp);
  // Trade Analysis
  if (det) html += rdTrades(det);
  // Monthly Returns
  if (det) html += rdMonthly(det);
  // Walk-Forward
  if (det) html += rdWalkforward(det);
  // Confidence
  if (det) html += rdConfidence(det);
  // Stability
  if (det) html += rdStability(det);
  // Monte Carlo
  if (det) html += rdMonteCarlo(det);
  // Parameters
  if (det) html += rdParams(det);
  html += '</div>'; // close rd-inner

  panel.innerHTML = html;
  panel.classList.add('visible');
  document.body.classList.add('rd-open');

  // Render charts after DOM insertion
  setTimeout(function() { rdRenderCharts(comp, det); }, 50);
  panel.scrollTop = 0;
}

function closeRunDetail() {
  currentDetailRun = null;
  var panel = document.getElementById('run-detail');
  panel.classList.remove('visible');
  panel.innerHTML = '';
  document.body.classList.remove('rd-open');
}

function rdToggle(section) {
  section.classList.toggle('collapsed');
}

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
(function() {
  var hash = location.hash.replace('#', '') || 'dashboard';
  if (hash === 'leaderboard' || hash === 'pipeline') switchView('leaderboard');
  else switchView('dashboard');
})();
</script>
</body>
</html>
