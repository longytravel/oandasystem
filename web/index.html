<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OANDA Trading System</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0a0e1a;
    color: #e2e8f0;
    min-height: 100vh;
    line-height: 1.5;
    padding-bottom: 70px;
  }
  a { color: #3b82f6; text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* ── NAV ── */
  .nav {
    background: #111827;
    border-bottom: 1px solid #1e293b;
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center;
    padding: 0 32px; gap: 0;
  }
  .nav-brand {
    font-weight: 700; font-size: 1rem; color: #3b82f6;
    margin-right: 24px; white-space: nowrap; padding: 12px 0;
    font-family: 'JetBrains Mono', monospace;
  }
  .nav-tab {
    padding: 12px 20px; color: #5a6a80; cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s; font-size: 0.85rem; font-weight: 500; user-select: none;
  }
  .nav-tab:hover { color: #e2e8f0; }
  .nav-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
  .nav-right {
    margin-left: auto; display: flex; align-items: center; gap: 12px;
    font-size: 0.75rem; color: #5a6a80; font-family: 'JetBrains Mono', monospace;
  }

  /* ── VIEWS ── */
  .view { display: none; }
  .view.active { display: block; }

  /* ══════════════════════════════════════
     DASHBOARD VIEW
     ══════════════════════════════════════ */
  .dash-container { max-width: 1400px; margin: 0 auto; padding: 20px 32px; }
  .cards {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .card {
    background: #111827; border: 1px solid #1e293b; border-radius: 8px; padding: 16px;
  }
  .card-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em; color: #5a6a80; margin-bottom: 4px; }
  .card-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  .banner {
    padding: 10px 16px; border-radius: 6px; margin-bottom: 16px;
    font-size: 0.82rem; display: none;
    background: rgba(239,68,68,0.1); border: 1px solid #dc2626; color: #ef4444;
  }
  .banner.show { display: block; }

  .dash-table { overflow-x: auto; background: #111827; border: 1px solid #1e293b; border-radius: 8px; }
  .dash-table table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .dash-table th {
    text-align: left; padding: 10px 12px; font-size: 0.68rem;
    text-transform: uppercase; letter-spacing: 0.04em; color: #5a6a80;
    border-bottom: 1px solid #1e293b; background: #111827;
  }
  .dash-table td { padding: 8px 12px; border-bottom: 1px solid rgba(30,41,59,0.4); white-space: nowrap; }
  .dash-table tr:hover td { background: rgba(255,255,255,0.02); }

  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot-green { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
  .dot-yellow { background: #eab308; box-shadow: 0 0 6px #eab308; }
  .dot-red { background: #ef4444; box-shadow: 0 0 6px #ef4444; }

  .btn {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 4px; border: 1px solid #334155;
    background: #1e293b; color: #8896ab; font-size: 0.7rem;
    cursor: pointer; transition: all 0.15s; font-family: 'Inter', sans-serif;
  }
  .btn:hover { background: #334155; color: #e2e8f0; }
  .btn-danger { border-color: #dc2626; color: #ef4444; }
  .btn-danger:hover { background: rgba(239,68,68,0.15); }

  .expand-panel { display: none; padding: 16px; background: #0a0e1a; border-bottom: 1px solid #1e293b; }
  .expand-panel.open { display: block; }
  .expand-panel table { max-width: 600px; }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 0.75rem; font-weight: 600; font-family: 'JetBrains Mono', monospace;
  }
  .badge-green { background: #065f46; color: #10b981; }
  .badge-yellow { background: #78350f; color: #f59e0b; }
  .badge-red { background: #7f1d1d; color: #ef4444; }
  .badge-blue { background: rgba(59,130,246,0.15); color: #3b82f6; }

  /* ══════════════════════════════════════
     LEADERBOARD VIEW (matching generate_index.py)
     ══════════════════════════════════════ */
  .page-header {
    padding: 24px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 16px;
  }
  .page-title { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  .page-subtitle { font-size: 0.78rem; color: #5a6a80; }
  .summary-strip { display: flex; gap: 24px; flex-wrap: wrap; }
  .summary-item { text-align: center; }
  .summary-num { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; }
  .summary-label { font-size: 0.68rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.05em; }

  .filter-bar {
    padding: 12px 32px; border-bottom: 1px solid #1e293b;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: #0d1320;
  }
  .filter-group { display: flex; align-items: center; gap: 4px; }
  .filter-label { font-size: 0.7rem; color: #5a6a80; text-transform: uppercase; letter-spacing: 0.04em; margin-right: 4px; }
  .filter-btn {
    background: #111827; border: 1px solid #1e293b; color: #8896ab;
    padding: 4px 10px; border-radius: 4px; font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s;
  }
  .filter-btn:hover { border-color: #3b82f6; color: #e2e8f0; }
  .filter-btn.active { background: #1e3a5f; border-color: #3b82f6; color: #3b82f6; }
  .filter-btn.clear-btn { background: transparent; border-color: transparent; color: #5a6a80; font-family: 'Inter', sans-serif; }
  .filter-btn.clear-btn:hover { color: #ef4444; }

  .table-container { padding: 0 16px; overflow-x: auto; }
  #leaderboard { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 8px; }
  #leaderboard th {
    padding: 10px 10px; text-align: left; font-weight: 500; color: #5a6a80;
    text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.68rem;
    border-bottom: 1px solid #1e293b; cursor: pointer; user-select: none;
    white-space: nowrap; position: sticky; top: 47px; background: #0a0e1a; z-index: 10;
  }
  #leaderboard th:hover { color: #8896ab; }
  #leaderboard th.sort-asc::after { content: ' \25B2'; font-size: 0.6rem; }
  #leaderboard th.sort-desc::after { content: ' \25BC'; font-size: 0.6rem; }
  #leaderboard th.no-sort { cursor: default; }
  #leaderboard th.no-sort:hover { color: #5a6a80; }
  #leaderboard td {
    padding: 8px 10px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; white-space: nowrap;
  }
  #leaderboard tr:hover td { background: rgba(255,255,255,0.02); }
  #leaderboard tr.hidden { display: none; }
  .score-col { font-size: 1rem; }
  .strategy-col { font-family: 'Inter', sans-serif; color: #8896ab; font-size: 0.75rem; }
  .desc-col { font-family: 'Inter', sans-serif; color: #6b7f99; font-size: 0.7rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .runid-col { font-size: 0.68rem; color: #5a6a80; }
  .compare-check { width: 16px; height: 16px; cursor: pointer; accent-color: #3b82f6; }

  /* Compare toolbar */
  .compare-toolbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #111827; border-top: 2px solid #3b82f6;
    padding: 12px 32px; display: flex; align-items: center; gap: 16px;
    z-index: 1000; transform: translateY(100%); transition: transform 0.25s ease;
  }
  .compare-toolbar.visible { transform: translateY(0); }
  .compare-toolbar .count { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #3b82f6; font-weight: 600; }
  .compare-toolbar button {
    padding: 8px 20px; border-radius: 6px; font-family: 'Inter', sans-serif;
    font-size: 0.82rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s;
  }
  .compare-toolbar .btn-compare { background: #3b82f6; color: white; }
  .compare-toolbar .btn-compare:hover { background: #2563eb; }
  .compare-toolbar .btn-clear { background: transparent; color: #5a6a80; border: 1px solid #1e293b; }
  .compare-toolbar .btn-clear:hover { color: #ef4444; border-color: #ef4444; }

  /* Compare section */
  #compare-section { display: none; padding: 24px 32px; border-top: 2px solid #3b82f6; margin-top: 16px; }
  #compare-section.visible { display: block; }
  .compare-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .compare-title { font-size: 1.1rem; font-weight: 700; color: #3b82f6; }
  .compare-close {
    background: transparent; border: 1px solid #1e293b; color: #5a6a80;
    padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.78rem;
  }
  .compare-close:hover { color: #ef4444; border-color: #ef4444; }
  .compare-chart-panel { background: #111827; border: 1px solid #1e293b; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
  .compare-chart-header { padding: 12px 16px; border-bottom: 1px solid #1e293b; font-size: 0.82rem; font-weight: 600; color: #8896ab; }
  .compare-metrics-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .compare-metrics-table th {
    position: static; padding: 10px 14px; text-align: left; font-weight: 600;
    color: #5a6a80; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.04em;
    border-bottom: 1px solid #1e293b; background: #0d1320; cursor: default;
  }
  .compare-metrics-table th:hover { color: #5a6a80; }
  .compare-metrics-table td {
    padding: 8px 14px; border-bottom: 1px solid rgba(30,41,59,0.4);
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
  }
  .compare-metrics-table .metric-label-col { color: #8896ab; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 0.78rem; width: 140px; }
  .compare-metrics-table .best-val { color: #10b981; font-weight: 600; }

  .text-green { color: #10b981; }
  .text-red { color: #ef4444; }
  .text-dim { color: #5a6a80; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .text-right { text-align: right; }
  .footer { text-align: center; padding: 16px; color: #5a6a80; font-size: 0.7rem; border-top: 1px solid #1e293b; margin-top: 20px; }

  /* Run detail panel */
  .run-detail {
    display: none; margin: 16px 16px 0; padding: 24px;
    background: #111827; border: 1px solid #1e293b; border-radius: 8px;
  }
  .run-detail.visible { display: block; }
  .run-detail-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .run-detail-title { font-size: 1.1rem; font-weight: 700; }
  .run-detail-meta { font-size: 0.75rem; color: #5a6a80; margin-top: 4px; }
  .run-metrics-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 10px; margin-bottom: 20px;
  }
  .run-metric { background: #0d1320; border-radius: 6px; padding: 10px; }
  .run-metric-label { font-size: 0.65rem; text-transform: uppercase; color: #5a6a80; letter-spacing: 0.04em; }
  .run-metric-value { font-size: 1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  #leaderboard tr[data-run] { cursor: pointer; }
  .runid-col a { cursor: pointer; }
</style>
</head>
<body>

<!-- ═══ NAVIGATION ═══ -->
<nav class="nav">
  <div class="nav-brand">OANDA System</div>
  <div class="nav-tab active" data-view="dashboard" onclick="switchView('dashboard')">Trading</div>
  <div class="nav-tab" data-view="leaderboard" onclick="switchView('leaderboard')">Pipeline</div>
  <div class="nav-right"><span id="clock"></span></div>
</nav>

<!-- ═══ DASHBOARD VIEW ═══ -->
<div id="view-dashboard" class="view active">
  <div class="dash-container">
    <div id="vps-banner" class="banner">VPS Offline &mdash; Live trading data unavailable. The Pipeline tab still works.</div>
    <div class="cards">
      <div class="card"><div class="card-label">Daily P&amp;L</div><div class="card-value mono" id="sum-pnl">&mdash;</div></div>
      <div class="card"><div class="card-label">Open Positions</div><div class="card-value mono" id="sum-positions">&mdash;</div></div>
      <div class="card"><div class="card-label">Trades Today</div><div class="card-value mono" id="sum-trades">&mdash;</div></div>
      <div class="card"><div class="card-label">Running</div><div class="card-value mono" id="sum-running">&mdash;</div></div>
      <div class="card"><div class="card-label">Errors</div><div class="card-value mono" id="sum-errors">&mdash;</div></div>
    </div>
    <div class="dash-table">
      <table>
        <thead><tr>
          <th>Status</th><th>Strategy</th><th>Pair / TF</th><th>Heartbeat</th>
          <th>Positions</th><th style="text-align:right">Daily P&L</th><th>W / L</th><th>Actions</th>
        </tr></thead>
        <tbody id="instances-body">
          <tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ LEADERBOARD VIEW ═══ -->
<div id="view-leaderboard" class="view">
  <div class="page-header">
    <div>
      <div class="page-title">Pipeline Leaderboard</div>
      <div class="page-subtitle" id="lb-subtitle">Loading...</div>
    </div>
    <div class="summary-strip" id="lb-summary"></div>
  </div>
  <div class="filter-bar" id="lb-filters"></div>
  <div class="table-container">
    <table id="leaderboard">
      <thead><tr>
        <th class="no-sort" style="width:36px">&nbsp;</th>
        <th data-col="1">Pair</th>
        <th data-col="2">TF</th>
        <th data-col="3">Strategy</th>
        <th data-col="4">Description</th>
        <th data-col="5">Score</th>
        <th data-col="6">Rating</th>
        <th data-col="7">Status</th>
        <th data-col="8">Date</th>
        <th data-col="9">Profit</th>
        <th data-col="10">Back Sh</th>
        <th data-col="11">Fwd Sh</th>
        <th data-col="12">Back Tr</th>
        <th data-col="13">Fwd Tr</th>
        <th data-col="14">Max DD</th>
        <th data-col="15">F/B Ratio</th>
        <th data-col="16">Win %</th>
        <th data-col="17">Time</th>
        <th data-col="18">Run ID</th>
      </tr></thead>
      <tbody id="lb-body">
        <tr><td colspan="19" style="text-align:center;padding:2rem;color:#5a6a80">Loading leaderboard...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Comparison Section -->
  <div id="compare-section">
    <div class="compare-header">
      <div class="compare-title">Strategy Comparison</div>
      <button class="compare-close" onclick="closeComparison()">Close</button>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Equity Curves Overlay</div>
      <div id="compare-chart" style="height:450px"></div>
    </div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Metrics Comparison</div>
      <div id="compare-metrics" style="padding:0"></div>
    </div>
  </div>

  <!-- Run Detail Panel -->
  <div class="run-detail" id="run-detail">
    <div class="run-detail-header">
      <div>
        <div class="run-detail-title" id="rd-title"></div>
        <div class="run-detail-meta" id="rd-meta"></div>
      </div>
      <button class="compare-close" onclick="closeRunDetail()">Close</button>
    </div>
    <div class="run-metrics-grid" id="rd-metrics"></div>
    <div class="compare-chart-panel">
      <div class="compare-chart-header">Equity Curve</div>
      <div id="rd-chart" style="height:400px"></div>
    </div>
  </div>

  <div class="footer" id="lb-footer"></div>
</div>

<!-- Compare Toolbar -->
<div class="compare-toolbar" id="compare-toolbar">
  <span class="count"><span id="compare-count">0</span> selected</span>
  <button class="btn-compare" onclick="runComparison()">Compare</button>
  <button class="btn-clear" onclick="clearSelection()">Clear</button>
</div>

<script>
// ═══════════════════════════════════════
// GLOBALS
// ═══════════════════════════════════════
var COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
var currentView = 'dashboard';
var dashTimer = null;
var lbData = null;
var lbLoaded = false;

// ═══════════════════════════════════════
// VIEW SWITCH
// ═══════════════════════════════════════
function switchView(v) {
  currentView = v;
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.view === v); });
  document.querySelectorAll('.view').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('view-' + v).classList.add('active');
  if (v === 'dashboard') { startDash(); } else { stopDash(); if (!lbLoaded) loadLeaderboard(); }
  history.replaceState(null, '', '#' + v);
}

// Clock
function updateClock() {
  var d = new Date();
  document.getElementById('clock').textContent = d.toLocaleTimeString('en-US', {hour12:false});
}
setInterval(updateClock, 1000); updateClock();

// ═══════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════
function esc(s) { if (s == null) return ''; var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
function num(v, dec) { return v != null ? Number(v).toFixed(dec||2) : '\u2014'; }

async function fetchDash() {
  try {
    var r = await fetch('/api/vps/status');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var data = await r.json();
    if (data.error) throw new Error(data.message);
    document.getElementById('vps-banner').classList.remove('show');
    renderDash(data);
  } catch(e) {
    document.getElementById('vps-banner').classList.add('show');
    renderDashOff();
  }
}

function renderDash(data) {
  var s = data.summary || {};
  var pnl = s.daily_pnl || 0;
  var el = function(id, v) { document.getElementById(id).textContent = v; };
  var pnlEl = document.getElementById('sum-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
  pnlEl.className = 'card-value mono ' + (pnl >= 0 ? 'text-green' : 'text-red');
  el('sum-positions', s.open_positions || 0);
  el('sum-trades', s.total_trades || 0);
  el('sum-running', (s.running||0) + '/' + (s.total||0));
  var errEl = document.getElementById('sum-errors');
  errEl.textContent = s.errors || 0;
  errEl.className = 'card-value mono' + ((s.errors||0) > 0 ? ' text-red' : '');

  var insts = data.instances || [];
  var tbody = document.getElementById('instances-body');
  if (!insts.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">No trading instances configured</td></tr>'; return; }

  tbody.innerHTML = insts.map(function(i) {
    var dot = i.heartbeat_ok ? 'dot-green' : (i.status === 'error' ? 'dot-red' : 'dot-yellow');
    var lbl = i.heartbeat_ok ? 'Running' : (i.status === 'error' ? 'Error' : (i.service_status === 'SERVICE_STOPPED' ? 'Stopped' : 'Stale'));
    var dp = i.daily_pnl || 0;
    var pc = dp >= 0 ? 'text-green' : 'text-red';
    return '<tr>' +
      '<td><span class="dot '+dot+'"></span>'+lbl+'</td>' +
      '<td>'+esc(i.strategy)+'<br><span class="text-dim" style="font-size:0.7rem">'+esc(i.id||'')+'</span></td>' +
      '<td class="mono">'+esc(i.pair)+' '+esc(i.timeframe)+'</td>' +
      '<td>'+(i.heartbeat_display||'\u2014')+'</td>' +
      '<td class="mono">'+(i.positions||0)+'</td>' +
      '<td class="mono text-right '+pc+'">'+(dp>=0?'+':'')+dp.toFixed(2)+'</td>' +
      '<td class="mono">'+(i.daily_wins||0)+' / '+(i.daily_losses||0)+'</td>' +
      '<td><div style="display:flex;gap:3px;flex-wrap:wrap">' +
        '<button class="btn" onclick="svcAction(\''+i.id+'\',\'start\')">Start</button>' +
        '<button class="btn" onclick="svcAction(\''+i.id+'\',\'restart\')">Restart</button>' +
        '<button class="btn btn-danger" onclick="svcAction(\''+i.id+'\',\'stop\')">Stop</button>' +
        '<button class="btn" onclick="togglePanel(\'perf\',\''+i.id+'\')">Perf</button>' +
        '<button class="btn" onclick="togglePanel(\'trades\',\''+i.id+'\')">Trades</button>' +
      '</div></td>' +
    '</tr>' +
    '<tr id="perf-row-'+i.id+'"><td colspan="8"><div class="expand-panel" id="perf-'+i.id+'"></div></td></tr>' +
    '<tr id="trades-row-'+i.id+'"><td colspan="8"><div class="expand-panel" id="trades-'+i.id+'"></div></td></tr>';
  }).join('');
}

function renderDashOff() {
  ['sum-pnl','sum-positions','sum-trades','sum-running','sum-errors'].forEach(function(id) {
    document.getElementById(id).textContent = '\u2014';
    document.getElementById(id).className = 'card-value mono';
  });
  document.getElementById('instances-body').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#5a6a80">VPS offline \u2014 cannot load trading data</td></tr>';
}

var openPanels = {};
async function togglePanel(type, id) {
  var key = type+'-'+id;
  var panel = document.getElementById(type+'-'+id);
  if (openPanels[key]) { panel.classList.remove('open'); delete openPanels[key]; return; }
  openPanels[key] = true;
  panel.innerHTML = 'Loading...';
  panel.classList.add('open');
  try {
    var ep = type === 'perf' ? 'performance' : 'trades';
    var r = await fetch('/api/vps/'+ep+'/'+id);
    var d = await r.json();
    if (d.error) throw new Error(d.message);
    if (type === 'perf') renderPerf(panel, d); else renderTrades(panel, d);
  } catch(e) { panel.innerHTML = '<span class="text-red">Error: '+esc(e.message)+'</span>'; }
}

function renderPerf(panel, d) {
  var l = d.live||{}, ex = d.expected||{}, c = d.comparison||{};
  function si(s) { return s==='ok'?'<span class="text-green">OK</span>':s==='warning'?'<span style="color:#eab308">WARN</span>':s==='alert'?'<span class="text-red">ALERT</span>':'<span class="text-dim">\u2014</span>'; }
  function row(lb,lv,ev,st) { return '<tr><td>'+lb+'</td><td class="mono" style="text-align:right">'+lv+'</td><td class="mono" style="text-align:right">'+ev+'</td><td style="text-align:right">'+si(st)+'</td></tr>'; }
  function pct(v) { return v!=null?(v*100).toFixed(1)+'%':'\u2014'; }
  panel.innerHTML = '<div style="font-weight:600;margin-bottom:8px;font-size:0.85rem">Performance vs Backtest</div>' +
    '<table><thead><tr><th>Metric</th><th style="text-align:right">Live</th><th style="text-align:right">Expected</th><th style="text-align:right">Status</th></tr></thead><tbody>' +
    row('Win Rate', pct(l.win_rate), pct(ex.win_rate), c.win_rate_status) +
    row('Profit Factor', num(l.profit_factor), num(ex.profit_factor), c.profit_factor_status) +
    row('Trades/Month', num(l.trades_per_month), num(ex.trades_per_month), c.trades_per_month_status) +
    row('Total Trades', l.trades||0, '\u2014', '') +
    row('Max DD%', pct(l.max_drawdown_pct), '\u2014', '') +
    row('Total P&L', num(l.total_pnl), '\u2014', '') +
    '</tbody></table>';
}

function renderTrades(panel, d) {
  var trades = d.trades || [];
  if (!trades.length) { panel.innerHTML = '<span class="text-dim">No trades yet</span>'; return; }
  panel.innerHTML = '<div style="font-weight:600;margin-bottom:8px;font-size:0.85rem">Recent Trades ('+trades.length+')</div>' +
    '<div style="overflow-x:auto"><table><thead><tr><th>Time</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Reason</th><th style="text-align:right">P&L</th></tr></thead><tbody>' +
    trades.map(function(t) {
      var pnl = t.realized_pnl||0;
      return '<tr><td class="mono">'+(t.exit_time||t.entry_time||'').replace('T',' ').substring(0,16)+'</td>' +
        '<td><span class="badge '+(t.direction==='BUY'?'badge-green':'badge-red')+'">'+t.direction+'</span></td>' +
        '<td class="mono">'+num(t.entry_price,5)+'</td><td class="mono">'+(t.exit_price?num(t.exit_price,5):'\u2014')+'</td>' +
        '<td>'+esc(t.exit_reason||'\u2014')+'</td>' +
        '<td class="mono text-right '+(pnl>=0?'text-green':'text-red')+'">'+(pnl>=0?'+':'')+pnl.toFixed(2)+'</td></tr>';
    }).join('') + '</tbody></table></div>';
}

async function svcAction(id, action) {
  if (!confirm(action.toUpperCase()+' service "'+id+'"?')) return;
  try {
    var r = await fetch('/api/vps/service/'+id+'/'+action, {method:'POST'});
    var d = await r.json();
    alert(d.message || (d.ok ? 'Done' : 'Failed'));
    fetchDash();
  } catch(e) { alert('Error: '+e.message); }
}

function startDash() { fetchDash(); if (dashTimer) clearInterval(dashTimer); dashTimer = setInterval(fetchDash, 15000); }
function stopDash() { if (dashTimer) { clearInterval(dashTimer); dashTimer = null; } }

// ═══════════════════════════════════════
// LEADERBOARD
// ═══════════════════════════════════════
async function loadLeaderboard() {
  try {
    var r = await fetch('/data/leaderboard.json');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    lbData = await r.json();
    lbLoaded = true;
    buildLB();
  } catch(e) {
    document.getElementById('lb-body').innerHTML = '<tr><td colspan="19" class="text-red" style="text-align:center;padding:2rem">Failed to load: '+esc(e.message)+'</td></tr>';
  }
}

function buildLB() {
  var runs = lbData.runs;
  var compare = lbData.compare || {};

  // Summary strip
  var total = runs.length;
  var green = runs.filter(function(r) { return r.rating === 'GREEN'; }).length;
  var yellow = runs.filter(function(r) { return r.rating === 'YELLOW' && r.score > 0; }).length;
  var red = runs.filter(function(r) { return r.status === 'COMPLETE' && r.score === 0; }).length;
  var failed = runs.filter(function(r) { return r.status === 'FAILED'; }).length;
  var partial = runs.filter(function(r) { return r.status === 'PARTIAL'; }).length;
  var best = runs.reduce(function(a, b) { return (a.score||0) > (b.score||0) ? a : b; }, {});
  var bestStr = best.score > 0 ? best.pair + ' ' + best.timeframe + ' - ' + best.score.toFixed(0) : 'None';

  document.getElementById('lb-subtitle').textContent = total + ' pipeline runs \u00B7 Data: ' + (lbData.generated_at || '');

  document.getElementById('lb-summary').innerHTML =
    '<div class="summary-item"><div class="summary-num">'+total+'</div><div class="summary-label">Total Runs</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#10b981">'+green+'</div><div class="summary-label">Green</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#f59e0b">'+yellow+'</div><div class="summary-label">Yellow</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#ef4444">'+(red+failed)+'</div><div class="summary-label">Red/Failed</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#5a6a80">'+partial+'</div><div class="summary-label">Partial</div></div>' +
    '<div class="summary-item"><div class="summary-num" style="color:#3b82f6">'+bestStr+'</div><div class="summary-label">Best Run</div></div>';

  // Filters
  var pairs = []; var tfs = [];
  runs.forEach(function(r) { if (pairs.indexOf(r.pair) === -1) pairs.push(r.pair); if (tfs.indexOf(r.timeframe) === -1) tfs.push(r.timeframe); });
  pairs.sort(); tfs.sort();

  var fbar = document.getElementById('lb-filters');
  fbar.innerHTML = '';

  function addFilterGroup(label, filterKey, values) {
    var g = document.createElement('div'); g.className = 'filter-group';
    g.innerHTML = '<span class="filter-label">'+label+'</span>';
    var allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active'; allBtn.textContent = 'All';
    allBtn.dataset.filter = filterKey; allBtn.dataset.value = 'ALL';
    g.appendChild(allBtn);
    values.forEach(function(v) {
      var b = document.createElement('button'); b.className = 'filter-btn';
      b.textContent = v; b.dataset.filter = filterKey; b.dataset.value = v;
      g.appendChild(b);
    });
    fbar.appendChild(g);
  }

  addFilterGroup('Pair', 'pair', pairs);
  addFilterGroup('TF', 'tf', tfs);
  addFilterGroup('Rating', 'rating', ['GREEN', 'YELLOW', 'RED']);
  addFilterGroup('Status', 'status', ['COMPLETE', 'PARTIAL', 'FAILED']);

  // Bind filter clicks
  fbar.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      btn.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      activeFilters[btn.dataset.filter] = btn.dataset.value;
      applyFilters();
    });
  });

  // Build rows
  var tbody = document.getElementById('lb-body');
  tbody.innerHTML = runs.map(function(r) {
    var ratingBg, ratingFg;
    if (r.rating === 'GREEN') { ratingBg = '#065f46'; ratingFg = '#10b981'; }
    else if (r.rating === 'YELLOW') { ratingBg = '#78350f'; ratingFg = '#f59e0b'; }
    else { ratingBg = '#7f1d1d'; ratingFg = '#ef4444'; }

    var statusHtml;
    if (r.status === 'FAILED') statusHtml = '<span style="color:#ef4444">FAILED</span>';
    else if (r.status === 'PARTIAL') statusHtml = '<span style="color:#5a6a80">'+r.stages_done+'/7</span>';
    else statusHtml = '<span style="color:#10b981">OK</span>';

    var scoreDisplay = r.score > 0 ? r.score.toFixed(0) : '-';
    var hasCompare = !!compare[r.run_id];
    var cbDisabled = hasCompare ? '' : ' disabled';
    var cbOpacity = hasCompare ? '' : ' style="opacity:0.3"';
    var descEsc = esc(r.description || '');
    var np = r.net_profit;
    var npColor = np > 0 ? '#10b981' : (np != null ? '#ef4444' : '#5a6a80');
    var npStr = np != null ? '$' + np.toLocaleString(undefined, {maximumFractionDigits:0}) : '-';
    var fb = r.forward_back_ratio;

    return '<tr data-pair="'+r.pair+'" data-tf="'+r.timeframe+'" data-strategy="'+r.strategy+'" data-status="'+r.status+'" data-rating="'+r.rating+'" data-run="'+r.run_id+'" onclick="showRunDetail(\''+r.run_id+'\')">' +
      '<td'+cbOpacity+' onclick="event.stopPropagation()"><input type="checkbox" class="compare-check" data-run="'+r.run_id+'"'+cbDisabled+'></td>' +
      '<td>'+esc(r.pair)+'</td>' +
      '<td>'+esc(r.timeframe)+'</td>' +
      '<td class="strategy-col">'+esc(r.strategy)+'</td>' +
      '<td class="desc-col" title="'+descEsc+'">'+descEsc+'</td>' +
      '<td class="score-col" style="color:'+ratingFg+'"><strong>'+scoreDisplay+'</strong></td>' +
      '<td><span style="background:'+ratingBg+';color:'+ratingFg+';padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">'+r.rating+'</span></td>' +
      '<td>'+statusHtml+'</td>' +
      '<td>'+(r.created||'').substring(0,19)+'</td>' +
      '<td style="color:'+npColor+'">'+npStr+'</td>' +
      '<td>'+(r.back_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.forward_sharpe||0).toFixed(2)+'</td>' +
      '<td>'+(r.back_trades||0)+'</td>' +
      '<td>'+(r.forward_trades||0)+'</td>' +
      '<td>'+(r.back_max_dd||0).toFixed(1)+'%</td>' +
      '<td>'+(fb||0).toFixed(2)+'</td>' +
      '<td>'+((r.win_rate||0)*100).toFixed(0)+'%</td>' +
      '<td>'+(r.total_time_min||0).toFixed(1)+'m</td>' +
      '<td class="runid-col"><a onclick="event.stopPropagation();showRunDetail(\''+r.run_id+'\')">'+esc(r.run_id)+'</a></td>' +
    '</tr>';
  }).join('');

  // Footer
  document.getElementById('lb-footer').textContent = 'OANDA Trading System \u00B7 ' + total + ' pipeline runs \u00B7 Generated ' + (lbData.generated_at || '');

  // Bind checkboxes
  document.querySelectorAll('.compare-check').forEach(function(cb) {
    cb.addEventListener('change', updateToolbar);
  });

  // Default sort by score descending
  var scoreHeader = document.querySelector('#leaderboard th[data-col="5"]');
  if (scoreHeader) scoreHeader.click();
}

// ── Sorting ──
var currentSort = { col: -1, dir: 'desc' };
document.querySelectorAll('#leaderboard th[data-col]').forEach(function(th) {
  th.addEventListener('click', function() {
    var col = parseInt(th.dataset.col);
    var dir = (currentSort.col === col && currentSort.dir === 'desc') ? 'asc' : 'desc';
    currentSort = { col: col, dir: dir };

    document.querySelectorAll('#leaderboard th').forEach(function(h) { h.classList.remove('sort-asc', 'sort-desc'); });
    th.classList.add('sort-' + dir);

    var tbody = document.querySelector('#leaderboard tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort(function(a, b) {
      var aText = a.cells[col] ? a.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';
      var bText = b.cells[col] ? b.cells[col].textContent.replace(/[$,%m]/g, '').trim() : '';

      if (/^\d{4}-\d{2}-\d{2}T/.test(aText) && /^\d{4}-\d{2}-\d{2}T/.test(bText)) {
        return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
      }

      var aNum = parseFloat(aText);
      var bNum = parseFloat(bText);
      if (!isNaN(aNum) && !isNaN(bNum)) return dir === 'asc' ? aNum - bNum : bNum - aNum;
      return dir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
    });

    rows.forEach(function(r) { tbody.appendChild(r); });
  });
});

// ── Filtering ──
var activeFilters = { pair: 'ALL', tf: 'ALL', rating: 'ALL', status: 'ALL' };

function applyFilters() {
  var rows = document.querySelectorAll('#leaderboard tbody tr');
  rows.forEach(function(row) {
    if (!row.dataset.pair) return;
    var show = true;
    if (activeFilters.pair !== 'ALL' && row.dataset.pair !== activeFilters.pair) show = false;
    if (activeFilters.tf !== 'ALL' && row.dataset.tf !== activeFilters.tf) show = false;
    if (activeFilters.rating !== 'ALL' && row.dataset.rating !== activeFilters.rating) show = false;
    if (activeFilters.status !== 'ALL' && row.dataset.status !== activeFilters.status) show = false;
    row.classList.toggle('hidden', !show);
  });
}

// ── Comparison ──
function updateToolbar() {
  var n = document.querySelectorAll('.compare-check:checked').length;
  document.getElementById('compare-count').textContent = n;
  document.getElementById('compare-toolbar').classList.toggle('visible', n >= 2);
}

function clearSelection() {
  document.querySelectorAll('.compare-check:checked').forEach(function(cb) { cb.checked = false; });
  updateToolbar();
}

function closeComparison() {
  document.getElementById('compare-section').classList.remove('visible');
}

function runComparison() {
  var checked = document.querySelectorAll('.compare-check:checked');
  var runIds = Array.from(checked).map(function(cb) { return cb.dataset.run; });
  if (runIds.length < 2) return;

  var section = document.getElementById('compare-section');
  section.classList.add('visible');

  var compare = lbData.compare || {};
  var allData = [];
  for (var i = 0; i < runIds.length && i < 6; i++) {
    var d = compare[runIds[i]];
    if (d) allData.push({ runId: runIds[i], data: d });
  }

  if (allData.length < 2) {
    document.getElementById('compare-chart').innerHTML = '<div style="text-align:center;padding:40px;color:#5a6a80">Not enough runs with equity data (need 2+).</div>';
    document.getElementById('compare-metrics').innerHTML = '';
    return;
  }

  buildEquityOverlay(document.getElementById('compare-chart'), allData);
  buildMetricsTable(document.getElementById('compare-metrics'), allData);
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function buildEquityOverlay(chartDiv, allData) {
  var traces = [], annotations = [], shapes = [];

  for (var i = 0; i < allData.length; i++) {
    var d = allData[i].data;
    var color = COLORS[i % COLORS.length];
    var meta = d.meta || {};
    var score = (d.decision || {}).score || 0;
    var backR2 = d.back_r_squared || 0;
    var fwdR2 = d.forward_r_squared || 0;
    var label = (meta.strategy || allData[i].runId) + ' (' + score.toFixed(0) + ')';
    var backEq = d.back_equity || [];
    var fwdEq = d.forward_equity || [];
    var initCap = d.initial_capital || 10000;

    if (backEq.length > 0) {
      var bx = backEq.map(function(p) { return p.timestamp; });
      var by = backEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: bx, y: by, type: 'scatter', mode: 'lines',
        name: label + ' Back R\u00B2=' + backR2.toFixed(3),
        line: { color: color, width: 2 }, legendgroup: 'run'+i,
      });
      if (fwdEq.length > 0) {
        shapes.push({ type:'line', x0:bx[bx.length-1], x1:bx[bx.length-1], y0:0, y1:1, yref:'paper', line:{color:color,width:1,dash:'dot'}, opacity:0.4 });
      }
    }

    if (fwdEq.length > 0) {
      var fx = fwdEq.map(function(p) { return p.timestamp; });
      var fy = fwdEq.map(function(p) { return p.equity - initCap; });
      traces.push({
        x: fx, y: fy, type: 'scatter', mode: 'lines',
        name: label + ' Fwd R\u00B2=' + fwdR2.toFixed(3),
        line: { color: color, width: 2, dash: 'dash' }, legendgroup: 'run'+i,
      });
      annotations.push({
        x: fx[fx.length-1], y: fy[fy.length-1],
        text: 'R\u00B2=' + fwdR2.toFixed(3),
        showarrow: true, arrowhead: 0, arrowcolor: color,
        ax: 40, ay: -20 - (i * 18),
        font: { color: color, size: 11, family: 'JetBrains Mono, monospace' },
        bgcolor: 'rgba(10,14,26,0.8)', bordercolor: color, borderwidth: 1, borderpad: 3,
      });
    }
  }

  Plotly.newPlot(chartDiv, traces, {
    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
    font: { color: '#8896ab', family: 'Inter, system-ui, sans-serif', size: 12 },
    xaxis: { gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    yaxis: { title: 'Profit ($)', gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
    margin: { l: 60, r: 30, t: 30, b: 50 },
    legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { size: 11 } },
    hoverlabel: { bgcolor: '#111827', bordercolor: '#2a3a52', font: { color: '#e2e8f0', size: 12 } },
    shapes: shapes, annotations: annotations,
  }, { responsive: true, displayModeBar: false });
}

function buildMetricsTable(container, allData) {
  var metrics = [
    { key: 'score', label: 'Score', fmt: function(v){return v.toFixed(1);}, higher: true },
    { key: 'back_return', label: 'Back Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'forward_return', label: 'Fwd Return %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
    { key: 'back_trades', label: 'Back Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'forward_trades', label: 'Fwd Trades', fmt: function(v){return v.toFixed(0);}, higher: true },
    { key: 'win_rate', label: 'Win Rate', fmt: function(v){return (v*100).toFixed(1)+'%';}, higher: true },
    { key: 'profit_factor', label: 'Profit Factor', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_sharpe', label: 'Back Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'forward_sharpe', label: 'Fwd Sharpe', fmt: function(v){return v.toFixed(2);}, higher: true },
    { key: 'back_r2', label: 'Back R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'forward_r2', label: 'Fwd R\u00B2', fmt: function(v){return v.toFixed(3);}, higher: true },
    { key: 'back_max_dd', label: 'Max DD %', fmt: function(v){return v.toFixed(1)+'%';}, higher: false },
    { key: 'stability', label: 'Stability %', fmt: function(v){return v.toFixed(1)+'%';}, higher: true },
  ];

  var runMetrics = allData.map(function(item, idx) {
    var d = item.data; var meta = d.meta || {};
    return {
      label: (meta.strategy || item.runId) + ' (#' + (d.best_rank || '?') + ')',
      color: COLORS[idx % COLORS.length],
      score: (d.decision||{}).score || 0,
      back_return: d.back_return || 0, forward_return: d.forward_return || 0,
      back_trades: d.back_trades || 0, forward_trades: d.forward_trades || 0,
      win_rate: d.win_rate || 0, profit_factor: d.profit_factor || 0,
      back_sharpe: d.back_sharpe || 0, forward_sharpe: d.forward_sharpe || 0,
      back_r2: d.back_r_squared || 0, forward_r2: d.forward_r_squared || 0,
      back_max_dd: d.back_max_dd || 0, stability: (d.stability_mean || 0) * 100,
    };
  });

  var headerCells = '<th class="metric-label-col">Metric</th>';
  runMetrics.forEach(function(rm) { headerCells += '<th style="color:'+rm.color+'">'+rm.label+'</th>'; });

  var bodyRows = '';
  metrics.forEach(function(m) {
    var vals = runMetrics.map(function(rm) { return rm[m.key]; });
    var bestVal = m.higher ? Math.max.apply(null, vals) : Math.min.apply(null, vals);
    bodyRows += '<tr><td class="metric-label-col">' + m.label + '</td>';
    runMetrics.forEach(function(rm) {
      var v = rm[m.key];
      var cls = (v === bestVal && runMetrics.length > 1) ? ' class="best-val"' : '';
      bodyRows += '<td' + cls + '>' + m.fmt(v) + '</td>';
    });
    bodyRows += '</tr>';
  });

  container.innerHTML = '<table class="compare-metrics-table"><thead><tr>'+headerCells+'</tr></thead><tbody>'+bodyRows+'</tbody></table>';
}

// ── Run Detail ──
var currentDetailRun = null;
function showRunDetail(runId) {
  if (currentDetailRun === runId) { closeRunDetail(); return; }
  currentDetailRun = runId;
  var run = lbData.runs.find(function(r) { return r.run_id === runId; });
  var comp = (lbData.compare || {})[runId];
  if (!run) return;

  var panel = document.getElementById('run-detail');
  document.getElementById('rd-title').textContent = run.pair + ' ' + run.timeframe + ' \u2014 ' + run.strategy;
  document.getElementById('rd-meta').textContent = run.run_id + ' \u00B7 ' + (run.description || '') + ' \u00B7 ' + (run.created || '');

  var ratingBg = run.rating === 'GREEN' ? '#065f46' : run.rating === 'YELLOW' ? '#78350f' : '#7f1d1d';
  var ratingFg = run.rating === 'GREEN' ? '#10b981' : run.rating === 'YELLOW' ? '#f59e0b' : '#ef4444';
  var fb = run.forward_back_ratio;

  var metricsData = [
    ['Score', run.score > 0 ? run.score.toFixed(1) : '-', ratingFg],
    ['Rating', '<span style="background:'+ratingBg+';color:'+ratingFg+';padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">'+run.rating+'</span>', ''],
    ['Back Return', (run.back_return||0).toFixed(1) + '%', (run.back_return||0) > 0 ? '#10b981' : '#ef4444'],
    ['Fwd Return', (run.forward_return||0).toFixed(1) + '%', (run.forward_return||0) > 0 ? '#10b981' : '#ef4444'],
    ['F/B Ratio', fb ? (fb*100).toFixed(1) + '%' : '\u2014', ''],
    ['Back Trades', run.back_trades || 0, ''],
    ['Fwd Trades', run.forward_trades || 0, ''],
    ['Win Rate', ((run.win_rate||0)*100).toFixed(1) + '%', ''],
    ['Max DD', (run.back_max_dd||0).toFixed(1) + '%', ''],
    ['Back Sharpe', (run.back_sharpe||0).toFixed(2), ''],
    ['Fwd Sharpe', (run.forward_sharpe||0).toFixed(2), ''],
    ['Candidates', run.n_candidates || 0, ''],
  ];
  if (comp) {
    if (comp.back_r_squared) metricsData.push(['Back R\u00B2', comp.back_r_squared.toFixed(3), '']);
    if (comp.forward_r_squared) metricsData.push(['Fwd R\u00B2', comp.forward_r_squared.toFixed(3), '']);
    if (comp.profit_factor) metricsData.push(['Profit Factor', comp.profit_factor.toFixed(2), '']);
    if (comp.stability_mean) metricsData.push(['Stability', (comp.stability_mean*100).toFixed(1) + '%', '']);
  }

  document.getElementById('rd-metrics').innerHTML = metricsData.map(function(m) {
    var style = m[2] ? ' style="color:'+m[2]+'"' : '';
    return '<div class="run-metric"><div class="run-metric-label">'+m[0]+'</div><div class="run-metric-value"'+style+'>'+m[1]+'</div></div>';
  }).join('');

  // Chart
  var chartDiv = document.getElementById('rd-chart');
  if (comp && (comp.back_equity || comp.forward_equity)) {
    var traces = [];
    var initCap = comp.initial_capital || 10000;
    if (comp.back_equity && comp.back_equity.length) {
      traces.push({
        x: comp.back_equity.map(function(p) { return p.timestamp; }),
        y: comp.back_equity.map(function(p) { return p.equity - initCap; }),
        name: 'Backtest (R\u00B2=' + (comp.back_r_squared||0).toFixed(3) + ')',
        line: { color: '#3b82f6', width: 2 }, type: 'scatter'
      });
    }
    if (comp.forward_equity && comp.forward_equity.length) {
      traces.push({
        x: comp.forward_equity.map(function(p) { return p.timestamp; }),
        y: comp.forward_equity.map(function(p) { return p.equity - initCap; }),
        name: 'Forward (R\u00B2=' + (comp.forward_r_squared||0).toFixed(3) + ')',
        line: { color: '#10b981', width: 2, dash: 'dash' }, type: 'scatter'
      });
    }
    var shapes = [];
    if (comp.back_equity && comp.back_equity.length && comp.forward_equity && comp.forward_equity.length) {
      var splitTime = comp.back_equity[comp.back_equity.length-1].timestamp;
      shapes.push({ type:'line', x0:splitTime, x1:splitTime, y0:0, y1:1, yref:'paper', line:{color:'#3b82f6',width:1,dash:'dot'}, opacity:0.5 });
    }
    Plotly.newPlot(chartDiv, traces, {
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: '#8896ab', family: 'Inter, system-ui, sans-serif', size: 12 },
      xaxis: { gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
      yaxis: { title: 'Profit ($)', gridcolor: 'rgba(42,58,82,0.4)', zerolinecolor: '#2a3a52', tickfont: { color: '#5a6a80' } },
      margin: { l: 60, r: 30, t: 20, b: 50 },
      legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { size: 11 } },
      hoverlabel: { bgcolor: '#111827', bordercolor: '#2a3a52', font: { color: '#e2e8f0', size: 12 } },
      shapes: shapes,
    }, { responsive: true, displayModeBar: false });
  } else {
    chartDiv.innerHTML = '<div style="text-align:center;padding:60px;color:#5a6a80">No equity data available for this run</div>';
  }

  panel.classList.add('visible');
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeRunDetail() {
  currentDetailRun = null;
  document.getElementById('run-detail').classList.remove('visible');
}

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
(function() {
  var hash = location.hash.replace('#', '') || 'dashboard';
  if (hash === 'leaderboard' || hash === 'pipeline') switchView('leaderboard');
  else switchView('dashboard');
})();
</script>
</body>
</html>
